router.post('/zahlungen/:zahlungs_id/stornieren', (req, res) => {
  const { zahlungs_id } = req.params;
  const { grund } = req.body;

  // Erst Zahlungsdaten holen fÃ¼r Historie
  db.query('SELECT * FROM verbandsmitgliedschaft_zahlungen WHERE id = ?', [zahlungs_id], (err, rows) => {
    if (err || rows.length === 0) {
      return res.status(404).json({ error: 'Zahlung nicht gefunden' });
    }
    
    const zahlung = rows[0];
    const alterStatus = zahlung.status;
    
    db.query(`
      UPDATE verbandsmitgliedschaft_zahlungen
      SET status = 'offen', bezahlt_am = NULL
      WHERE id = ?
    `, [zahlungs_id], (err, result) => {
      if (err) {
        console.error('Fehler:', err);
        return res.status(500).json({ error: 'Datenbankfehler' });
      }

      // Historie-Eintrag mit Callback
      const beschreibung = 'Zahlung ' + zahlung.rechnungsnummer + ' storniert (vorher: ' + alterStatus + ')' + (grund ? ' - ' + grund : '');
      db.query(`
        INSERT INTO verband_vertragshistorie (verbandsmitgliedschaft_id, aktion, beschreibung, ip_adresse)
        VALUES (?, 'zahlung', ?, ?)
      `, [zahlung.verbandsmitgliedschaft_id, beschreibung, req.ip], (histErr, histResult) => {
        if (histErr) {
          console.error('Historie-Fehler:', histErr);
        } else {
          console.log('Historie-Eintrag erstellt:', histResult.insertId);
        }
        res.json({ success: true, message: 'Zahlung storniert' });
      });
    });
  });
});
