import{a as e,j as s}from"./query-Caj74EYQ.js";import{b as a,a as n}from"./index-BuAcXaay.js";import{T as l,R as t,u as i,N as r,K as c,o as d,aO as o,a7 as h,g as m,q as j,a9 as u,M as x,_ as g,j as p,k as b,t as z}from"./icons-eh0tbLFx.js";import"./vendor-router-B2AaIOtG.js";import"./charts-QHQg_ypW.js";const N=()=>{const{token:N}=a(),[f,v]=e.useState(!0),[k,y]=e.useState([]),[w,C]=e.useState({}),[S,D]=e.useState([]),[_,E]=e.useState([]),[L,$]=e.useState({status:"offen",typ:"",search:""}),[F,R]=e.useState("zahlungen"),[A,M]=e.useState(null),[B,U]=e.useState(!1);e.useEffect(()=>{Z()},[L.status,L.typ]);const Z=async()=>{v(!0);try{const e=new URLSearchParams;L.status&&e.append("status",L.status),L.typ&&e.append("typ",L.typ);const[s,a,l]=await Promise.all([n.get(`/admin/offene-zahlungen?${e}`,{headers:{Authorization:`Bearer ${N}`}}),n.get("/admin/stripe/disputes",{headers:{Authorization:`Bearer ${N}`}}).catch(()=>({data:{disputes:[]}})),n.get("/admin/mitglieder-mit-zahlungsproblemen",{headers:{Authorization:`Bearer ${N}`}}).catch(()=>({data:{mitglieder:[]}}))]);s.data.success&&(y(s.data.zahlungen||[]),C(s.data.stats||{})),D(a.data.disputes||[]),E(l.data.mitglieder||[])}catch(e){console.error("Fehler beim Laden:",e)}finally{v(!1)}},O=async(e,s)=>{try{await n.put(`/admin/offene-zahlungen/${e}`,{status:s},{headers:{Authorization:`Bearer ${N}`}}),Z()}catch(a){console.error("Fehler:",a),alert("Fehler beim Aktualisieren")}},P=async e=>{try{await n.post(`/admin/offene-zahlungen/${e}/mahnung`,{},{headers:{Authorization:`Bearer ${N}`}}),alert("Mahnung vermerkt"),Z()}catch(s){console.error("Fehler:",s)}},K=e=>{const a={ruecklastschrift:{label:"Rücklastschrift",color:"#ef4444",icon:r},chargeback:{label:"Chargeback",color:"#f59e0b",icon:c},fehlgeschlagen:{label:"Fehlgeschlagen",color:"#6366f1",icon:z},mahnung:{label:"Mahnung",color:"#8b5cf6",icon:x},sonstig:{label:"Sonstig",color:"#64748b",icon:b}},n=a[e]||a.sonstig,l=n.icon;return s.jsxs("span",{className:"typ-badge",style:{backgroundColor:`${n.color}20`,color:n.color,borderColor:n.color},children:[s.jsx(l,{size:12}),n.label]})},T=e=>{const a={offen:{label:"Offen",color:"#ef4444"},in_bearbeitung:{label:"In Bearbeitung",color:"#f59e0b"},erledigt:{label:"Erledigt",color:"#22c55e"},storniert:{label:"Storniert",color:"#64748b"}},n=a[e]||a.offen;return s.jsx("span",{className:"status-badge",style:{backgroundColor:`${n.color}20`,color:n.color},children:n.label})},q=k.filter(e=>{if(L.search){const s=L.search.toLowerCase(),a=`${e.vorname||""} ${e.nachname||""}`.toLowerCase(),n=(e.referenz||"").toLowerCase();if(!a.includes(s)&&!n.includes(s))return!1}return!0});return s.jsxs("div",{className:"offene-zahlungen",children:[s.jsxs("div",{className:"oz-header",children:[s.jsxs("div",{className:"oz-header-info",children:[s.jsxs("h1",{children:[s.jsx(l,{size:28}),"Offene Zahlungen & Rücklastschriften"]}),s.jsx("p",{children:"Verwalten Sie fehlgeschlagene Zahlungen, Chargebacks und Rücklastschriften"})]}),s.jsxs("button",{onClick:Z,className:"btn-refresh",disabled:f,children:[s.jsx(t,{size:16,className:f?"spin":""}),"Aktualisieren"]})]}),s.jsxs("div",{className:"oz-stats",children:[s.jsxs("div",{className:"stat-card warning",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(l,{size:24})}),s.jsxs("div",{className:"stat-content",children:[s.jsx("span",{className:"stat-value",children:w.offen||0}),s.jsx("span",{className:"stat-label",children:"Offen"})]})]}),s.jsxs("div",{className:"stat-card danger",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(i,{size:24})}),s.jsxs("div",{className:"stat-content",children:[s.jsx("span",{className:"stat-value",children:parseFloat(w.summe_offen||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"})}),s.jsx("span",{className:"stat-label",children:"Offener Betrag"})]})]}),s.jsxs("div",{className:"stat-card info",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(r,{size:24})}),s.jsxs("div",{className:"stat-content",children:[s.jsx("span",{className:"stat-value",children:w.ruecklastschriften||0}),s.jsx("span",{className:"stat-label",children:"Rücklastschriften"})]})]}),s.jsxs("div",{className:"stat-card purple",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(c,{size:24})}),s.jsxs("div",{className:"stat-content",children:[s.jsx("span",{className:"stat-value",children:w.chargebacks||0}),s.jsx("span",{className:"stat-label",children:"Chargebacks"})]})]})]}),s.jsxs("div",{className:"oz-tabs",children:[s.jsxs("button",{className:"oz-tab "+("zahlungen"===F?"active":""),onClick:()=>R("zahlungen"),children:[s.jsx(l,{size:16}),"Offene Zahlungen",w.offen>0&&s.jsx("span",{className:"tab-count",children:w.offen})]}),s.jsxs("button",{className:"oz-tab "+("disputes"===F?"active":""),onClick:()=>R("disputes"),children:[s.jsx(c,{size:16}),"Stripe Disputes",S.filter(e=>"won"!==e.status&&"lost"!==e.status).length>0&&s.jsx("span",{className:"tab-count",children:S.filter(e=>"won"!==e.status&&"lost"!==e.status).length})]}),s.jsxs("button",{className:"oz-tab "+("mitglieder"===F?"active":""),onClick:()=>R("mitglieder"),children:[s.jsx(d,{size:16}),"Problem-Mitglieder",_.length>0&&s.jsx("span",{className:"tab-count",children:_.length})]})]}),s.jsxs("div",{className:"oz-content",children:["zahlungen"===F&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"oz-filter-bar",children:[s.jsxs("div",{className:"filter-group",children:[s.jsx(o,{size:16}),s.jsxs("select",{value:L.status,onChange:e=>$({...L,status:e.target.value}),children:[s.jsx("option",{value:"offen",children:"Offen"}),s.jsx("option",{value:"in_bearbeitung",children:"In Bearbeitung"}),s.jsx("option",{value:"erledigt",children:"Erledigt"}),s.jsx("option",{value:"alle",children:"Alle"})]})]}),s.jsx("div",{className:"filter-group",children:s.jsxs("select",{value:L.typ,onChange:e=>$({...L,typ:e.target.value}),children:[s.jsx("option",{value:"",children:"Alle Typen"}),s.jsx("option",{value:"ruecklastschrift",children:"Rücklastschriften"}),s.jsx("option",{value:"chargeback",children:"Chargebacks"}),s.jsx("option",{value:"fehlgeschlagen",children:"Fehlgeschlagen"})]})}),s.jsxs("div",{className:"filter-group search",children:[s.jsx(h,{size:16}),s.jsx("input",{type:"text",placeholder:"Name oder Referenz suchen...",value:L.search,onChange:e=>$({...L,search:e.target.value})})]})]}),s.jsx("div",{className:"oz-list",children:f?s.jsxs("div",{className:"oz-loading",children:[s.jsx(t,{size:32,className:"spin"}),s.jsx("p",{children:"Lade Daten..."})]}):0===q.length?s.jsxs("div",{className:"oz-empty",children:[s.jsx(m,{size:48}),s.jsx("h3",{children:"Keine offenen Zahlungen"}),s.jsxs("p",{children:["Aktuell gibt es keine ","offen"===L.status?"offenen":""," Zahlungsprobleme."]})]}):q.map(e=>s.jsxs("div",{className:`oz-item ${e.status}`,children:[s.jsxs("div",{className:"oz-item-main",children:[s.jsxs("div",{className:"oz-item-member",children:[s.jsxs("strong",{children:[e.vorname," ",e.nachname]}),s.jsx("span",{className:"oz-item-email",children:e.email}),e.dojoname&&s.jsx("span",{className:"oz-item-dojo",children:e.dojoname})]}),s.jsxs("div",{className:"oz-item-details",children:[K(e.typ),T(e.status)]}),s.jsxs("div",{className:"oz-item-amount",children:[s.jsx("strong",{children:parseFloat(e.betrag).toLocaleString("de-DE",{style:"currency",currency:"EUR"})}),s.jsxs("span",{className:"oz-item-date",children:[s.jsx(j,{size:12}),new Date(e.erstellt_am).toLocaleDateString("de-DE")]})]}),s.jsxs("div",{className:"oz-item-actions",children:["offen"===e.status&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"btn-action success",onClick:()=>O(e.id,"erledigt"),title:"Als erledigt markieren",children:s.jsx(u,{size:16})}),s.jsx("button",{className:"btn-action warning",onClick:()=>P(e.id),title:"Mahnung senden",children:s.jsx(x,{size:16})}),s.jsx("button",{className:"btn-action danger",onClick:()=>O(e.id,"storniert"),title:"Stornieren",children:s.jsx(g,{size:16})})]}),s.jsx("button",{className:"btn-action info",onClick:()=>{M(e),U(!0)},title:"Details anzeigen",children:s.jsx(p,{size:16})})]})]}),e.beschreibung&&s.jsx("div",{className:"oz-item-description",children:e.beschreibung}),e.mahnungen_gesendet>0&&s.jsxs("div",{className:"oz-item-mahnungen",children:[s.jsx(x,{size:12}),e.mahnungen_gesendet," Mahnung(en) gesendet",e.letzte_mahnung&&` - Letzte: ${new Date(e.letzte_mahnung).toLocaleDateString("de-DE")}`]})]},e.id))})]}),"disputes"===F&&s.jsx("div",{className:"oz-list",children:0===S.length?s.jsxs("div",{className:"oz-empty",children:[s.jsx(m,{size:48}),s.jsx("h3",{children:"Keine Stripe Disputes"}),s.jsx("p",{children:"Es gibt keine aktiven Chargebacks."})]}):S.map(e=>s.jsx("div",{className:`oz-item dispute ${e.status}`,children:s.jsxs("div",{className:"oz-item-main",children:[s.jsxs("div",{className:"oz-item-member",children:[s.jsxs("strong",{children:[e.vorname||"Unbekannt"," ",e.nachname||""]}),s.jsx("span",{className:"dispute-id",children:e.stripe_dispute_id})]}),s.jsxs("div",{className:"oz-item-details",children:[s.jsx("span",{className:"reason-badge",children:e.reason||"Unbekannt"}),s.jsx("span",{className:`status-badge ${e.status}`,children:"won"===e.status?"Gewonnen":"lost"===e.status?"Verloren":"needs_response"===e.status?"Antwort nötig":e.status})]}),s.jsxs("div",{className:"oz-item-amount",children:[s.jsx("strong",{children:(e.amount/100).toLocaleString("de-DE",{style:"currency",currency:"EUR"})}),e.evidence_due_by&&s.jsxs("span",{className:"due-date",children:[s.jsx(l,{size:12}),"Frist: ",new Date(e.evidence_due_by).toLocaleDateString("de-DE")]})]})]})},e.id))}),"mitglieder"===F&&s.jsx("div",{className:"oz-list",children:0===_.length?s.jsxs("div",{className:"oz-empty",children:[s.jsx(m,{size:48}),s.jsx("h3",{children:"Keine Problem-Mitglieder"}),s.jsx("p",{children:"Es gibt keine Mitglieder mit Zahlungsproblemen."})]}):_.map(e=>s.jsxs("div",{className:"oz-item mitglied",children:[s.jsxs("div",{className:"oz-item-main",children:[s.jsxs("div",{className:"oz-item-member",children:[s.jsxs("strong",{children:[e.vorname," ",e.nachname]}),s.jsx("span",{className:"oz-item-email",children:e.email}),e.dojoname&&s.jsx("span",{className:"oz-item-dojo",children:e.dojoname})]}),s.jsxs("div",{className:"oz-item-details",children:[s.jsxs("span",{className:"problem-badge",children:[s.jsx(l,{size:12}),"Zahlungsproblem"]}),e.zahlungsproblem_datum&&s.jsxs("span",{className:"problem-date",children:["seit ",new Date(e.zahlungsproblem_datum).toLocaleDateString("de-DE")]})]}),s.jsxs("div",{className:"oz-item-amount",children:[s.jsxs("strong",{children:[e.offene_zahlungen||0," offen"]}),s.jsx("span",{children:parseFloat(e.summe_offen||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"})})]})]}),e.zahlungsproblem_details&&s.jsx("div",{className:"oz-item-description",children:e.zahlungsproblem_details})]},e.mitglied_id))})]}),B&&A&&s.jsx("div",{className:"oz-modal-overlay",onClick:()=>U(!1),children:s.jsxs("div",{className:"oz-modal",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"oz-modal-header",children:[s.jsx("h3",{children:"Zahlungsdetails"}),s.jsx("button",{onClick:()=>U(!1),children:s.jsx(g,{size:20})})]}),s.jsxs("div",{className:"oz-modal-content",children:[s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Mitglied:"}),s.jsxs("strong",{children:[A.vorname," ",A.nachname]})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"E-Mail:"}),s.jsx("span",{children:A.email})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Dojo:"}),s.jsx("span",{children:A.dojoname})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Betrag:"}),s.jsx("strong",{className:"amount",children:parseFloat(A.betrag).toLocaleString("de-DE",{style:"currency",currency:"EUR"})})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Typ:"}),K(A.typ)]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Status:"}),T(A.status)]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Erstellt:"}),s.jsx("span",{children:new Date(A.erstellt_am).toLocaleString("de-DE")})]}),A.referenz&&s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{children:"Referenz:"}),s.jsx("code",{children:A.referenz})]}),A.beschreibung&&s.jsxs("div",{className:"detail-row full",children:[s.jsx("span",{children:"Beschreibung:"}),s.jsx("p",{children:A.beschreibung})]}),A.notizen&&s.jsxs("div",{className:"detail-row full",children:[s.jsx("span",{children:"Notizen:"}),s.jsx("p",{children:A.notizen})]})]}),s.jsxs("div",{className:"oz-modal-footer",children:["offen"===A.status&&s.jsxs(s.Fragment,{children:[s.jsxs("button",{className:"btn success",onClick:()=>{O(A.id,"erledigt"),U(!1)},children:[s.jsx(u,{size:16})," Als erledigt markieren"]}),s.jsxs("button",{className:"btn warning",onClick:()=>{P(A.id)},children:[s.jsx(x,{size:16})," Mahnung senden"]})]}),s.jsx("button",{className:"btn secondary",onClick:()=>U(!1),children:"Schließen"})]})]})})]})};export{N as default};
