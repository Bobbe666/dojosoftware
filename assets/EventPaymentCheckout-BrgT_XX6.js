import{a as e,j as s}from"./query-Caj74EYQ.js";import{b as n,a,c as i}from"./index-B0gO-Ppw.js";import{S as t,P as l}from"./PaymentCheckout-B6KwbQWg.js";import{S as r}from"./SumUpCheckout-BqTOrocg.js";import{V as c,t as d,P as o,g as u,C as m,aj as h,k as p,q as v,K as j,b9 as x,d as g,i as y}from"./icons-eh0tbLFx.js";import{f as b,b as f,u as N}from"./vendor-router-B2AaIOtG.js";import"./charts-QHQg_ypW.js";import"./index-DQBxRuql.js";import"./index-wRQyZq66.js";const k=()=>{const{eventId:k}=b(),[z]=f(),S=N(),{token:E,user:_}=n(),[$,Z]=e.useState(!0),[B,C]=e.useState(""),[D,I]=e.useState(null),[L,w]=e.useState(null),[P,U]=e.useState(null),[A,F]=e.useState(null),[K,M]=e.useState(null),[q,T]=e.useState(null),[V,H]=e.useState(null),[O,R]=e.useState(!1),[W,G]=e.useState(!1),[J,Q]=e.useState(!1),[X,Y]=e.useState(null);e.useEffect(()=>{ee()},[k]),e.useEffect(()=>{const e=z.get("status");"success"===e?M("success"):"cancelled"===e&&M("cancelled");const s=z.get("anmeldung");s&&w(parseInt(s))},[z]);const ee=async()=>{var e,s,n,t,l,r,c,d,o,u,m,h,p;Z(!0),C("");try{const[h,p]=await Promise.all([a.get(`${i.apiBaseUrl}/events/${k}`,{headers:{Authorization:`Bearer ${E}`}}),a.get(`${i.apiBaseUrl}/integrations/status`,{headers:{Authorization:`Bearer ${E}`}})]);if(!h.data.success&&!h.data.event)return void C("Event nicht gefunden");if(I(h.data.event||h.data),null==_?void 0:_.mitglied_id)U(_.mitglied_id);else if(null==_?void 0:_.email){const s=await a.get(`${i.apiBaseUrl}/mitglieder/by-email/${_.email}`,{headers:{Authorization:`Bearer ${E}`}});(null==(e=s.data)?void 0:e.mitglied_id)&&U(s.data.mitglied_id)}const v=p.data;R((null==(s=null==v?void 0:v.stripe)?void 0:s.configured)||!1),G((null==(n=null==v?void 0:v.paypal)?void 0:n.configured)||!1),Q((null==(t=null==v?void 0:v.sumup)?void 0:t.configured)&&(null==(l=null==v?void 0:v.sumup)?void 0:l.active)||!1),((null==(r=h.data.event)?void 0:r.dojo_id)||h.data.dojo_id)&&Y((null==(c=h.data.event)?void 0:c.dojo_id)||h.data.dojo_id),(null==(d=null==v?void 0:v.stripe)?void 0:d.configured)?F("stripe"):(null==(o=null==v?void 0:v.paypal)?void 0:o.configured)?F("paypal"):(null==(u=null==v?void 0:v.sumup)?void 0:u.configured)&&(null==(m=null==v?void 0:v.sumup)?void 0:m.active)&&F("sumup")}catch(v){console.error("Fehler beim Laden:",v),C((null==(p=null==(h=v.response)?void 0:h.data)?void 0:p.error)||"Fehler beim Laden der Daten")}finally{Z(!1)}};e.useEffect(()=>{"stripe"===A&&D&&P&&!q&&(async()=>{var e,s;if(P)try{const e=await a.post(`${i.apiBaseUrl}/events/${k}/create-payment-intent`,{mitglied_id:P,anmeldung_id:L},{headers:{Authorization:`Bearer ${E}`}});e.data.success?(T(e.data.clientSecret),H(e.data.publishableKey)):C(e.data.error||"Fehler beim Erstellen der Zahlung")}catch(n){console.error("PaymentIntent Error:",n),C((null==(s=null==(e=n.response)?void 0:e.data)?void 0:s.error)||"Zahlungsfehler")}else C("Mitglied nicht gefunden")})()},[A,D,P]);const se=async e=>{var s;M("success");try{await a.post(`${i.apiBaseUrl}/events/${k}/payment-success`,{mitglied_id:P,anmeldung_id:L,payment_intent_id:(null==e?void 0:e.id)||(null==(s=null==e?void 0:e.paymentIntent)?void 0:s.id)},{headers:{Authorization:`Bearer ${E}`}})}catch(n){console.error("Fehler beim Aktualisieren:",n)}},ne=e=>{console.error("Payment Error:",e),M("error"),C(e.message||"Zahlung fehlgeschlagen")};if($)return s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-loading",children:[s.jsx(c,{className:"spin",size:48}),s.jsx("p",{children:"Lade Event-Daten..."})]})});if(B&&!D)return s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-error-full",children:[s.jsx(d,{size:48}),s.jsx("h2",{children:"Fehler"}),s.jsx("p",{children:B}),s.jsxs("button",{onClick:()=>S(-1),className:"btn-back",children:[s.jsx(o,{size:16}),"Zurück"]})]})});if("success"===K)return s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-success",children:[s.jsx(u,{size:64}),s.jsx("h2",{children:"Zahlung erfolgreich!"}),s.jsx("p",{children:"Deine Teilnahme am Event ist bestätigt."}),s.jsxs("div",{className:"success-details",children:[s.jsx("h3",{children:null==D?void 0:D.titel}),s.jsxs("p",{children:[s.jsx(m,{size:16})," ",new Date(null==D?void 0:D.datum).toLocaleDateString("de-DE",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})]}),(null==D?void 0:D.ort)&&s.jsxs("p",{children:[s.jsx(h,{size:16})," ",D.ort]})]}),s.jsx("button",{onClick:()=>S("/member/events"),className:"btn-primary",children:"Zurück zu meinen Events"})]})});if("cancelled"===K)return s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-cancelled",children:[s.jsx(p,{size:64}),s.jsx("h2",{children:"Zahlung abgebrochen"}),s.jsx("p",{children:"Du kannst die Zahlung jederzeit erneut versuchen."}),s.jsx("button",{onClick:()=>M(null),className:"btn-primary",children:"Erneut versuchen"}),s.jsx("button",{onClick:()=>S("/member/events"),className:"btn-secondary",children:"Zurück zu Events"})]})});if(!O&&!W&&!J)return s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-error-full",children:[s.jsx(p,{size:48}),s.jsx("h2",{children:"Zahlung nicht möglich"}),s.jsx("p",{children:"Momentan ist keine Online-Zahlung verfügbar. Bitte kontaktiere das Dojo."}),s.jsxs("button",{onClick:()=>S(-1),className:"btn-back",children:[s.jsx(o,{size:16}),"Zurück"]})]})});const ae=parseFloat((null==D?void 0:D.teilnahmegebuehr)||0);return s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-container",children:[s.jsxs("div",{className:"payment-header",children:[s.jsx("button",{onClick:()=>S(-1),className:"btn-back-icon",children:s.jsx(o,{size:20})}),s.jsx("h1",{children:"Event-Zahlung"})]}),s.jsxs("div",{className:"payment-details-card",children:[s.jsx("h2",{children:null==D?void 0:D.titel}),s.jsxs("div",{className:"event-meta",children:[s.jsxs("span",{children:[s.jsx(m,{size:16})," ",new Date(null==D?void 0:D.datum).toLocaleDateString("de-DE")]}),(null==D?void 0:D.uhrzeit_beginn)&&s.jsxs("span",{children:[s.jsx(v,{size:16})," ",D.uhrzeit_beginn.substring(0,5)," Uhr"]}),(null==D?void 0:D.ort)&&s.jsxs("span",{children:[s.jsx(h,{size:16})," ",D.ort]})]}),s.jsxs("div",{className:"payment-amount",children:[s.jsx("span",{children:"Teilnahmegebühr:"}),s.jsx("strong",{children:ae.toLocaleString("de-DE",{style:"currency",currency:"EUR"})})]})]}),B&&s.jsxs("div",{className:"payment-error",children:[s.jsx(p,{size:16}),B]}),[O,W,J].filter(Boolean).length>1&&s.jsxs("div",{className:"payment-tabs",children:[O&&s.jsxs("button",{className:"payment-tab "+("stripe"===A?"active":""),onClick:()=>F("stripe"),children:[s.jsx(j,{size:18}),"Kreditkarte / SEPA"]}),W&&s.jsxs("button",{className:"payment-tab "+("paypal"===A?"active":""),onClick:()=>F("paypal"),children:[s.jsx("svg",{viewBox:"0 0 24 24",width:"18",height:"18",fill:"currentColor",children:s.jsx("path",{d:"M20.067 8.478c.492.88.556 2.014.3 3.327-.74 3.806-3.276 5.12-6.514 5.12h-.5a.805.805 0 0 0-.794.68l-.04.22-.63 3.993-.032.17a.804.804 0 0 1-.794.679H7.72a.483.483 0 0 1-.477-.558L7.418 21h1.518l.95-6.02h1.385c4.678 0 7.75-2.203 8.796-6.502z"})}),"PayPal"]}),J&&s.jsxs("button",{className:"payment-tab "+("sumup"===A?"active":""),onClick:()=>F("sumup"),children:[s.jsx(x,{size:18}),"SumUp"]})]}),"stripe"===A&&O&&s.jsx("div",{className:"payment-form-container",children:q&&V?s.jsx(t,{clientSecret:q,publishableKey:V,amount:ae,onSuccess:se,onError:ne}):s.jsxs("div",{className:"payment-loading-small",children:[s.jsx(c,{className:"spin",size:24}),s.jsx("span",{children:"Lade Zahlungsformular..."})]})}),"paypal"===A&&W&&s.jsx("div",{className:"payment-form-container",children:s.jsx(l,{amount:ae,description:`Event: ${null==D?void 0:D.titel}`,onSuccess:se,onError:ne})}),"sumup"===A&&J&&s.jsx("div",{className:"payment-form-container",children:s.jsx(r,{amount:ae,description:`Event: ${null==D?void 0:D.titel}`,dojoId:X,eventAnmeldungId:L,mitgliedId:P,zahlungstyp:"event",onSuccess:e=>{se({id:e.checkoutId,transactionId:e.transactionId})},onError:e=>{ne({message:e})}})}),s.jsxs("div",{className:"payment-security",children:[s.jsx(g,{size:16}),s.jsx("span",{children:"Sichere Zahlung - SSL-verschlüsselt"}),s.jsx(y,{size:16})]})]})})};export{k as default};
