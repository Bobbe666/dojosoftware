import{j as e,a as t}from"./query-Caj74EYQ.js";import{g as s,b as n,c as i,f as a}from"./index-Bcs73ipe.js";import"./vendor-router-Co3o87Zc.js";import"./icons-DiLw-1i5.js";import"./charts-C1Gv3M_c.js";const c=({member:t,anwesenheitEintrag:s={status:"",bemerkung:""},onClose:n,onAction:i,onBemerkungChange:a})=>{if(!t)return null;return e.jsx("div",{className:"anwesenheit-popup-overlay",onClick:e=>{e.target===e.currentTarget&&n()},children:e.jsxs("div",{className:"anwesenheit-popup",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"popup-header",children:[e.jsx("img",{src:t.profilbild||"/default-user.png",alt:"Profil",className:"popup-profilbild"}),e.jsxs("div",{className:"popup-name",children:[e.jsxs("strong",{children:[t.vorname," ",t.nachname]}),t.gurtfarbe&&e.jsx("span",{className:"popup-gurt",children:t.gurtfarbe})]}),e.jsx("button",{className:"popup-close",onClick:n,children:"âœ•"})]}),e.jsxs("div",{className:"popup-status",children:["anwesend"===s.status&&"âœ… Aktuell als anwesend markiert","verspÃ¤tet"===s.status&&"ğŸ• Als verspÃ¤tet markiert","abgebrochen"===s.status&&"ğŸšª Hat abgebrochen","entfernt"===s.status&&"âŒ Aus Stunde entfernt",!s.status&&"â³ Noch nicht anwesend"]}),e.jsxs("div",{className:"popup-actions",children:[e.jsx("button",{className:"popup-btn popup-btn-red",onClick:()=>i("entfernt"),children:"âŒ Aus Stunde entfernen"}),e.jsx("button",{className:"popup-btn popup-btn-yellow",onClick:()=>i("verspÃ¤tet"),children:"ğŸ• VerspÃ¤tet"}),e.jsx("button",{className:"popup-btn popup-btn-orange",onClick:()=>i("abgebrochen"),children:"ğŸšª Abgebrochen"})]}),e.jsx("div",{className:"popup-bemerkung",children:e.jsx("input",{type:"text",placeholder:"Bemerkung hinzufÃ¼gen...",value:s.bemerkung??"",onChange:e=>a(e.target.value)})})]})})},r=({mitglied:t,anwesenheitEintrag:s={status:"",bemerkung:"",gespeichert:!1},isFromSearch:n=!1,onClick:i})=>{const a=t.mitglied_id||t.id,c=s.status?`status-${s.status}`:"",r="anwesend"===s.status&&s.gespeichert?"block-gespeichert":"",l=t.checkin_status||"nicht_eingecheckt",d=`checkin-${l}`,o=n?"search-result":"";return e.jsx("div",{className:`mitglied-block ${c} ${r} ${d} ${o}`,onClick:()=>i(a,t),style:{...n&&{borderColor:"#1976d2",backgroundColor:"#e3f2fd"}},children:e.jsxs("div",{className:"mitglied-header",children:[e.jsx("img",{src:t.profilbild||"/default-user.png",alt:"Profil",className:"mitglied-profilbild"}),e.jsxs("div",{className:"mitglied-info",children:[e.jsxs("strong",{children:[t.vorname," ",t.nachname,n&&e.jsx("span",{style:{color:"#1976d2",fontSize:"12px",marginLeft:"8px",background:"#bbdefb",padding:"2px 6px",borderRadius:"10px"},children:"ğŸ” Suchergebnis"})]}),e.jsxs("div",{className:"mitglied-details-inline",children:[t.gurtfarbe&&e.jsx("span",{className:"gurtfarbe",children:t.gurtfarbe}),"eingecheckt"===l&&"entfernt"!==s.status&&e.jsx("span",{className:"checkin-badge",children:"ğŸ“± Eingecheckt"})]}),"entfernt"===s.status&&e.jsx("div",{className:"entfernt-hinweis",children:"âŒ aus der Stunde entfernt"})]})]})},a)},l=()=>{const{updateTrigger:l}=s(),{getDojoFilterParam:d,activeDojo:o}=n(),[u,h]=t.useState([]),[m,g]=t.useState(null),[p,k]=t.useState(()=>(new Date).toISOString().split("T")[0]),[w,f]=t.useState([]),[_,b]=t.useState({}),[v,j]=t.useState([]),[x,N]=t.useState(""),[S,y]=t.useState(!1),[C,$]=t.useState(!1),[D,E]=t.useState({}),[A,F]=t.useState(null),[L,T]=t.useState(!1),[O,M]=t.useState(!1),[K,P]=t.useState({}),[B,I]=t.useState(!1),[W,U]=t.useState([]),[z,H]=t.useState(!1),J=t.useRef(null);t.useEffect(()=>{q(p)},[p]);const R=async e=>{try{const s=await a(e);if(!s.ok){const e=await s.text();let n;try{n=JSON.parse(e)}catch(t){n={error:e||`HTTP ${s.status}: ${s.statusText}`}}throw new Error(n.error||n.details||`HTTP ${s.status}`)}return await s.json()}catch(s){throw console.error("âŒ Fehler beim Laden der Kursmitglieder:",s),s}},q=async e=>{try{I(!0);const t=d(),s=t?`${i.apiBaseUrl}/anwesenheit/kurse/${e}?${t}`:`${i.apiBaseUrl}/anwesenheit/kurse/${e}`;console.log("ğŸ“… Lade Kurse:",s,"activeDojo:",o);const n=await a(s),c=await n.json();if(c.success){j(c.kurse);const e={};c.kurse.forEach(t=>{e[t.stundenplan_id]={checkins_heute:t.checkins_heute,aktive_checkins:t.aktive_checkins}}),P(e)}else j([]),P({})}catch(t){console.error("âŒ Fehler beim Laden der Kurse:",t),j([]),P({})}finally{I(!1)}},V=e=>{k(e),g(null),f([]),b({}),T(!1),M(!1),N(""),U([]),H(!1),q(e)};t.useEffect(()=>{if(m&&l>0){console.log("ğŸ”„ Mitglieder-Update erkannt, lade Kursmitglieder neu...");const e=m.stundenplan_id||m.id;(async()=>{try{I(!0);let t="";L?t="?show_all=true":O&&(t="?show_style_only=true");const s=await R(`/api/anwesenheit/kurs/${e}/${p}${t}`);if(s.success){const t=s.members;f(t);const n={};t.forEach(e=>{const t=e.mitglied_id;n[t]={status:1===e.anwesend?"anwesend":"",bemerkung:"",gespeichert:1===e.anwesend,checkin_status:e.checkin_status,checkin_time:e.checkin_time,checkout_time:e.checkout_time}}),b(n),G(e)}}catch(t){console.error("âŒ Fehler beim Neuladen der Kursmitglieder:",t)}finally{I(!1)}})()}},[l,m,p,L,O]);const G=async e=>{try{const t=await R(`/api/anwesenheit/kurs/${e}/${p}?show_all=true`);t.success&&U(t.members)}catch(t){console.error("âŒ Fehler beim Laden aller Mitglieder fÃ¼r Suche:",t)}},Q=async(e,t)=>{var s,n;try{const r=null==(s=_[e])?void 0:s.status,l="anwesend"===t&&"anwesend"===r?"entfernt":t,d={mitglied_id:e,stundenplan_id:m.stundenplan_id||m.id,datum:p,anwesend:"anwesend"===l?1:0,bemerkung:(null==(n=_[e])?void 0:n.bemerkung)||"",status:l},o=await a(`${i.apiBaseUrl}/anwesenheit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),u=await o.json();if(o.ok){if("anwesend"===l)try{const t={mitglied_id:e,stundenplan_id:m.stundenplan_id||m.id,datum:p,checkin_type:"manual"},s=await a(`${i.apiBaseUrl}/checkin`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await s.json();s.ok?f(t=>t.map(t=>t.mitglied_id===e?{...t,checkin_status:"eingecheckt",checkin_time:(new Date).toISOString()}:t)):console.warn("âš ï¸ Check-in-Erstellung fehlgeschlagen:",n)}catch(c){console.warn("âš ï¸ Fehler beim Check-in erstellen:",c)}if(b(t=>({...t,[e]:{...t[e],status:l,gespeichert:!0}})),"entfernt"===l&&f(t=>t.map(t=>t.mitglied_id===e?{...t,checkin_status:"entfernt"}:t)),z&&"anwesend"===l){const t=W.find(t=>t.mitglied_id===e);t&&(f(s=>s.some(t=>t.mitglied_id===e)?s.map(t=>t.mitglied_id===e?{...t,anwesend:1,checkin_status:"eingecheckt",checkin_time:(new Date).toISOString()}:t):[...s,{...t,anwesend:1,checkin_status:"eingecheckt",checkin_time:(new Date).toISOString()}]),N(""),setTimeout(()=>{var e;return null==(e=J.current)?void 0:e.focus()},50))}}else if(console.error(`âŒ API-Fehler: ${o.status}`,u),z&&"anwesend"===t){const t=W.find(t=>t.mitglied_id===e);t&&(f(s=>s.some(t=>t.mitglied_id===e)?s:[...s,{...t,anwesend:1,checkin_status:"eingecheckt",checkin_time:(new Date).toISOString()}]),b(t=>({...t,[e]:{...t[e],status:"anwesend",gespeichert:!0}})),N(""),setTimeout(()=>{var e;return null==(e=J.current)?void 0:e.focus()},50))}}catch(r){console.error("âŒ Fehler beim Speichern der Anwesenheit:",r)}},X=(e,t)=>{var s;if("anwesend"!==(null==(s=_[e])?void 0:s.status))return Q(e,"anwesend"),void(S&&y(!1));F({...t,id:e})},Y=()=>{F(null)};return e.jsxs("div",{className:"anwesenheit-container",children:[e.jsx("div",{className:"anwesenheit-header",children:e.jsx("div",{className:"anwesenheit-header-content",children:e.jsxs("div",{className:"anwesenheit-header-top",children:[e.jsx("div",{className:"anwesenheit-header-title",children:e.jsx("h2",{children:"Anwesenheitsverwaltung"})}),e.jsx("div",{className:"wochentag-buttons",children:["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"].map(t=>e.jsx("button",{onClick:()=>(e=>{const t=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"].indexOf(e),s=new Date,n=t-s.getDay(),i=new Date(s);i.setDate(s.getDate()+n);const a=i.toISOString().split("T")[0];V(a)})(t),children:t},t))}),e.jsx("div",{className:"datum-auswahl-kompakt",children:e.jsx("input",{type:"date",value:p,onChange:e=>V(e.target.value)})})]})})}),B&&e.jsx("div",{className:"loading",children:"ğŸ”„ Lade..."}),e.jsxs("div",{className:"stundenplan-list",children:[0===v.length&&!B&&e.jsx("p",{style:{color:"#a00",fontStyle:"italic",marginBottom:"1rem"},children:"âš ï¸ FÃ¼r das gewÃ¤hlte Datum sind keine Kurse geplant."}),v.map(t=>{const s=(e=>{const t=m&&(m.stundenplan_id||m.id)===e;if(t&&w.length>0&&!B){const e=w.filter(e=>"eingecheckt"===e.checkin_status).length;return{checkins_heute:Object.values(_).filter(e=>"anwesend"===e.status).length,aktive_checkins:e,showStats:!0}}return t&&B?{checkins_heute:0,aktive_checkins:0,showStats:!1,loading:!0}:{checkins_heute:0,aktive_checkins:0,showStats:!1}})(t.stundenplan_id);return e.jsxs("button",{onClick:()=>(async e=>{try{I(!0),g(e),f([]),b({}),T(!1),M(!1),N(""),U([]),H(!1);const t=e.stundenplan_id||e.id,s=await R(`/api/anwesenheit/kurs/${t}/${p}`);if(s.success){const e=s.members;f(e);const n={};e.forEach(e=>{const t=e.mitglied_id;n[t]={status:1===e.anwesend?"anwesend":"",bemerkung:"",gespeichert:1===e.anwesend,checkin_status:e.checkin_status,checkin_time:e.checkin_time,checkout_time:e.checkout_time}}),b(n),G(t)}}catch(t){console.error("âŒ Fehler beim Laden der Kursmitglieder:",t),f([]),b({})}finally{I(!1)}})(t),className:m&&(m.stundenplan_id||m.id)===(t.stundenplan_id||t.id)?"ausgewaehlt":"",children:[e.jsxs("div",{children:[t.wochentag,", ",t.zeit]}),e.jsxs("div",{children:[t.stil&&e.jsx("strong",{children:t.stil}),t.stil&&t.kurs_name&&e.jsx("br",{}),t.kurs_name]}),s.showStats?e.jsxs("div",{className:"kurs-stats",children:["ğŸ“ ",s.aktive_checkins," aktiv | ğŸ“‹ ",s.checkins_heute," heute"]}):s.loading?e.jsx("div",{className:"kurs-stats-loading",children:"ğŸ”„ Lade..."}):e.jsx("div",{className:"kurs-stats-placeholder",children:"ğŸ“Š WÃ¤hlen fÃ¼r Details"})]},t.stundenplan_id||t.id)})]}),m&&e.jsxs("div",{className:"mitglieder-abschnitt",children:[e.jsxs("div",{className:"alle-kontrollen-container",children:[e.jsx("div",{className:"suchfeld-links",children:e.jsx("input",{type:"text",placeholder:z?"ğŸ” Durchsuche ALLE Kursmitglieder...":"Mitglied suchen...",ref:J,value:x,onChange:e=>{return t=e.target.value,N(t),void(t.length>0?H(!0):H(!1));var t},className:"suchfeld "+(z?"suchfeld-aktiv":"")})}),e.jsxs("div",{className:"filter-buttons-gruppe",children:[e.jsx("button",{onClick:async()=>{if(!m)return;T(!1),M(!1),I(!0);const e=m.stundenplan_id||m.id,t=await R(`/api/anwesenheit/kurs/${e}/${p}`);if(t.success){f(t.members);const e={};t.members.forEach(t=>{e[t.mitglied_id]={status:1===t.anwesend?"anwesend":"",bemerkung:"",gespeichert:1===t.anwesend,checkin_status:t.checkin_status,checkin_time:t.checkin_time,checkout_time:t.checkout_time}}),b(e)}I(!1)},className:"filter-btn "+(L||O?"":"active-blue"),children:"ğŸ“‹ Kurs-Mitglieder"}),e.jsx("button",{onClick:async()=>{if(!m)return;T(!1),M(!0),I(!0);const e=m.stundenplan_id||m.id,t=await R(`/api/anwesenheit/kurs/${e}/${p}?show_style_only=true`);if(t.success){f(t.members);const e={};t.members.forEach(t=>{e[t.mitglied_id]={status:1===t.anwesend?"anwesend":"",bemerkung:"",gespeichert:1===t.anwesend,checkin_status:t.checkin_status,checkin_time:t.checkin_time,checkout_time:t.checkout_time}}),b(e)}I(!1)},className:"filter-btn "+(O?"active-orange":""),children:"ğŸ¥‹ Alle Stil-Mitglieder"}),e.jsx("button",{onClick:async()=>{if(!m)return;T(!0),M(!1),I(!0);const e=m.stundenplan_id||m.id,t=await R(`/api/anwesenheit/kurs/${e}/${p}?show_all=true`);if(t.success){f(t.members);const e={};t.members.forEach(t=>{e[t.mitglied_id]={status:1===t.anwesend?"anwesend":"",bemerkung:"",gespeichert:1===t.anwesend,checkin_status:t.checkin_status,checkin_time:t.checkin_time,checkout_time:t.checkout_time}}),b(e)}I(!1)},className:"filter-btn "+(L?"active-green":""),children:"ğŸ” Alle Mitglieder"})]}),e.jsxs("div",{className:"anwesenheit-filter-buttons",children:[e.jsx("button",{onClick:()=>{$(!C),C||y(!1)},className:"filter-btn-small "+(C?"active-green":""),children:"âœ… Nur Anwesende"}),e.jsx("button",{onClick:()=>{y(!S),S||$(!1)},className:"filter-btn-small "+(S?"active-red":""),children:"âŒ Nur Fehlende"})]}),e.jsx("div",{className:"anwesend-button-rechts",children:e.jsx("button",{className:"anwesend-toggle-button",children:"âœ… Anwesend"})})]}),e.jsx("div",{className:"mitglieder-stats-container",children:e.jsxs("div",{className:"mitglieder-stats",children:["ğŸ“Š ",w.length," Mitglieder | âœ… ",w.filter(e=>{var t;return"anwesend"===(null==(t=_[e.mitglied_id])?void 0:t.status)}).length," anwesend | ğŸ“± ",w.filter(e=>"eingecheckt"===e.checkin_status).length," eingecheckt",O&&e.jsx("span",{style:{color:"#ff9800",fontWeight:"bold",marginLeft:"10px"},children:"| ğŸ¥‹ Stil-Filter aktiv"}),L&&e.jsx("span",{style:{color:"#4caf50",fontWeight:"bold",marginLeft:"10px"},children:"| ğŸ” Alle Mitglieder"}),z&&e.jsxs("span",{style:{color:"#1976d2",fontWeight:"bold",marginLeft:"10px"},children:["| ğŸ” Suche aktiv (",W.length," durchsuchbar)"]})]})}),e.jsx("div",{className:"mitglieder-list",children:(()=>{const e=[],t=[],s=[],n=x.toLowerCase();return(z&&W.length>0?W:w).filter(e=>{var t,s;const i=(null==(t=e.nachname)?void 0:t.toLowerCase())||"",a=(null==(s=e.vorname)?void 0:s.toLowerCase())||"";return i.includes(n)||a.includes(n)}).forEach(n=>{const i=n.mitglied_id||n.id;let a;_[i]?a=_[i].status:z?(a=1===n.anwesend?"anwesend":"",_[i]||b(e=>({...e,[i]:{status:a,bemerkung:"",gespeichert:1===n.anwesend,checkin_status:n.checkin_status,checkin_time:n.checkin_time,checkout_time:n.checkout_time}}))):a="",S&&"anwesend"===a||C&&"anwesend"!==a||("entfernt"===a?s.push(n):"anwesend"===a?t.push(n):e.push(n))}),[...s,...e,"---ANWESEND---",...t]})().map(t=>{if("---ANWESEND---"===t)return null;const s=t.mitglied_id||t.id,n=_[s]||{status:"",bemerkung:""},i=z&&!w.some(e=>e.mitglied_id===s);return e.jsx(r,{mitglied:t,anwesenheitEintrag:n,isFromSearch:i,onClick:X},s)})})]}),e.jsx(c,{member:A,anwesenheitEintrag:A?_[A.id]:null,onClose:Y,onAction:e=>{if(!A)return;const t=A.id;Q(t,"entfernen"===e?"entfernt":e),Y()},onBemerkungChange:e=>{return t=null==A?void 0:A.id,s=e,void b(e=>({...e,[t]:{...e[t],bemerkung:s,gespeichert:!1}}));var t,s}})]})};export{l as default};
