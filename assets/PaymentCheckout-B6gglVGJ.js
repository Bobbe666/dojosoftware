import{a as e,j as s}from"./query-Caj74EYQ.js";import{b as n,a,c as r}from"./index-NPitIXjM.js";import{S as c,P as i}from"./PaymentCheckout-Tr1PveEO.js";import{S as l}from"./SumUpCheckout-GUDiFNUm.js";import{V as t,t as d,P as u,g as o,k as h,K as m,b9 as p,i as j}from"./icons-eh0tbLFx.js";import{f as g,b as x,u as v}from"./vendor-router-B2AaIOtG.js";import"./charts-QHQg_ypW.js";import"./index-DQBxRuql.js";import"./index-wRQyZq66.js";const y=()=>{var y;const{rechnungId:b}=g(),[k]=x(),N=v(),{token:f,user:S}=n(),[z,E]=e.useState(!0),[Z,R]=e.useState(""),[C,I]=e.useState(null),[w,D]=e.useState(null),[F,$]=e.useState(null),[B,L]=e.useState(null),[U,P]=e.useState(!1),[A,V]=e.useState(!1),[_,K]=e.useState(!1),[O,q]=e.useState(null);e.useEffect(()=>{G()},[b]),e.useEffect(()=>{const e=k.get("status");"success"===e?L("success"):"cancelled"===e&&L("cancelled")},[k]);const G=async()=>{var e,s,n,c,i,l,t,d,u,o,h;E(!0),R("");try{const[o,h]=await Promise.all([a.get(`${r.apiBaseUrl}/rechnungen/${b}`,{headers:{Authorization:`Bearer ${f}`}}),a.get(`${r.apiBaseUrl}/integrations/status`,{headers:{Authorization:`Bearer ${f}`}})]);if(!o.data.success)return void R("Rechnung nicht gefunden");I(o.data.rechnung);const m=h.data;P((null==(e=null==m?void 0:m.stripe)?void 0:e.configured)||!1),V((null==(s=null==m?void 0:m.paypal)?void 0:s.configured)||!1),K((null==(n=null==m?void 0:m.sumup)?void 0:n.configured)&&(null==(c=null==m?void 0:m.sumup)?void 0:c.active)||!1),(null==(i=o.data.rechnung)?void 0:i.dojo_id)&&q(o.data.rechnung.dojo_id),(null==(l=null==m?void 0:m.stripe)?void 0:l.configured)?$("stripe"):(null==(t=null==m?void 0:m.paypal)?void 0:t.configured)?$("paypal"):(null==(d=null==m?void 0:m.sumup)?void 0:d.configured)&&(null==(u=null==m?void 0:m.sumup)?void 0:u.active)&&$("sumup")}catch(m){console.error("Fehler beim Laden:",m),R((null==(h=null==(o=m.response)?void 0:o.data)?void 0:h.error)||"Fehler beim Laden der Daten")}finally{E(!1)}},H=async e=>{L("success");try{const s="stripe"===F?"kreditkarte":"sumup"===F?"sumup":"paypal";await a.post(`${r.apiBaseUrl}/rechnungen/${b}/zahlung`,{betrag:C.gesamtbetrag,zahlungsart:s,referenz:e.id||e.orderId||e.transactionId},{headers:{Authorization:`Bearer ${f}`}})}catch(s){console.error("Fehler beim Aktualisieren der Rechnung:",s)}},M=e=>{console.error("Payment Error:",e),L("error"),R(e.message||"Zahlung fehlgeschlagen")};return z?s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-loading",children:[s.jsx(t,{className:"spin",size:48}),s.jsx("p",{children:"Lade Zahlungsdaten..."})]})}):Z&&!C?s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-error-full",children:[s.jsx(d,{size:48}),s.jsx("h2",{children:"Fehler"}),s.jsx("p",{children:Z}),s.jsxs("button",{onClick:()=>N(-1),className:"btn-back",children:[s.jsx(u,{size:16}),"Zurück"]})]})}):"success"===B?s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-success",children:[s.jsx(o,{size:64}),s.jsx("h2",{children:"Zahlung erfolgreich!"}),s.jsx("p",{children:"Ihre Zahlung wurde erfolgreich verarbeitet."}),s.jsxs("div",{className:"payment-success-details",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Rechnungsnummer:"})," ",null==C?void 0:C.rechnungsnummer]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Betrag:"})," ",parseFloat((null==C?void 0:C.gesamtbetrag)||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"})]})]}),s.jsx("button",{onClick:()=>N("/rechnungen"),className:"btn-primary",children:"Zu meinen Rechnungen"})]})}):"cancelled"===B?s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-cancelled",children:[s.jsx(h,{size:64}),s.jsx("h2",{children:"Zahlung abgebrochen"}),s.jsx("p",{children:"Sie haben die Zahlung abgebrochen."}),s.jsxs("div",{className:"payment-actions",children:[s.jsx("button",{onClick:()=>L(null),className:"btn-primary",children:"Erneut versuchen"}),s.jsx("button",{onClick:()=>N("/rechnungen"),className:"btn-secondary",children:"Zurück zu Rechnungen"})]})]})}):U||A||_?s.jsxs("div",{className:"payment-checkout",children:[s.jsxs("div",{className:"payment-header",children:[s.jsxs("button",{onClick:()=>N(-1),className:"btn-back-link",children:[s.jsx(u,{size:18}),"Zurück"]}),s.jsxs("h1",{children:[s.jsx(m,{size:28}),"Rechnung bezahlen"]})]}),s.jsxs("div",{className:"payment-content",children:[s.jsxs("div",{className:"payment-invoice-summary",children:[s.jsx("h2",{children:"Rechnungsdetails"}),s.jsxs("div",{className:"invoice-info",children:[s.jsxs("div",{className:"invoice-row",children:[s.jsx("span",{children:"Rechnungsnummer:"}),s.jsx("strong",{children:null==C?void 0:C.rechnungsnummer})]}),s.jsxs("div",{className:"invoice-row",children:[s.jsx("span",{children:"Datum:"}),s.jsx("span",{children:new Date(null==C?void 0:C.rechnungsdatum).toLocaleDateString("de-DE")})]}),null==(y=null==C?void 0:C.positionen)?void 0:y.map((e,n)=>s.jsxs("div",{className:"invoice-position",children:[s.jsx("span",{children:e.beschreibung}),s.jsx("span",{children:parseFloat(e.betrag).toLocaleString("de-DE",{style:"currency",currency:"EUR"})})]},n)),s.jsxs("div",{className:"invoice-total",children:[s.jsx("span",{children:"Gesamtbetrag:"}),s.jsx("strong",{children:parseFloat((null==C?void 0:C.gesamtbetrag)||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"})})]})]})]}),s.jsxs("div",{className:"payment-methods",children:[s.jsx("h2",{children:"Zahlungsmethode wählen"}),s.jsxs("div",{className:"payment-method-tabs",children:[U&&s.jsxs("button",{className:"method-tab "+("stripe"===F?"active":""),onClick:()=>$("stripe"),children:[s.jsx(m,{size:20}),s.jsx("span",{children:"Kreditkarte / SEPA"})]}),A&&s.jsxs("button",{className:"method-tab "+("paypal"===F?"active":""),onClick:()=>$("paypal"),children:[s.jsx("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor",children:s.jsx("path",{d:"M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.72a.77.77 0 0 1 .757-.629h6.774c2.236 0 3.833.585 4.744 1.74.873 1.106 1.096 2.58.661 4.388-.04.17-.078.326-.124.493a8.591 8.591 0 0 1-.266.89c-.93 2.753-3.16 4.148-6.632 4.148h-1.58a.953.953 0 0 0-.94.804l-.897 5.683-.163.1z"})}),s.jsx("span",{children:"PayPal"})]}),_&&s.jsxs("button",{className:"method-tab "+("sumup"===F?"active":""),onClick:()=>$("sumup"),children:[s.jsx(p,{size:20}),s.jsx("span",{children:"SumUp"})]})]}),s.jsxs("div",{className:"payment-form-container",children:["stripe"===F&&U&&s.jsx(c,{amount:parseFloat((null==C?void 0:C.gesamtbetrag)||0),currency:"eur",rechnungId:b,onSuccess:H,onError:M}),"paypal"===F&&A&&s.jsx(i,{amount:parseFloat((null==C?void 0:C.gesamtbetrag)||0),currency:"EUR",rechnungId:b,description:`Rechnung ${null==C?void 0:C.rechnungsnummer}`,onSuccess:H,onError:M}),"sumup"===F&&_&&s.jsx(l,{amount:parseFloat((null==C?void 0:C.gesamtbetrag)||0),description:`Rechnung ${null==C?void 0:C.rechnungsnummer}`,dojoId:O,rechnungId:b,zahlungstyp:"rechnung",onSuccess:e=>{H({id:e.checkoutId,transactionId:e.transactionId})},onError:e=>{M({message:e})}})]})]}),s.jsxs("div",{className:"payment-security",children:[s.jsx(j,{size:16}),s.jsx("span",{children:"Sichere Verbindung - Ihre Daten werden verschlüsselt übertragen"})]}),Z&&s.jsxs("div",{className:"payment-error",children:[s.jsx(h,{size:16}),s.jsx("span",{children:Z})]})]})]}):s.jsx("div",{className:"payment-checkout",children:s.jsxs("div",{className:"payment-not-available",children:[s.jsx(h,{size:48}),s.jsx("h2",{children:"Online-Zahlung nicht verfügbar"}),s.jsx("p",{children:"Derzeit sind keine Online-Zahlungsmethoden konfiguriert."}),s.jsx("p",{children:"Bitte kontaktieren Sie uns für alternative Zahlungsmöglichkeiten."}),s.jsxs("button",{onClick:()=>N(-1),className:"btn-back",children:[s.jsx(u,{size:16}),"Zurück"]})]})})};export{y as default};
