import{a as e,j as s}from"./query-Caj74EYQ.js";import{f as a,c as t}from"./index-DJzZu8AC.js";import{aS as i,b0 as l,a as n,b as r,R as c,s as d,C as o,U as h,j}from"./icons-DiLw-1i5.js";import"./vendor-router-Co3o87Zc.js";import"./charts-C1Gv3M_c.js";const u=()=>{var u,m;const[x,g]=e.useState([]),[b,p]=e.useState(!1),[N,v]=e.useState(null),[f,k]=e.useState([]),[_,y]=e.useState({kategorie:"",suchbegriff:"",von_datum:"",bis_datum:""}),[S,w]=e.useState(!1),[z,E]=e.useState(0),[C,A]=e.useState(!0),[L,U]=e.useState(null),D={MITGLIED:"ðŸ‘¤",FINANZEN:"ðŸ’°",VERTRAG:"ðŸ“„",PRUEFUNG:"ðŸ¥‹",ADMIN:"âš™ï¸",SEPA:"ðŸ¦",DOKUMENT:"ðŸ“",SYSTEM:"ðŸ–¥ï¸",AUTH:"ðŸ”"},B={MITGLIED:"#3b82f6",FINANZEN:"#10b981",VERTRAG:"#8b5cf6",PRUEFUNG:"#f59e0b",ADMIN:"#6366f1",SEPA:"#14b8a6",DOKUMENT:"#ec4899",SYSTEM:"#6b7280",AUTH:"#ef4444"};e.useEffect(()=>{T()},[]),e.useEffect(()=>{R(!0)},[_]);const T=async()=>{try{const e=await a(`${t.apiBaseUrl}/audit-log/kategorien`);if(e.ok){const s=await e.json();k(s.data||[])}}catch(e){console.error("Fehler beim Laden der Kategorien:",e)}},R=e.useCallback(async(e=!1)=>{p(!0);try{const s=e?0:z,i=new URLSearchParams({limit:50..toString(),offset:s.toString()});_.kategorie&&i.append("kategorie",_.kategorie),_.suchbegriff&&i.append("suchbegriff",_.suchbegriff),_.von_datum&&i.append("von_datum",_.von_datum),_.bis_datum&&i.append("bis_datum",_.bis_datum);const l=await a(`${t.apiBaseUrl}/audit-log?${i}`);if(l.ok){const s=await l.json();e?(g(s.data||[]),E(50)):(g(e=>[...e,...s.data||[]]),E(e=>e+50)),A(50===(s.data||[]).length)}}catch(s){console.error("Fehler beim Laden der Logs:",s)}finally{p(!1)}},[_,z]);e.useEffect(()=>{(async()=>{try{const e=await a(`${t.apiBaseUrl}/audit-log/stats?tage=30`);if(e.ok){const s=await e.json();v(s.data)}}catch(e){console.error("Fehler beim Laden der Statistiken:",e)}})()},[]);const F=e=>{if(!e)return"-";return new Date(e).toLocaleString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},I=e=>e.replace(/_/g," ").toLowerCase().replace(/^\w/,e=>e.toUpperCase()),$=(e,s)=>{y(a=>({...a,[e]:s})),E(0)},K=e=>{if(!e)return"-";try{const s="string"==typeof e?JSON.parse(e):e,a=Object.keys(s);return 0===a.length?"-":a.slice(0,3).map(e=>`${e}: ${s[e]}`).join(", ")+(a.length>3?"...":"")}catch{return String(e).substring(0,50)}};return s.jsxs("div",{className:"audit-log-container",children:[s.jsxs("div",{className:"audit-log-header",children:[s.jsxs("div",{className:"header-title",children:[s.jsx(i,{size:24}),s.jsx("h2",{children:"Audit-Log"})]}),s.jsxs("div",{className:"header-actions",children:[s.jsxs("button",{className:"filter-toggle "+(S?"active":""),onClick:()=>w(!S),children:[s.jsx(l,{size:18}),"Filter",S?s.jsx(n,{size:16}):s.jsx(r,{size:16})]}),s.jsx("button",{className:"refresh-btn",onClick:()=>R(!0),disabled:b,children:s.jsx(c,{size:18,className:b?"spinning":""})})]})]}),N&&s.jsxs("div",{className:"audit-stats",children:[s.jsxs("div",{className:"stat-card",children:[s.jsx("span",{className:"stat-label",children:"Letzte 30 Tage"}),s.jsx("span",{className:"stat-value",children:(null==(u=N.stats)?void 0:u.reduce((e,s)=>e+s.anzahl,0))||0}),s.jsx("span",{className:"stat-sub",children:"Aktionen"})]}),null==(m=N.stats)?void 0:m.slice(0,4).map((e,a)=>s.jsxs("div",{className:"stat-card mini",children:[s.jsx("span",{className:"stat-icon",children:D[e.kategorie]||"ðŸ“‹"}),s.jsx("span",{className:"stat-value",children:e.anzahl}),s.jsx("span",{className:"stat-label",children:I(e.aktion)})]},a))]}),S&&s.jsx("div",{className:"filter-panel",children:s.jsxs("div",{className:"filter-row",children:[s.jsxs("div",{className:"filter-group",children:[s.jsx("label",{children:"Suche"}),s.jsxs("div",{className:"search-input",children:[s.jsx(d,{size:16}),s.jsx("input",{type:"text",placeholder:"Name, Email, Beschreibung...",value:_.suchbegriff,onChange:e=>$("suchbegriff",e.target.value)})]})]}),s.jsxs("div",{className:"filter-group",children:[s.jsx("label",{children:"Kategorie"}),s.jsxs("select",{value:_.kategorie,onChange:e=>$("kategorie",e.target.value),children:[s.jsx("option",{value:"",children:"Alle Kategorien"}),f.map(e=>s.jsxs("option",{value:e.value,children:[e.icon," ",e.label]},e.value))]})]}),s.jsxs("div",{className:"filter-group",children:[s.jsx("label",{children:"Von"}),s.jsx("input",{type:"date",value:_.von_datum,onChange:e=>$("von_datum",e.target.value)})]}),s.jsxs("div",{className:"filter-group",children:[s.jsx("label",{children:"Bis"}),s.jsx("input",{type:"date",value:_.bis_datum,onChange:e=>$("bis_datum",e.target.value)})]}),s.jsx("button",{className:"clear-filters",onClick:()=>{y({kategorie:"",suchbegriff:"",von_datum:"",bis_datum:""}),E(0)},children:"Filter zurÃ¼cksetzen"})]})}),s.jsxs("div",{className:"audit-table-container",children:[s.jsxs("table",{className:"audit-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Zeitpunkt"}),s.jsx("th",{children:"Kategorie"}),s.jsx("th",{children:"Aktion"}),s.jsx("th",{children:"Benutzer"}),s.jsx("th",{children:"Betroffener Datensatz"}),s.jsx("th",{children:"Beschreibung"}),s.jsx("th",{})]})}),s.jsx("tbody",{children:x.map(e=>{var a,t;return s.jsxs("tr",{onClick:()=>U(e),children:[s.jsxs("td",{className:"time-cell",children:[s.jsx(o,{size:14}),F(e.created_at)]}),s.jsx("td",{children:s.jsxs("span",{className:"kategorie-badge",style:{backgroundColor:B[e.kategorie]||"#6b7280"},children:[D[e.kategorie]||"ðŸ“‹"," ",e.kategorie]})}),s.jsx("td",{className:"aktion-cell",children:I(e.aktion)}),s.jsxs("td",{className:"user-cell",children:[s.jsx(h,{size:14}),e.user_name||e.user_email||"System"]}),s.jsx("td",{className:"entity-cell",children:e.entity_name||(e.entity_type&&e.entity_id?`${e.entity_type} #${e.entity_id}`:"-")}),s.jsxs("td",{className:"beschreibung-cell",title:e.beschreibung,children:[(null==(a=e.beschreibung)?void 0:a.substring(0,50))||K(e.neue_werte),(null==(t=e.beschreibung)?void 0:t.length)>50?"...":""]}),s.jsx("td",{children:s.jsx("button",{className:"view-btn",onClick:s=>{s.stopPropagation(),U(e)},children:s.jsx(j,{size:16})})})]},e.id)})})]}),0===x.length&&!b&&s.jsxs("div",{className:"empty-state",children:[s.jsx(i,{size:48}),s.jsx("p",{children:"Keine Log-EintrÃ¤ge gefunden"})]}),b&&s.jsxs("div",{className:"loading-state",children:[s.jsx(c,{size:24,className:"spinning"}),s.jsx("p",{children:"Lade Logs..."})]}),C&&!b&&x.length>0&&s.jsx("button",{className:"load-more",onClick:()=>R(!1),children:"Weitere laden"})]}),L&&s.jsx("div",{className:"modal-overlay",onClick:()=>U(null),children:s.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"modal-header",children:[s.jsxs("h3",{children:[D[L.kategorie]," Log-Details"]}),s.jsx("button",{className:"close-btn",onClick:()=>U(null),children:"Ã—"})]}),s.jsx("div",{className:"modal-body",children:s.jsxs("div",{className:"detail-grid",children:[s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Zeitpunkt"}),s.jsx("span",{children:F(L.created_at)})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Kategorie"}),s.jsxs("span",{className:"kategorie-badge",style:{backgroundColor:B[L.kategorie]},children:[D[L.kategorie]," ",L.kategorie]})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Aktion"}),s.jsx("span",{children:I(L.aktion)})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Benutzer"}),s.jsxs("span",{children:[L.user_name||"-",s.jsx("br",{}),s.jsx("small",{children:L.user_email||"-"}),s.jsx("br",{}),s.jsxs("small",{children:["Rolle: ",L.user_role||"-"]})]})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Dojo"}),s.jsx("span",{children:L.dojo_name||`Dojo #${L.dojo_id}`||"-"})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Betroffener Datensatz"}),s.jsxs("span",{children:[L.entity_type||"-"," #",L.entity_id||"-",s.jsx("br",{}),s.jsx("small",{children:L.entity_name||"-"})]})]}),s.jsxs("div",{className:"detail-item full-width",children:[s.jsx("label",{children:"Beschreibung"}),s.jsx("span",{children:L.beschreibung||"-"})]}),L.alte_werte&&s.jsxs("div",{className:"detail-item full-width",children:[s.jsx("label",{children:"Alte Werte"}),s.jsx("pre",{className:"json-display",children:JSON.stringify("string"==typeof L.alte_werte?JSON.parse(L.alte_werte):L.alte_werte,null,2)})]}),L.neue_werte&&s.jsxs("div",{className:"detail-item full-width",children:[s.jsx("label",{children:"Neue Werte"}),s.jsx("pre",{className:"json-display",children:JSON.stringify("string"==typeof L.neue_werte?JSON.parse(L.neue_werte):L.neue_werte,null,2)})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"IP-Adresse"}),s.jsx("span",{children:L.ip_adresse||"-"})]}),s.jsxs("div",{className:"detail-item",children:[s.jsx("label",{children:"Request"}),s.jsxs("span",{children:[L.request_method," ",L.request_path||"-"]})]})]})})]})})]})};export{u as default};
