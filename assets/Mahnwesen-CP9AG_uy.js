import{a as e,j as n}from"./query-Caj74EYQ.js";import{f as s,c as a}from"./index-D4wQygnO.js";import{P as t,c as i,aM as l,R as r,k as d,D as h,q as c,F as o,g as m,M as u,ak as g,aN as j,Q as x}from"./icons-eh0tbLFx.js";import{u as b}from"./vendor-router-B2AaIOtG.js";import"./charts-QHQg_ypW.js";const f=()=>{var f,p,w,N,v,M;const y=b(),[k,z]=e.useState(!0),[F,_]=e.useState([]),[E,S]=e.useState([]),[B,C]=e.useState({}),[$,D]=e.useState("offene"),[U,L]=e.useState(!1),[O,P]=e.useState(null);e.useEffect(()=>{T()},[]);const T=async()=>{try{z(!0);const[e,n,t]=await Promise.all([s(`${a.apiBaseUrl}/mahnwesen/offene-beitraege`),s(`${a.apiBaseUrl}/mahnwesen/mahnungen`),s(`${a.apiBaseUrl}/mahnwesen/statistiken`)]);if(!e.ok||!n.ok||!t.ok)throw new Error("Fehler beim Laden der Mahnwesen-Daten");const i=await e.json(),l=await n.json(),r=await t.json();_(i.data||[]),S(l.data||[]),C(r.data||{}),z(!1)}catch(e){console.error("Fehler beim Laden der Mahnwesen-Daten:",e),z(!1)}},K=async(e=!0)=>{const n=e?"Mahnlauf simulieren? Es werden keine echten Mahnungen erstellt.":"Automatischen Mahnlauf durchfuehren? Es werden echte Mahnungen erstellt!";if(window.confirm(n))try{L(!0),P(null);const n=await s(`${a.apiBaseUrl}/mahnwesen/mahnlauf`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nurSimulation:e})});if(!n.ok)throw new Error("Mahnlauf fehlgeschlagen");const t=await n.json();P(t),e||T()}catch(t){console.error("Fehler beim Mahnlauf:",t),alert("Fehler beim Mahnlauf: "+t.message)}finally{L(!1)}},R=e=>0===e?"info":1===e?"warning":"danger",A=e=>0===e?"Keine Mahnung":1===e?"1. Mahnung":2===e?"2. Mahnung":"3. Mahnung";return k?n.jsx("div",{className:"mahnwesen-container",children:n.jsxs("div",{className:"loading-state",children:[n.jsx("div",{className:"loading-spinner"}),n.jsx("p",{children:"Lade Mahnwesen-Daten..."})]})}):n.jsxs("div",{className:"mahnwesen-container",children:[n.jsxs("div",{className:"mahnwesen-header",children:[n.jsxs("button",{className:"btn btn-secondary",onClick:()=>y("/dashboard/beitraege"),children:[n.jsx(t,{size:20}),"ZurÃ¼ck"]}),n.jsxs("div",{children:[n.jsx("h1",{children:"âš ï¸ Mahnwesen"}),n.jsx("p",{children:"Verwalte offene BeitrÃ¤ge und Mahnungen"})]}),n.jsxs("div",{className:"header-actions",style:{marginLeft:"auto",display:"flex",gap:"0.5rem"},children:[n.jsxs("button",{className:"btn btn-secondary",onClick:()=>y("/dashboard/einstellungen/mahnstufen"),title:"Mahnstufen konfigurieren",children:[n.jsx(i,{size:18}),"Einstellungen"]}),n.jsxs("button",{className:"btn btn-warning",onClick:()=>K(!0),disabled:U,title:"Simuliert den Mahnlauf ohne echte Mahnungen zu erstellen",children:[n.jsx(l,{size:18}),U?"LÃ¤uft...":"Mahnlauf simulieren"]}),n.jsxs("button",{className:"btn btn-danger",onClick:()=>K(!1),disabled:U,title:"Erstellt echte Mahnungen basierend auf den Mahnstufen-Einstellungen",children:[n.jsx(r,{size:18}),"Mahnlauf starten"]})]})]}),O&&n.jsxs("div",{className:"mahnlauf-ergebnis",style:{background:O.simulation?"rgba(251, 191, 36, 0.1)":"rgba(34, 197, 94, 0.1)",border:"1px solid "+(O.simulation?"#f59e0b":"#22c55e"),borderRadius:"12px",padding:"1rem",marginBottom:"1rem"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.5rem"},children:[n.jsx("h3",{style:{margin:0,color:O.simulation?"#f59e0b":"#22c55e"},children:O.simulation?"ðŸ” Simulation":"âœ… Mahnlauf durchgefÃ¼hrt"}),n.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>P(null),style:{padding:"0.25rem 0.5rem"},children:"Ã—"})]}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"1rem",fontSize:"0.9rem"},children:[n.jsxs("div",{children:[n.jsx("strong",{children:"GeprÃ¼ft:"})," ",(null==(f=O.zusammenfassung)?void 0:f.geprueft)||0]}),n.jsxs("div",{style:{color:"#22c55e"},children:[n.jsx("strong",{children:"Neue Mahnungen:"})," ",(null==(p=O.zusammenfassung)?void 0:p.neueMahnungen)||0]}),n.jsxs("div",{style:{color:"#6b7280"},children:[n.jsx("strong",{children:"Ãœbersprungen:"})," ",(null==(w=O.zusammenfassung)?void 0:w.uebersprungen)||0]}),n.jsxs("div",{style:{color:"#ef4444"},children:[n.jsx("strong",{children:"Fehler:"})," ",(null==(N=O.zusammenfassung)?void 0:N.fehler)||0]})]}),(null==(M=null==(v=O.ergebnisse)?void 0:v.neueMahnungen)?void 0:M.length)>0&&n.jsxs("div",{style:{marginTop:"1rem"},children:[n.jsx("strong",{children:"Neue Mahnungen:"}),n.jsxs("ul",{style:{margin:"0.5rem 0",paddingLeft:"1.5rem"},children:[O.ergebnisse.neueMahnungen.slice(0,5).map((e,s)=>n.jsxs("li",{children:[e.mitglied," - ",e.mahnstufe,". Mahnung (â‚¬",parseFloat(e.betrag).toFixed(2),")"]},s)),O.ergebnisse.neueMahnungen.length>5&&n.jsxs("li",{children:["... und ",O.ergebnisse.neueMahnungen.length-5," weitere"]})]})]})]}),n.jsxs("div",{className:"stats-grid",children:[n.jsxs("div",{className:"stat-card warning",children:[n.jsx("div",{className:"stat-icon",children:n.jsx(d,{size:24})}),n.jsxs("div",{className:"stat-info",children:[n.jsx("h3",{children:"Offene BeitrÃ¤ge"}),n.jsx("p",{className:"stat-value",children:B.offene_beitraege||0}),n.jsx("span",{className:"stat-trend",children:"Nicht bezahlt"})]})]}),n.jsxs("div",{className:"stat-card danger",children:[n.jsx("div",{className:"stat-icon",children:n.jsx(h,{size:24})}),n.jsxs("div",{className:"stat-info",children:[n.jsx("h3",{children:"Offene Summe"}),n.jsxs("p",{className:"stat-value",children:["â‚¬",parseFloat(B.offene_summe||0).toFixed(2)]}),n.jsx("span",{className:"stat-trend",children:"Gesamt"})]})]}),n.jsxs("div",{className:"stat-card info",children:[n.jsx("div",{className:"stat-icon",children:n.jsx(c,{size:24})}),n.jsxs("div",{className:"stat-info",children:[n.jsx("h3",{children:"ÃœberfÃ¤llig 30+ Tage"}),n.jsx("p",{className:"stat-value",children:B.ueberfaellig_30_tage||0}),n.jsx("span",{className:"stat-trend",children:"Kritisch"})]})]}),n.jsxs("div",{className:"stat-card success",children:[n.jsx("div",{className:"stat-icon",children:n.jsx(o,{size:24})}),n.jsxs("div",{className:"stat-info",children:[n.jsx("h3",{children:"Mahnungen gesamt"}),n.jsx("p",{className:"stat-value",children:B.anzahl_mahnungen||0}),n.jsxs("span",{className:"stat-trend",children:[B.mahnstufe_1||0," / ",B.mahnstufe_2||0," / ",B.mahnstufe_3||0]})]})]})]}),n.jsxs("div",{className:"view-toggle",children:[n.jsxs("button",{className:"btn-toggle "+("offene"===$?"active":""),onClick:()=>D("offene"),children:[n.jsx(d,{size:18}),"Offene BeitrÃ¤ge (",F.length,")"]}),n.jsxs("button",{className:"btn-toggle "+("mahnungen"===$?"active":""),onClick:()=>D("mahnungen"),children:[n.jsx(o,{size:18}),"Mahnungen (",E.length,")"]})]}),"offene"===$&&n.jsxs("div",{className:"section",children:[n.jsx("div",{className:"section-header",children:n.jsx("h2",{children:"Offene BeitrÃ¤ge"})}),0===F.length?n.jsxs("div",{className:"empty-state",children:[n.jsx(m,{size:48}),n.jsx("p",{children:"Keine offenen BeitrÃ¤ge vorhanden"})]}):n.jsx("div",{className:"table-container",children:n.jsxs("table",{className:"data-table",children:[n.jsx("thead",{children:n.jsxs("tr",{children:[n.jsx("th",{children:"Mitglied"}),n.jsx("th",{children:"Betrag"}),n.jsx("th",{children:"FÃ¤llig seit"}),n.jsx("th",{children:"ÃœberfÃ¤llig"}),n.jsx("th",{children:"Mahnstufe"}),n.jsx("th",{children:"Kontakt"}),n.jsx("th",{children:"Aktionen"})]})}),n.jsx("tbody",{children:F.map(e=>n.jsxs("tr",{children:[n.jsx("td",{children:e.mitglied_name}),n.jsxs("td",{className:"amount",children:["â‚¬",parseFloat(e.betrag).toFixed(2)]}),n.jsx("td",{children:new Date(e.zahlungsdatum).toLocaleDateString("de-DE")}),n.jsxs("td",{className:e.tage_ueberfaellig>30?"critical":"warning",children:[e.tage_ueberfaellig," Tage"]}),n.jsx("td",{children:n.jsx("span",{className:`badge badge-${R(e.mahnstufe)}`,children:A(e.mahnstufe)})}),n.jsxs("td",{className:"contact-info",children:[e.email&&n.jsxs("div",{children:[n.jsx(u,{size:14})," ",e.email]}),e.telefon&&n.jsxs("div",{children:[n.jsx(g,{size:14})," ",e.telefon]})]}),n.jsxs("td",{className:"actions",children:[n.jsxs("button",{className:"btn btn-sm btn-warning",onClick:()=>(async(e,n)=>{if(window.confirm(`Mahnung der Stufe ${n} erstellen?`))try{if(!(await s(`${a.apiBaseUrl}/mahnwesen/mahnungen`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({beitrag_id:e,mahnstufe:n,mahngebuehr:1===n?5:2===n?10:15,versand_art:"email"})})).ok)throw new Error("Fehler beim Erstellen der Mahnung");alert("Mahnung erfolgreich erstellt"),T()}catch(t){console.error("Fehler beim Erstellen der Mahnung:",t),alert("Fehler beim Erstellen der Mahnung")}})(e.beitrag_id,e.mahnstufe+1),disabled:e.mahnstufe>=3,children:[n.jsx(j,{size:14}),"Mahnung"]}),n.jsxs("button",{className:"btn btn-sm btn-success",onClick:()=>(async e=>{if(window.confirm("Beitrag als bezahlt markieren?"))try{if(!(await s(`${a.apiBaseUrl}/mahnwesen/beitraege/${e}/bezahlt`,{method:"PUT"})).ok)throw new Error("Fehler beim Markieren als bezahlt");alert("Beitrag als bezahlt markiert"),T()}catch(n){console.error("Fehler beim Markieren als bezahlt:",n),alert("Fehler beim Markieren als bezahlt")}})(e.beitrag_id),children:[n.jsx(m,{size:14}),"Bezahlt"]})]})]},e.beitrag_id))})]})})]}),"mahnungen"===$&&n.jsxs("div",{className:"section",children:[n.jsx("div",{className:"section-header",children:n.jsx("h2",{children:"Versendete Mahnungen"})}),0===E.length?n.jsxs("div",{className:"empty-state",children:[n.jsx(o,{size:48}),n.jsx("p",{children:"Keine Mahnungen vorhanden"})]}):n.jsx("div",{className:"table-container",children:n.jsxs("table",{className:"data-table",children:[n.jsx("thead",{children:n.jsxs("tr",{children:[n.jsx("th",{children:"Mitglied"}),n.jsx("th",{children:"Beitrag"}),n.jsx("th",{children:"Mahnstufe"}),n.jsx("th",{children:"Mahndatum"}),n.jsx("th",{children:"MahngebÃ¼hr"}),n.jsx("th",{children:"Status"}),n.jsx("th",{children:"Aktionen"})]})}),n.jsx("tbody",{children:E.map(e=>n.jsxs("tr",{children:[n.jsx("td",{children:e.mitglied_name}),n.jsxs("td",{className:"amount",children:["â‚¬",parseFloat(e.beitrag_betrag).toFixed(2)]}),n.jsx("td",{children:n.jsx("span",{className:`badge badge-${R(e.mahnstufe)}`,children:A(e.mahnstufe)})}),n.jsx("td",{children:new Date(e.mahndatum).toLocaleDateString("de-DE")}),n.jsxs("td",{className:"amount",children:["â‚¬",parseFloat(e.mahngebuehr).toFixed(2)]}),n.jsx("td",{children:e.versandt?n.jsx("span",{className:"badge badge-success",children:"Versendet"}):n.jsx("span",{className:"badge badge-warning",children:"Ausstehend"})}),n.jsxs("td",{className:"actions",children:[n.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>(async(e,n)=>{try{const t=await s(`${a.apiBaseUrl}/mahnwesen/mahnungen/${e}/pdf`);if(!t.ok)throw new Error("PDF konnte nicht generiert werden");const i=await t.blob(),l=window.URL.createObjectURL(i),r=document.createElement("a");r.href=l,r.download=`Mahnung_${n.replace(/\s+/g,"_")}.pdf`,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(l),document.body.removeChild(r)}catch(t){console.error("Fehler beim PDF-Download:",t),alert("Fehler beim PDF-Download: "+t.message)}})(e.mahnung_id,e.mitglied_name),title:"PDF herunterladen",children:n.jsx(x,{size:14})}),!e.versandt&&n.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>(async(e,n)=>{if(n){if(window.confirm(`Mahnung per E-Mail an ${n} senden?`))try{const n=await s(`${a.apiBaseUrl}/mahnwesen/mahnungen/${e}/senden`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mitPdf:!0})});if(!n.ok){const e=await n.json();throw new Error(e.error||"E-Mail konnte nicht gesendet werden")}alert("Mahnung erfolgreich versendet!"),T()}catch(t){console.error("Fehler beim Versenden:",t),alert("Fehler beim Versenden: "+t.message)}}else alert("Mitglied hat keine E-Mail-Adresse hinterlegt")})(e.mahnung_id,e.email),title:e.email?`E-Mail an ${e.email}`:"Keine E-Mail hinterlegt",disabled:!e.email,children:n.jsx(j,{size:14})})]})]},e.mahnung_id))})]})})]})]})};export{f as default};
