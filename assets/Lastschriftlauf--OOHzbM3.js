import{a as e,j as s,b as a}from"./query-Caj74EYQ.js";import{u as t,f as r,c as n}from"./index-lGWqIYMX.js";import{P as i,F as l,R as d,k as c,o,D as h,C as m,K as u,j as g,Q as x,L as j,c as p,Z as b,g as f,b as v,a0 as y}from"./icons-C9nQ4cWf.js";import{u as w}from"./vendor-router-B2AaIOtG.js";import"./charts-QHQg_ypW.js";const S=({embedded:S=!1})=>{const k=w(),{activeDojo:N}=t(),z=(null==N?void 0:N.id)||N,[_,A]=e.useState(!1),[E,M]=e.useState(null),[$,C]=e.useState([]),[L,B]=e.useState("csv"),[D,P]=e.useState((new Date).getMonth()+1),[F,I]=e.useState((new Date).getFullYear()),[T,U]=e.useState([]),[V,K]=e.useState(null),[G,J]=e.useState(new Set),[O,R]=e.useState(null),[Z,H]=e.useState(!1),[W,X]=e.useState(null),[q,Q]=e.useState(null),Y=async()=>{try{A(!0);const s=await r(`${n.apiBaseUrl}/lastschriftlauf/preview?monat=${D}&jahr=${F}`);if(!s.ok){let a="Fehler beim Laden der Vorschau";try{const e=await s.json();a=e.details||e.error||a,console.error("‚ùå API Error Response:",e)}catch(e){console.error("‚ùå Response Status:",s.status,s.statusText)}throw new Error(a)}const a=s.headers.get("content-type");if(!a||!a.includes("application/json"))throw new Error("Ung√ºltige Antwort vom Server");const t=await s.json();if(!t.success&&t.error)throw new Error(t.error+(t.details?": "+t.details:""));M(t),A(!1)}catch(s){console.error("‚ùå Fehler beim Laden der Vorschau:",s),console.error("‚ùå Error Stack:",s.stack),alert("Fehler beim Laden der Vorschau: "+s.message),A(!1)}},ee=async()=>{if(z)try{const e=await r(`${n.apiBaseUrl}/lastschriftlauf/stripe/status?dojo_id=${z}`);if(e.ok){const s=await e.json();R(s)}}catch(e){console.error("Fehler beim Laden des Stripe-Status:",e)}};e.useEffect(()=>{(async()=>{try{const e=await r(`${n.apiBaseUrl}/lastschriftlauf/banken`);if(e.ok){const s=(await e.json()).banken||[];U(s);const a=s.find(e=>e.ist_standard)||s[0];a&&!V&&K(a.id)}}catch(e){console.error("Fehler beim Laden der Bankkonten:",e)}})(),(async()=>{try{const e=await r(`${n.apiBaseUrl}/lastschriftlauf/missing-mandates`);if(e.ok){const s=await e.json();C(s.members||[])}}catch(e){console.error("Fehler beim Laden fehlender Mandate:",e)}})(),ee()},[z]),e.useEffect(()=>{Y()},[D,F]);const se=e=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(e||0),ae=e=>["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"][e-1];return s.jsxs("div",{className:"lastschriftlauf-container",children:[!S&&s.jsxs("div",{className:"lastschriftlauf-header",children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>k("/dashboard/beitraege"),style:{padding:"0.4rem 0.75rem",fontSize:"0.85rem"},children:[s.jsx(i,{size:16}),"Zur√ºck"]}),s.jsxs("div",{children:[s.jsx("h1",{children:"üí∂ SEPA-Lastschriftlauf"}),s.jsx("p",{children:"Monatliche Lastschriften generieren und an Bank √ºbermitteln"})]}),s.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>k("/dashboard/zahllaeufe"),style:{padding:"0.4rem 0.75rem",fontSize:"0.85rem"},children:[s.jsx(l,{size:16}),"Zahll√§ufe-√úbersicht"]}),s.jsxs("button",{className:"btn btn-info",onClick:Y,disabled:_,style:{padding:"0.4rem 0.75rem",fontSize:"0.85rem"},children:[s.jsx(d,{size:16}),"Aktualisieren"]})]})]}),s.jsxs("div",{className:"main-layout-container",children:[s.jsxs("div",{className:"left-section",children:[s.jsxs("div",{className:"info-box compact",children:[s.jsx(c,{size:20}),s.jsxs("div",{children:[s.jsx("h3",{children:"SEPA-Lastschriftverfahren"}),s.jsxs("p",{children:["Der Lastschriftlauf generiert eine Datei mit allen aktiven SEPA-Mandaten. Diese Datei kann direkt in Ihre Online-Banking Software oder bei Ihrer Bank importiert werden.",s.jsx("strong",{children:' Nur Mitglieder mit aktivem SEPA-Mandat und Zahlungsmethode "SEPA-Lastschrift" werden ber√ºcksichtigt.'})]})]})]}),E&&s.jsxs("div",{className:"stats-grid-compact",children:[s.jsxs("div",{className:"stat-card success",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(o,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Aktive Mandate"}),s.jsx("p",{className:"stat-value",children:E.count}),s.jsx("span",{className:"stat-trend",children:"SEPA-Lastschriften"})]})]}),s.jsxs("div",{className:"stat-card info",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(h,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Gesamtbetrag"}),s.jsx("p",{className:"stat-value",children:se(E.total_amount)}),s.jsx("span",{className:"stat-trend",children:"Monatlich"})]})]}),s.jsxs("div",{className:"stat-card warning",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(m,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Abrechnungsmonat"}),s.jsx("p",{className:"stat-value",children:ae(D)}),s.jsx("span",{className:"stat-trend",children:F})]})]}),s.jsxs("div",{className:"stat-card positive",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(u,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Bank / Anbieter"}),s.jsx("p",{className:"stat-value",children:E.primary_bank||"Gemischte Banken"}),s.jsx("span",{className:"stat-trend",children:E.count>0?"Export bereit":"Keine Mandate"})]})]})]})]}),$.length>0&&s.jsx("div",{className:"right-section",children:s.jsxs("div",{className:"warning-box",children:[s.jsx(c,{size:24}),s.jsxs("div",{children:[s.jsxs("h3",{children:["‚ö†Ô∏è Fehlende SEPA-Mandate (",$.length,")"]}),s.jsxs("p",{children:['Die folgenden Mitglieder haben Vertr√§ge mit Zahlungsmethode "Lastschrift", aber ',s.jsx("strong",{children:"kein aktives SEPA-Mandat"}),". Lastschriften k√∂nnen f√ºr diese Mitglieder nicht durchgef√ºhrt werden:"]}),s.jsxs("div",{className:"missing-mandates-list",children:[$.slice(0,5).map(e=>s.jsxs("div",{className:"missing-mandate-item",onClick:()=>k(`/dashboard/mitglieder/${e.mitglied_id}`),style:{cursor:"pointer"},children:[s.jsxs("span",{className:"member-name",children:[e.vorname," ",e.nachname," (ID: ",e.mitglied_id,")"]}),s.jsxs("span",{className:"contract-count",children:[e.anzahl_vertraege," Vertrag",e.anzahl_vertraege>1?"e":""]})]},e.mitglied_id)),$.length>5&&s.jsxs("div",{className:"more-info",children:["... und ",$.length-5," weitere"]})]}),s.jsx("button",{className:"logout-button",onClick:()=>k("/dashboard/sepa-mandate"),style:{marginTop:"1rem"},children:"SEPA-Mandate verwalten"})]})]})})]}),s.jsxs("div",{className:"export-config-card",children:[s.jsx("h2",{children:"Export Konfiguration"}),s.jsxs("div",{className:"config-single-row",children:[s.jsxs("div",{className:"form-field-inline",children:[s.jsxs("label",{children:[s.jsx(l,{size:14}),"Export Format"]}),s.jsxs("select",{value:L,onChange:e=>B(e.target.value),className:"form-select-compact",children:[s.jsx("option",{value:"csv",children:"CSV"}),s.jsx("option",{value:"xml",children:"SEPA XML pain.008 (Standard)"})]})]}),s.jsxs("div",{className:"form-field-inline",children:[s.jsxs("label",{children:[s.jsx(m,{size:14}),"Abrechnungsmonat"]}),s.jsx("select",{value:D,onChange:e=>P(parseInt(e.target.value)),className:"form-select-compact",children:[...Array(12)].map((e,a)=>s.jsx("option",{value:a+1,children:ae(a+1)},a+1))})]}),s.jsxs("div",{className:"form-field-inline",children:[s.jsx("label",{children:"Jahr"}),s.jsxs("select",{value:F,onChange:e=>I(parseInt(e.target.value)),className:"form-select-compact",children:[s.jsx("option",{value:2024,children:"2024"}),s.jsx("option",{value:2025,children:"2025"}),s.jsx("option",{value:2026,children:"2026"})]})]}),s.jsxs("div",{className:"form-field-inline",children:[s.jsxs("label",{children:[s.jsx(u,{size:14}),"Einzugsbank"]}),s.jsx("select",{value:V||"",onChange:e=>K(parseInt(e.target.value)),className:"form-select-compact",style:{minWidth:"200px"},children:0===T.length?s.jsx("option",{value:"",children:"Keine Bankkonten verf√ºgbar"}):T.map(e=>s.jsxs("option",{value:e.id,children:[e.dojoname?`[${e.dojoname}] `:"",e.bank_name," (",e.typ_label||e.bank_typ,") ",e.iban_masked,e.ist_standard?" ‚òÖ":""]},e.id))})]}),s.jsxs("button",{className:"logout-button",onClick:Y,disabled:_,style:{whiteSpace:"nowrap"},children:[s.jsx(g,{size:16}),_?"L√§dt...":"Vorschau aktualisieren"]}),s.jsxs("button",{className:"logout-button",onClick:()=>{if(!E||0===E.count)return void alert("Keine Lastschriften zum Exportieren vorhanden");if(!V)return void alert("Bitte w√§hlen Sie ein Bankkonto f√ºr den Einzug aus");const e=T.find(e=>e.id===V),s=e?e.bank_name:"Unbekannt",a=`SEPA-Lastschriftlauf exportieren?\n\nFormat: ${L.toUpperCase()}\nMonat: ${D}/${F}\nEinzugsbank: ${s}\nAnzahl Mandate: ${E.count}\nGesamtbetrag: ‚Ç¨${E.total_amount}\n\nDie Datei wird heruntergeladen und kann in Ihre Banking-Software importiert werden.`;if(!window.confirm(a))return;const t=`?monat=${D}&jahr=${F}&bank_id=${V}`;"csv"===L?window.open(`${n.apiBaseUrl}/lastschriftlauf${t}`,"_blank"):"xml"===L&&window.open(`${n.apiBaseUrl}/lastschriftlauf/xml${t}`,"_blank")},disabled:_||!E||0===E.count,style:{whiteSpace:"nowrap"},children:[s.jsx(x,{size:16}),"Jetzt exportieren"]}),(null==O?void 0:O.stripe_configured)&&s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{borderLeft:"1px solid rgba(255,255,255,0.2)",height:"40px",margin:"0 0.5rem"}}),O.needs_setup>0&&s.jsxs("button",{className:"logout-button",onClick:async()=>{if(window.confirm("Stripe SEPA Setup f√ºr alle Mitglieder ohne Setup durchf√ºhren?\n\nDies erstellt Stripe Customers und SEPA PaymentMethods f√ºr alle Mitglieder mit aktivem SEPA-Mandat.")){H(!0),X({status:"running",message:"Setup wird durchgef√ºhrt..."});try{const e=await r(`${n.apiBaseUrl}/lastschriftlauf/stripe/setup-all`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dojo_id:z})}),s=await e.json();s.success?(X({status:"completed",message:`Setup abgeschlossen: ${s.succeeded} erfolgreich, ${s.failed} fehlgeschlagen`,details:s.details}),await ee()):X({status:"error",message:s.error||"Setup fehlgeschlagen"})}catch(e){X({status:"error",message:"Fehler: "+e.message})}finally{H(!1)}}},disabled:Z,style:{whiteSpace:"nowrap",background:"rgba(99, 102, 241, 0.2)",borderColor:"rgba(99, 102, 241, 0.5)"},title:`${O.needs_setup} Mitglieder ben√∂tigen Stripe Setup`,children:[Z?s.jsx(j,{size:16,className:"spin"}):s.jsx(p,{size:16}),"Stripe Setup (",O.needs_setup,")"]}),s.jsxs("button",{className:"logout-button",onClick:async()=>{if(!E||!E.preview||0===E.preview.length)return void alert("Keine Mitglieder f√ºr den Lastschriftlauf vorhanden");const e=`Stripe SEPA Lastschriftlauf ausf√ºhren?\n\nMonat: ${D}/${F}\nAnzahl Mitglieder: ${E.count}\nGesamtbetrag: ‚Ç¨${E.total_amount}\n\nDie Lastschriften werden direkt √ºber Stripe eingezogen.\nACHTUNG: Dies kann nicht r√ºckg√§ngig gemacht werden!`;if(window.confirm(e)){H(!0),Q(null);try{const e=await r(`${n.apiBaseUrl}/lastschriftlauf/stripe/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dojo_id:z,monat:D,jahr:F,mitglieder:E.preview.map(e=>({mitglied_id:e.mitglied_id,name:e.name,betrag:e.betrag,beitraege:e.beitraege,offene_monate:e.offene_monate}))})}),s=await e.json();s.success?(Q({status:"completed",batch_id:s.batch_id,total:s.total,succeeded:s.succeeded,processing:s.processing,failed:s.failed,transactions:s.transactions}),await Y()):Q({status:"error",message:s.error||"Lastschriftlauf fehlgeschlagen"})}catch(s){Q({status:"error",message:"Fehler: "+s.message})}finally{H(!1)}}},disabled:Z||!E||0===E.count,style:{whiteSpace:"nowrap",background:"rgba(99, 102, 241, 0.3)",borderColor:"rgba(99, 102, 241, 0.6)"},children:[Z?s.jsx(j,{size:16,className:"spin"}):s.jsx(b,{size:16}),"Mit Stripe einziehen"]})]})]}),W&&s.jsx("div",{style:{marginTop:"1rem",padding:"0.75rem 1rem",borderRadius:"8px",background:"error"===W.status?"rgba(239, 68, 68, 0.1)":"completed"===W.status?"rgba(16, 185, 129, 0.1)":"rgba(99, 102, 241, 0.1)",border:"1px solid "+("error"===W.status?"rgba(239, 68, 68, 0.3)":"completed"===W.status?"rgba(16, 185, 129, 0.3)":"rgba(99, 102, 241, 0.3)")},children:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:["running"===W.status&&s.jsx(j,{size:16,className:"spin"}),"completed"===W.status&&s.jsx(f,{size:16,style:{color:"#10b981"}}),"error"===W.status&&s.jsx(c,{size:16,style:{color:"#ef4444"}}),s.jsx("span",{children:W.message}),"running"!==W.status&&s.jsx("button",{onClick:()=>X(null),style:{marginLeft:"auto",background:"none",border:"none",color:"rgba(255,255,255,0.6)",cursor:"pointer"},children:"√ó"})]})}),q&&s.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem 1rem",borderRadius:"8px",background:"error"===q.status?"rgba(239, 68, 68, 0.1)":"rgba(16, 185, 129, 0.1)",border:"1px solid "+("error"===q.status?"rgba(239, 68, 68, 0.3)":"rgba(16, 185, 129, 0.3)")},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:["error"===q.status?s.jsx(c,{size:16,style:{color:"#ef4444"}}):s.jsx(f,{size:16,style:{color:"#10b981"}}),s.jsx("span",{children:"error"===q.status?q.message:`Lastschriftlauf abgeschlossen: ${q.succeeded} erfolgreich, ${q.processing||0} in Verarbeitung, ${q.failed} fehlgeschlagen`})]}),s.jsx("button",{onClick:()=>Q(null),style:{background:"none",border:"none",color:"rgba(255,255,255,0.6)",cursor:"pointer"},children:"√ó"})]}),q.batch_id&&s.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.8rem",color:"rgba(255,255,255,0.6)"},children:["Batch-ID: ",q.batch_id]})]})]}),E&&E.preview&&E.preview.length>0&&s.jsxs("div",{className:"preview-card",children:[s.jsxs("h2",{children:["Vorschau (",E.count," Eintr√§ge) - Gesamtsumme: ",se(E.total_amount)]}),s.jsx("div",{className:"table-container",children:s.jsxs("table",{className:"preview-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{style:{width:"30px"}}),s.jsx("th",{children:"Mitglied"}),s.jsx("th",{children:"IBAN"}),s.jsx("th",{children:"Offene Monate"}),s.jsx("th",{children:"Gesamtbetrag"}),s.jsx("th",{children:"Mandatsreferenz"}),s.jsx("th",{children:"Tarif"})]})}),s.jsx("tbody",{children:E.preview.map((e,t)=>s.jsxs(a.Fragment,{children:[s.jsxs("tr",{children:[s.jsx("td",{style:{textAlign:"center",cursor:"pointer",padding:"0.5rem"},onClick:()=>{return s=e.mitglied_id,void J(e=>{const a=new Set(e);return a.has(s)?a.delete(s):a.add(s),a});var s},children:G.has(e.mitglied_id)?s.jsx(v,{size:18}):s.jsx(y,{size:18})}),s.jsxs("td",{children:[s.jsx("strong",{children:e.name}),s.jsx("br",{}),s.jsxs("small",{children:["ID: ",e.mitglied_id]})]}),s.jsx("td",{children:s.jsx("code",{children:e.iban})}),s.jsxs("td",{children:[s.jsxs("span",{className:"badge badge-warning",style:{marginRight:"0.5rem"},children:[e.anzahl_monate," ",1===e.anzahl_monate?"Monat":"Monate"]}),s.jsx("br",{}),s.jsx("small",{style:{color:"rgba(255,255,255,0.6)"},children:e.offene_monate})]}),s.jsx("td",{children:s.jsx("strong",{style:{color:e.anzahl_monate>1?"#f59e0b":"#10b981"},children:se(e.betrag)})}),s.jsx("td",{children:"KEIN MANDAT"===e.mandatsreferenz?s.jsx("span",{className:"badge badge-danger",children:e.mandatsreferenz}):s.jsx("span",{className:"badge badge-success",children:e.mandatsreferenz})}),s.jsx("td",{children:e.tarif})]}),G.has(e.mitglied_id)&&e.beitraege&&e.beitraege.length>0&&s.jsxs("tr",{className:"details-row",children:[s.jsx("td",{}),s.jsx("td",{colSpan:6,style:{padding:"0.5rem 1rem",backgroundColor:"rgba(255,255,255,0.05)"},children:s.jsxs("div",{style:{fontSize:"0.85rem"},children:[s.jsx("strong",{style:{marginBottom:"0.5rem",display:"block"},children:"Einzelne Beitr√§ge:"}),s.jsxs("table",{style:{width:"100%",marginTop:"0.5rem"},children:[s.jsx("thead",{children:s.jsxs("tr",{style:{fontSize:"0.8rem",color:"rgba(255,255,255,0.7)"},children:[s.jsx("th",{style:{textAlign:"left",padding:"0.25rem"},children:"Beschreibung"}),s.jsx("th",{style:{textAlign:"left",padding:"0.25rem"},children:"Datum"}),s.jsx("th",{style:{textAlign:"right",padding:"0.25rem"},children:"Betrag"})]})}),s.jsx("tbody",{children:e.beitraege.map((e,a)=>s.jsxs("tr",{style:{borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[s.jsx("td",{style:{padding:"0.25rem"},children:e.beschreibung||e.monat}),s.jsx("td",{style:{padding:"0.25rem"},children:e.datum}),s.jsx("td",{style:{padding:"0.25rem",textAlign:"right"},children:se(e.betrag)})]},a))})]})]})})]})]},t))})]})})]}),s.jsxs("div",{className:"hints-card",children:[s.jsx("h3",{children:"üí° Wichtige Hinweise"}),s.jsxs("ul",{children:[s.jsxs("li",{children:[s.jsx("strong",{children:"SEPA-Mandat erforderlich:"})," Es werden nur Mitglieder mit aktivem SEPA-Mandat exportiert."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Vorlaufzeit beachten:"})," SEPA-Lastschriften ben√∂tigen mind. 5 Bankarbeitstage Vorlaufzeit."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Format w√§hlen:"})," CSV f√ºr deutsche Banken, XML f√ºr internationale Standards."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Pr√ºfung durchf√ºhren:"})," Kontrollieren Sie die Vorschau vor dem Export."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Datenschutz:"})," Die exportierte Datei enth√§lt sensible Kontodaten - sicher aufbewahren!"]})]})]})]})};export{S as default};
