import{a as e,j as s,b as a}from"./query-Caj74EYQ.js";import n from"./Lastschriftlauf--OOHzbM3.js";import{f as l,c as t}from"./index-lGWqIYMX.js";import{P as r,C as i,F as c,g as d,q as h,D as o,a7 as u,k as j,b as x,a0 as m,Q as g,U as b,t as f,K as p}from"./icons-C9nQ4cWf.js";import{u as N}from"./vendor-router-B2AaIOtG.js";import"./charts-QHQg_ypW.js";const v=({embedded:n=!1})=>{const p=N(),[v,z]=e.useState(!0),[k,S]=e.useState([]),[w,y]=e.useState([]),[E,L]=e.useState(""),[Z,_]=e.useState("all"),[A,C]=e.useState({}),[F,B]=e.useState({}),[$,q]=e.useState({}),[D,G]=e.useState({gesamt:0,abgeschlossen:0,offen:0,gesamtbetrag:0});e.useEffect(()=>{P()},[]),e.useEffect(()=>{T()},[E,Z,k]);const P=async()=>{try{z(!0);const e=await l(`${t.apiBaseUrl}/zahllaeufe`);if(!e.ok)throw new Error("Fehler beim Laden der Zahll√§ufe");const s=await e.json();S(s.data||[]),K(s.data||[]),z(!1)}catch(e){console.error("Fehler beim Laden der Zahll√§ufe:",e),alert("Fehler beim Laden: "+e.message),z(!1)}},K=e=>{const s={gesamt:e.length,abgeschlossen:e.filter(e=>"abgeschlossen"===e.status).length,offen:e.filter(e=>"offen"===e.status||"geplant"===e.status).length,gesamtbetrag:e.reduce((e,s)=>e+parseFloat(s.betrag||0),0)};G(s)},T=()=>{let e=[...k];if("all"!==Z&&(e=e.filter(e=>e.status===Z)),E){const s=E.toLowerCase();e=e.filter(e=>{var a,n;return(null==(a=e.buchungsnummer)?void 0:a.toLowerCase().includes(s))||(null==(n=e.zahlungsanbieter)?void 0:n.toLowerCase().includes(s))})}y(e)},U=e=>e?new Date(e).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",O=e=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(e),V=e=>{switch(e){case"abgeschlossen":return s.jsxs("span",{className:"badge badge-success",children:[s.jsx(d,{size:14})," Abgeschlossen"]});case"offen":return s.jsxs("span",{className:"badge badge-warning",children:[s.jsx(h,{size:14})," Offen"]});case"geplant":return s.jsxs("span",{className:"badge badge-info",children:[s.jsx(i,{size:14})," Geplant"]});case"fehler":return s.jsxs("span",{className:"badge badge-danger",children:[s.jsx(j,{size:14})," Fehler"]});default:return s.jsx("span",{className:"badge badge-neutral",children:e})}},I=e=>{switch(e){case"succeeded":return s.jsxs("span",{className:"badge badge-success",children:[s.jsx(d,{size:12})," Erfolgreich"]});case"processing":return s.jsxs("span",{className:"badge badge-warning",children:[s.jsx(h,{size:12})," In Bearbeitung"]});case"failed":return s.jsxs("span",{className:"badge badge-danger",children:[s.jsx(f,{size:12})," Fehlgeschlagen"]});case"canceled":return s.jsxs("span",{className:"badge badge-neutral",children:[s.jsx(f,{size:12})," Abgebrochen"]});default:return s.jsx("span",{className:"badge badge-neutral",children:e})}},M=async(e,s)=>{q(e=>({...e,[s]:!0}));try{const a=e.quelle||"sepa",n=await l(`${t.apiBaseUrl}/zahllaeufe/${a}/${e.zahllauf_id}/transaktionen`);if(n.ok){const e=await n.json();B(a=>({...a,[s]:e}))}else console.error("Fehler beim Laden der Transaktionen"),B(e=>({...e,[s]:{transaktionen:[],error:"Fehler beim Laden"}}))}catch(a){console.error("Fehler:",a),B(e=>({...e,[s]:{transaktionen:[],error:a.message}}))}finally{q(e=>({...e,[s]:!1}))}};return v?s.jsx("div",{className:"zahllaeufe-container",children:s.jsxs("div",{className:"loading-state",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Lade Zahll√§ufe..."})]})}):s.jsxs("div",{className:"zahllaeufe-container",children:[!n&&s.jsxs("div",{className:"zahllaeufe-header",children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>p("/dashboard/beitraege"),children:[s.jsx(r,{size:20}),"Zur√ºck"]}),s.jsxs("div",{children:[s.jsx("h1",{children:"üìä Zahll√§ufe √úbersicht"}),s.jsx("p",{children:"Alle durchgef√ºhrten SEPA-Lastschriftl√§ufe im √úberblick"})]}),s.jsxs("button",{className:"btn btn-primary",onClick:()=>p("/dashboard/lastschriftlauf"),children:[s.jsx(i,{size:20}),"Neuer Zahllauf"]})]}),s.jsxs("div",{className:"info-box",children:[s.jsx(c,{size:24}),s.jsxs("div",{children:[s.jsx("h3",{children:"Zahll√§ufe Verwaltung"}),s.jsx("p",{children:"Hier sehen Sie alle durchgef√ºhrten Lastschriftl√§ufe - sowohl klassische SEPA-L√§ufe als auch Stripe SEPA-Einz√ºge. Jeder Zahllauf enth√§lt Status, Buchungen und Betr√§ge."})]})]}),s.jsxs("div",{className:"stats-grid",children:[s.jsxs("div",{className:"stat-card info",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(c,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Gesamt Zahll√§ufe"}),s.jsx("p",{className:"stat-value",children:D.gesamt}),s.jsx("span",{className:"stat-trend",children:"Alle L√§ufe"})]})]}),s.jsxs("div",{className:"stat-card success",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(d,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Abgeschlossen"}),s.jsx("p",{className:"stat-value",children:D.abgeschlossen}),s.jsx("span",{className:"stat-trend",children:"Erfolgreich durchgef√ºhrt"})]})]}),s.jsxs("div",{className:"stat-card warning",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(h,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Offen / Geplant"}),s.jsx("p",{className:"stat-value",children:D.offen}),s.jsx("span",{className:"stat-trend",children:"Noch nicht abgeschlossen"})]})]}),s.jsxs("div",{className:"stat-card primary",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(o,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Gesamtbetrag"}),s.jsx("p",{className:"stat-value",children:O(D.gesamtbetrag)}),s.jsx("span",{className:"stat-trend",children:"Alle Zahll√§ufe"})]})]})]}),s.jsxs("div",{className:"filter-bar",children:[s.jsxs("div",{className:"search-bar",children:[s.jsx(u,{size:20}),s.jsx("input",{type:"text",placeholder:"Suche nach Buchungsnummer oder Anbieter...",value:E,onChange:e=>L(e.target.value)})]}),s.jsxs("select",{value:Z,onChange:e=>_(e.target.value),className:"status-filter",children:[s.jsx("option",{value:"all",children:"Alle Status"}),s.jsx("option",{value:"abgeschlossen",children:"Abgeschlossen"}),s.jsx("option",{value:"offen",children:"Offen"}),s.jsx("option",{value:"geplant",children:"Geplant"}),s.jsx("option",{value:"fehler",children:"Fehler"})]})]}),s.jsx("div",{className:"zahllaeufe-table-container",children:0===w.length?s.jsxs("div",{className:"empty-state",children:[s.jsx(j,{size:64}),s.jsx("h3",{children:"Keine Zahll√§ufe gefunden"}),s.jsxs("p",{children:["all"!==Z&&`Keine Zahll√§ufe mit Status "${Z}" vorhanden.`,E&&`Keine Treffer f√ºr "${E}".`,!Z&&!E&&"Es wurden noch keine Zahll√§ufe erstellt."]}),s.jsx("button",{className:"btn btn-primary",onClick:()=>p("/dashboard/lastschriftlauf"),style:{marginTop:"1rem"},children:"Ersten Zahllauf erstellen"})]}):s.jsxs("table",{className:"zahllaeufe-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{style:{width:"40px"}}),s.jsx("th",{children:"Erstellt am"}),s.jsx("th",{children:"Forderungen bis einschl."}),s.jsx("th",{children:"Geplanter Einzug"}),s.jsx("th",{children:"Zahlungsanbieter"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Buchungsnummer"}),s.jsx("th",{children:"Buchungen"}),s.jsx("th",{children:"RLS-% (Anzahl)"}),s.jsx("th",{children:"Betrag"}),s.jsx("th",{children:"Aktionen"})]})}),s.jsx("tbody",{children:w.map(e=>{var n;const l=`${e.quelle||"sepa"}-${e.zahllauf_id}`,t=A[l],r=F[l],i=$[l];return s.jsxs(a.Fragment,{children:[s.jsxs("tr",{className:t?"row-expanded":"",children:[s.jsx("td",{children:s.jsx("button",{className:"btn-expand",onClick:()=>(async e=>{const s=`${e.quelle||"sepa"}-${e.zahllauf_id}`;A[s]?C(e=>({...e,[s]:!1})):(C(e=>({...e,[s]:!0})),F[s]||await M(e,s))})(e),title:t?"Einklappen":"Details anzeigen",children:t?s.jsx(x,{size:18}):s.jsx(m,{size:18})})}),s.jsx("td",{children:(c=e.erstellt_am,c?new Date(c).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-")}),s.jsx("td",{children:U(e.forderungen_bis)}),s.jsx("td",{children:"stripe"===e.quelle?"-":U(e.geplanter_einzug)}),s.jsx("td",{children:s.jsx("span",{className:"provider-badge "+("stripe"===e.quelle?"provider-stripe":"provider-sepa"),children:"stripe"===e.quelle?"üí≥ Stripe SEPA":e.zahlungsanbieter||"SEPA"})}),s.jsx("td",{children:V(e.status)}),s.jsx("td",{children:s.jsx("code",{children:e.buchungsnummer})}),s.jsx("td",{children:s.jsx("strong",{children:e.anzahl_buchungen||0})}),s.jsxs("td",{children:[e.ruecklastschrift_prozent?`${e.ruecklastschrift_prozent}%`:"0%",e.ruecklastschrift_anzahl>0&&s.jsxs("span",{className:"rls-count",children:[" (",e.ruecklastschrift_anzahl,")"]})]}),s.jsx("td",{children:s.jsx("strong",{children:O(e.betrag)})}),s.jsx("td",{children:s.jsx("div",{className:"action-buttons",children:"stripe"!==e.quelle&&s.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>alert("CSV herunterladen"),title:"CSV herunterladen",children:s.jsx(g,{size:16})})})})]}),t&&s.jsx("tr",{className:"expanded-row",children:s.jsx("td",{colSpan:"11",children:s.jsx("div",{className:"transaktionen-container",children:i?s.jsxs("div",{className:"transaktionen-loading",children:[s.jsx("div",{className:"loading-spinner-small"}),s.jsx("span",{children:"Lade Transaktionen..."})]}):(null==r?void 0:r.hinweis)?s.jsxs("div",{className:"transaktionen-hinweis",children:[s.jsx(j,{size:16}),s.jsx("span",{children:r.hinweis})]}):(null==(n=null==r?void 0:r.transaktionen)?void 0:n.length)>0?s.jsxs("div",{className:"transaktionen-liste",children:[s.jsxs("div",{className:"transaktionen-header",children:[s.jsx(b,{size:16}),s.jsxs("span",{children:[r.count," Mitglieder in diesem Zahllauf"]})]}),s.jsxs("table",{className:"transaktionen-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Mitglied"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Betrag"}),s.jsx("th",{children:"Beitr√§ge"})]})}),s.jsx("tbody",{children:r.transaktionen.map((e,a)=>s.jsxs("tr",{children:[s.jsx("td",{children:s.jsxs("div",{className:"mitglied-info",children:[s.jsxs("strong",{children:[e.vorname," ",e.nachname]}),e.mitgliedsnummer&&s.jsxs("span",{className:"mitgliedsnummer",children:["#",e.mitgliedsnummer]})]})}),s.jsxs("td",{children:[I(e.status),e.error_message&&s.jsxs("div",{className:"error-message",title:e.error_message,children:[e.error_message.substring(0,50),"..."]})]}),s.jsx("td",{children:s.jsx("strong",{children:O(e.betrag)})}),s.jsx("td",{children:e.beitraege&&e.beitraege.length>0?s.jsx("div",{className:"beitraege-liste",children:e.beitraege.map((e,a)=>s.jsxs("div",{className:"beitrag-item",children:[s.jsx("span",{className:"beitrag-datum",children:U(e.zahlungsdatum)}),s.jsx("span",{className:"beitrag-betrag",children:O(e.betrag)}),e.magicline_description&&s.jsx("span",{className:"beitrag-beschreibung",children:e.magicline_description})]},e.beitrag_id||a))}):s.jsx("span",{className:"keine-details",children:"-"})})]},e.transaktion_id||a))})]})]}):s.jsx("div",{className:"transaktionen-leer",children:s.jsx("span",{children:"Keine Transaktionsdetails verf√ºgbar"})})})})})]},l);var c})})]})})]})},z=()=>{const a=N(),[l,t]=e.useState("lastschriftlauf");return s.jsxs("div",{className:"lastschrift-management-container",children:[s.jsxs("div",{className:"management-header",children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>a("/dashboard/beitraege"),children:[s.jsx(r,{size:20}),"Zur√ºck zu Beitr√§ge"]}),s.jsxs("div",{className:"sub-tabs-sidebar-style",children:[s.jsxs("button",{className:"tab-vertical-btn "+("lastschriftlauf"===l?"active":""),onClick:()=>t("lastschriftlauf"),children:[s.jsx("span",{className:"tab-icon",children:s.jsx(p,{size:20})}),s.jsx("span",{className:"tab-label",children:"Neuer Lastschriftlauf"})]}),s.jsxs("button",{className:"tab-vertical-btn "+("zahllaeufe"===l?"active":""),onClick:()=>t("zahllaeufe"),children:[s.jsx("span",{className:"tab-icon",children:s.jsx(c,{size:20})}),s.jsx("span",{className:"tab-label",children:"Zahll√§ufe-√úbersicht"})]})]})]}),s.jsxs("div",{className:"tab-content",children:["lastschriftlauf"===l&&s.jsx(n,{embedded:!0}),"zahllaeufe"===l&&s.jsx(v,{embedded:!0})]})]})};export{z as default};
