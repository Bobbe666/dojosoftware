import{a as e,j as s}from"./query-Caj74EYQ.js";import{f as a,c as n}from"./index-DJzZu8AC.js";import{as as t,F as r,R as l,k as i,o as c,D as d,C as h,a0 as o,j as x,v as m,g as u,w as j,s as f}from"./icons-DiLw-1i5.js";import{u as g}from"./vendor-router-Co3o87Zc.js";import"./charts-C1Gv3M_c.js";const b=({embedded:u=!1})=>{const j=g(),[f,b]=e.useState(!1),[p,v]=e.useState(null),[N,z]=e.useState([]),[w,k]=e.useState("csv"),[S,y]=e.useState((new Date).getMonth()+1),[E,A]=e.useState((new Date).getFullYear()),L=async()=>{try{b(!0);const s=await a(`${n.apiBaseUrl}/lastschriftlauf/preview`);if(!s.ok){let a="Fehler beim Laden der Vorschau";try{const e=await s.json();a=e.details||e.error||a,console.error("‚ùå API Error Response:",e)}catch(e){console.error("‚ùå Response Status:",s.status,s.statusText)}throw new Error(a)}const t=s.headers.get("content-type");if(!t||!t.includes("application/json"))throw new Error("Ung√ºltige Antwort vom Server");const r=await s.json();if(!r.success&&r.error)throw new Error(r.error+(r.details?": "+r.details:""));v(r),b(!1)}catch(s){console.error("‚ùå Fehler beim Laden der Vorschau:",s),console.error("‚ùå Error Stack:",s.stack),alert("Fehler beim Laden der Vorschau: "+s.message),b(!1)}};e.useEffect(()=>{L(),(async()=>{try{const e=await a(`${n.apiBaseUrl}/lastschriftlauf/missing-mandates`);if(e.ok){const s=await e.json();z(s.members||[])}}catch(e){console.error("Fehler beim Laden fehlender Mandate:",e)}})()},[]);const C=e=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(e||0),D=e=>["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"][e-1];return s.jsxs("div",{className:"lastschriftlauf-container",children:[!u&&s.jsxs("div",{className:"lastschriftlauf-header",children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>j("/dashboard/beitraege"),style:{padding:"0.4rem 0.75rem",fontSize:"0.85rem"},children:[s.jsx(t,{size:16}),"Zur√ºck"]}),s.jsxs("div",{children:[s.jsx("h1",{children:"üí∂ SEPA-Lastschriftlauf"}),s.jsx("p",{children:"Monatliche Lastschriften generieren und an Bank √ºbermitteln"})]}),s.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>j("/dashboard/zahllaeufe"),style:{padding:"0.4rem 0.75rem",fontSize:"0.85rem"},children:[s.jsx(r,{size:16}),"Zahll√§ufe-√úbersicht"]}),s.jsxs("button",{className:"btn btn-info",onClick:L,disabled:f,style:{padding:"0.4rem 0.75rem",fontSize:"0.85rem"},children:[s.jsx(l,{size:16}),"Aktualisieren"]})]})]}),s.jsxs("div",{className:"main-layout-container",children:[s.jsxs("div",{className:"left-section",children:[s.jsxs("div",{className:"info-box compact",children:[s.jsx(i,{size:20}),s.jsxs("div",{children:[s.jsx("h3",{children:"SEPA-Lastschriftverfahren"}),s.jsxs("p",{children:["Der Lastschriftlauf generiert eine Datei mit allen aktiven SEPA-Mandaten. Diese Datei kann direkt in Ihre Online-Banking Software oder bei Ihrer Bank importiert werden.",s.jsx("strong",{children:' Nur Mitglieder mit aktivem SEPA-Mandat und Zahlungsmethode "SEPA-Lastschrift" werden ber√ºcksichtigt.'})]})]})]}),p&&s.jsxs("div",{className:"stats-grid-compact",children:[s.jsxs("div",{className:"stat-card success",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(c,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Aktive Mandate"}),s.jsx("p",{className:"stat-value",children:p.count}),s.jsx("span",{className:"stat-trend",children:"SEPA-Lastschriften"})]})]}),s.jsxs("div",{className:"stat-card info",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(d,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Gesamtbetrag"}),s.jsx("p",{className:"stat-value",children:C(p.total_amount)}),s.jsx("span",{className:"stat-trend",children:"Monatlich"})]})]}),s.jsxs("div",{className:"stat-card warning",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(h,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Abrechnungsmonat"}),s.jsx("p",{className:"stat-value",children:D(S)}),s.jsx("span",{className:"stat-trend",children:E})]})]}),s.jsxs("div",{className:"stat-card positive",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(o,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Bank / Anbieter"}),s.jsx("p",{className:"stat-value",children:p.primary_bank||"Gemischte Banken"}),s.jsx("span",{className:"stat-trend",children:p.count>0?"Export bereit":"Keine Mandate"})]})]})]})]}),N.length>0&&s.jsx("div",{className:"right-section",children:s.jsxs("div",{className:"warning-box",children:[s.jsx(i,{size:24}),s.jsxs("div",{children:[s.jsxs("h3",{children:["‚ö†Ô∏è Fehlende SEPA-Mandate (",N.length,")"]}),s.jsxs("p",{children:['Die folgenden Mitglieder haben Vertr√§ge mit Zahlungsmethode "Lastschrift", aber ',s.jsx("strong",{children:"kein aktives SEPA-Mandat"}),". Lastschriften k√∂nnen f√ºr diese Mitglieder nicht durchgef√ºhrt werden:"]}),s.jsxs("div",{className:"missing-mandates-list",children:[N.slice(0,5).map(e=>s.jsxs("div",{className:"missing-mandate-item",onClick:()=>j(`/dashboard/mitglieder/${e.mitglied_id}`),style:{cursor:"pointer"},children:[s.jsxs("span",{className:"member-name",children:[e.vorname," ",e.nachname," (ID: ",e.mitglied_id,")"]}),s.jsxs("span",{className:"contract-count",children:[e.anzahl_vertraege," Vertrag",e.anzahl_vertraege>1?"e":""]})]},e.mitglied_id)),N.length>5&&s.jsxs("div",{className:"more-info",children:["... und ",N.length-5," weitere"]})]}),s.jsx("button",{className:"logout-button",onClick:()=>j("/dashboard/sepa-mandate"),style:{marginTop:"1rem"},children:"SEPA-Mandate verwalten"})]})]})})]}),s.jsxs("div",{className:"export-config-card",children:[s.jsx("h2",{children:"Export Konfiguration"}),s.jsxs("div",{className:"config-single-row",children:[s.jsxs("div",{className:"form-field-inline",children:[s.jsxs("label",{children:[s.jsx(r,{size:14}),"Export Format"]}),s.jsxs("select",{value:w,onChange:e=>k(e.target.value),className:"form-select-compact",children:[s.jsx("option",{value:"csv",children:"CSV"}),s.jsx("option",{value:"xml",children:"SEPA XML pain.008 (Standard)"})]})]}),s.jsxs("div",{className:"form-field-inline",children:[s.jsxs("label",{children:[s.jsx(h,{size:14}),"Abrechnungsmonat"]}),s.jsx("select",{value:S,onChange:e=>y(parseInt(e.target.value)),className:"form-select-compact",children:[...Array(12)].map((e,a)=>s.jsx("option",{value:a+1,children:D(a+1)},a+1))})]}),s.jsxs("div",{className:"form-field-inline",children:[s.jsx("label",{children:"Jahr"}),s.jsxs("select",{value:E,onChange:e=>A(parseInt(e.target.value)),className:"form-select-compact",children:[s.jsx("option",{value:2024,children:"2024"}),s.jsx("option",{value:2025,children:"2025"}),s.jsx("option",{value:2026,children:"2026"})]})]}),s.jsxs("button",{className:"logout-button",onClick:L,disabled:f,style:{whiteSpace:"nowrap"},children:[s.jsx(x,{size:16}),f?"L√§dt...":"Vorschau aktualisieren"]}),s.jsxs("button",{className:"logout-button",onClick:()=>{if(!p||0===p.count)return void alert("Keine Lastschriften zum Exportieren vorhanden");const e=`SEPA-Lastschriftlauf exportieren?\n\nFormat: ${w.toUpperCase()}\nMonat: ${S}/${E}\nAnzahl Mandate: ${p.count}\nGesamtbetrag: ‚Ç¨${p.total_amount}\n\nDie Datei wird heruntergeladen und kann in Ihre Banking-Software importiert werden.`;window.confirm(e)&&("csv"===w?window.open(`${n.apiBaseUrl}/lastschriftlauf`,"_blank"):"xml"===w&&window.open(`${n.apiBaseUrl}/lastschriftlauf/xml`,"_blank"))},disabled:f||!p||0===p.count,style:{whiteSpace:"nowrap"},children:[s.jsx(m,{size:16}),"Jetzt exportieren"]})]})]}),p&&p.preview&&p.preview.length>0&&s.jsxs("div",{className:"preview-card",children:[s.jsxs("h2",{children:["Vorschau (",p.count," Eintr√§ge)"]}),s.jsx("div",{className:"table-container",children:s.jsxs("table",{className:"preview-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Mitglied"}),s.jsx("th",{children:"IBAN"}),s.jsx("th",{children:"Betrag"}),s.jsx("th",{children:"Mandatsreferenz"}),s.jsx("th",{children:"Tarif"}),s.jsx("th",{children:"Zyklus"})]})}),s.jsx("tbody",{children:p.preview.map((e,a)=>s.jsxs("tr",{children:[s.jsxs("td",{children:[s.jsx("strong",{children:e.name}),s.jsx("br",{}),s.jsxs("small",{children:["ID: ",e.mitglied_id]})]}),s.jsx("td",{children:s.jsx("code",{children:e.iban})}),s.jsx("td",{children:s.jsx("strong",{style:{color:"#10b981"},children:C(e.betrag)})}),s.jsx("td",{children:"KEIN MANDAT"===e.mandatsreferenz?s.jsx("span",{className:"badge badge-danger",children:e.mandatsreferenz}):s.jsx("span",{className:"badge badge-success",children:e.mandatsreferenz})}),s.jsx("td",{children:e.tarif}),s.jsx("td",{children:s.jsx("span",{className:"badge badge-info",children:e.zahlungszyklus||"monatlich"})})]},a))})]})})]}),s.jsxs("div",{className:"hints-card",children:[s.jsx("h3",{children:"üí° Wichtige Hinweise"}),s.jsxs("ul",{children:[s.jsxs("li",{children:[s.jsx("strong",{children:"SEPA-Mandat erforderlich:"})," Es werden nur Mitglieder mit aktivem SEPA-Mandat exportiert."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Vorlaufzeit beachten:"})," SEPA-Lastschriften ben√∂tigen mind. 5 Bankarbeitstage Vorlaufzeit."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Format w√§hlen:"})," CSV f√ºr deutsche Banken, XML f√ºr internationale Standards."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Pr√ºfung durchf√ºhren:"})," Kontrollieren Sie die Vorschau vor dem Export."]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Datenschutz:"})," Die exportierte Datei enth√§lt sensible Kontodaten - sicher aufbewahren!"]})]})]})]})},p=({embedded:l=!1})=>{const c=g(),[o,b]=e.useState(!0),[p,v]=e.useState([]),[N,z]=e.useState([]),[w,k]=e.useState(""),[S,y]=e.useState("all"),[E,A]=e.useState({gesamt:0,abgeschlossen:0,offen:0,gesamtbetrag:0});e.useEffect(()=>{L()},[]),e.useEffect(()=>{D()},[w,S,p]);const L=async()=>{try{b(!0);const e=await a(`${n.apiBaseUrl}/zahllaeufe`);if(!e.ok)throw new Error("Fehler beim Laden der Zahll√§ufe");const s=await e.json();v(s.data||[]),C(s.data||[]),b(!1)}catch(e){console.error("Fehler beim Laden der Zahll√§ufe:",e),alert("Fehler beim Laden: "+e.message),b(!1)}},C=e=>{const s={gesamt:e.length,abgeschlossen:e.filter(e=>"abgeschlossen"===e.status).length,offen:e.filter(e=>"offen"===e.status||"geplant"===e.status).length,gesamtbetrag:e.reduce((e,s)=>e+parseFloat(s.betrag||0),0)};A(s)},D=()=>{let e=[...p];if("all"!==S&&(e=e.filter(e=>e.status===S)),w){const s=w.toLowerCase();e=e.filter(e=>{var a,n;return(null==(a=e.buchungsnummer)?void 0:a.toLowerCase().includes(s))||(null==(n=e.zahlungsanbieter)?void 0:n.toLowerCase().includes(s))})}z(e)},M=e=>e?new Date(e).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",B=e=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(e),Z=e=>{switch(e){case"abgeschlossen":return s.jsxs("span",{className:"badge badge-success",children:[s.jsx(u,{size:14})," Abgeschlossen"]});case"offen":return s.jsxs("span",{className:"badge badge-warning",children:[s.jsx(j,{size:14})," Offen"]});case"geplant":return s.jsxs("span",{className:"badge badge-info",children:[s.jsx(h,{size:14})," Geplant"]});case"fehler":return s.jsxs("span",{className:"badge badge-danger",children:[s.jsx(i,{size:14})," Fehler"]});default:return s.jsx("span",{className:"badge badge-neutral",children:e})}};return o?s.jsx("div",{className:"zahllaeufe-container",children:s.jsxs("div",{className:"loading-state",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Lade Zahll√§ufe..."})]})}):s.jsxs("div",{className:"zahllaeufe-container",children:[!l&&s.jsxs("div",{className:"zahllaeufe-header",children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>c("/dashboard/beitraege"),children:[s.jsx(t,{size:20}),"Zur√ºck"]}),s.jsxs("div",{children:[s.jsx("h1",{children:"üìä Zahll√§ufe √úbersicht"}),s.jsx("p",{children:"Alle durchgef√ºhrten SEPA-Lastschriftl√§ufe im √úberblick"})]}),s.jsxs("button",{className:"btn btn-primary",onClick:()=>c("/dashboard/lastschriftlauf"),children:[s.jsx(h,{size:20}),"Neuer Zahllauf"]})]}),s.jsxs("div",{className:"info-box",children:[s.jsx(r,{size:24}),s.jsxs("div",{children:[s.jsx("h3",{children:"Zahll√§ufe Verwaltung"}),s.jsx("p",{children:"Hier sehen Sie alle durchgef√ºhrten SEPA-Lastschriftl√§ufe mit Status, Buchungen und Betr√§gen. Jeder Zahllauf enth√§lt die Mandate-Informationen und kann heruntergeladen werden."})]})]}),s.jsxs("div",{className:"stats-grid",children:[s.jsxs("div",{className:"stat-card info",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(r,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Gesamt Zahll√§ufe"}),s.jsx("p",{className:"stat-value",children:E.gesamt}),s.jsx("span",{className:"stat-trend",children:"Alle L√§ufe"})]})]}),s.jsxs("div",{className:"stat-card success",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(u,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Abgeschlossen"}),s.jsx("p",{className:"stat-value",children:E.abgeschlossen}),s.jsx("span",{className:"stat-trend",children:"Erfolgreich durchgef√ºhrt"})]})]}),s.jsxs("div",{className:"stat-card warning",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(j,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Offen / Geplant"}),s.jsx("p",{className:"stat-value",children:E.offen}),s.jsx("span",{className:"stat-trend",children:"Noch nicht abgeschlossen"})]})]}),s.jsxs("div",{className:"stat-card primary",children:[s.jsx("div",{className:"stat-icon",children:s.jsx(d,{size:16})}),s.jsxs("div",{className:"stat-info",children:[s.jsx("h3",{children:"Gesamtbetrag"}),s.jsx("p",{className:"stat-value",children:B(E.gesamtbetrag)}),s.jsx("span",{className:"stat-trend",children:"Alle Zahll√§ufe"})]})]})]}),s.jsxs("div",{className:"filter-bar",children:[s.jsxs("div",{className:"search-bar",children:[s.jsx(f,{size:20}),s.jsx("input",{type:"text",placeholder:"Suche nach Buchungsnummer oder Anbieter...",value:w,onChange:e=>k(e.target.value)})]}),s.jsxs("select",{value:S,onChange:e=>y(e.target.value),className:"status-filter",children:[s.jsx("option",{value:"all",children:"Alle Status"}),s.jsx("option",{value:"abgeschlossen",children:"Abgeschlossen"}),s.jsx("option",{value:"offen",children:"Offen"}),s.jsx("option",{value:"geplant",children:"Geplant"}),s.jsx("option",{value:"fehler",children:"Fehler"})]})]}),s.jsx("div",{className:"zahllaeufe-table-container",children:0===N.length?s.jsxs("div",{className:"empty-state",children:[s.jsx(i,{size:64}),s.jsx("h3",{children:"Keine Zahll√§ufe gefunden"}),s.jsxs("p",{children:["all"!==S&&`Keine Zahll√§ufe mit Status "${S}" vorhanden.`,w&&`Keine Treffer f√ºr "${w}".`,!S&&!w&&"Es wurden noch keine Zahll√§ufe erstellt."]}),s.jsx("button",{className:"btn btn-primary",onClick:()=>c("/dashboard/lastschriftlauf"),style:{marginTop:"1rem"},children:"Ersten Zahllauf erstellen"})]}):s.jsxs("table",{className:"zahllaeufe-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Erstellt am"}),s.jsx("th",{children:"Forderungen bis einschl."}),s.jsx("th",{children:"Geplanter Einzug"}),s.jsx("th",{children:"Zahlungsanbieter"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Buchungsnummer"}),s.jsx("th",{children:"Buchungen"}),s.jsx("th",{children:"RLS-% (Anzahl)"}),s.jsx("th",{children:"Betrag"}),s.jsx("th",{children:"Aktionen"})]})}),s.jsx("tbody",{children:N.map(e=>{return s.jsxs("tr",{children:[s.jsx("td",{children:(a=e.erstellt_am,a?new Date(a).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-")}),s.jsx("td",{children:M(e.forderungen_bis)}),s.jsx("td",{children:M(e.geplanter_einzug)}),s.jsx("td",{children:e.zahlungsanbieter||"-"}),s.jsx("td",{children:Z(e.status)}),s.jsx("td",{children:s.jsx("code",{children:e.buchungsnummer})}),s.jsx("td",{children:s.jsx("strong",{children:e.anzahl_buchungen||0})}),s.jsx("td",{children:e.ruecklastschrift_prozent?`${e.ruecklastschrift_prozent}%`:"0%"}),s.jsx("td",{children:s.jsx("strong",{children:B(e.betrag)})}),s.jsx("td",{children:s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"btn-icon btn-info",onClick:()=>alert("Details anzeigen"),title:"Details anzeigen",children:s.jsx(x,{size:16})}),s.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>alert("CSV herunterladen"),title:"CSV herunterladen",children:s.jsx(m,{size:16})})]})})]},e.zahllauf_id);var a})})]})})]})},v=()=>{const a=g(),[n,l]=e.useState("lastschriftlauf");return s.jsxs("div",{className:"lastschrift-management-container",children:[s.jsxs("div",{className:"management-header",children:[s.jsxs("button",{className:"btn btn-secondary",onClick:()=>a("/dashboard/beitraege"),children:[s.jsx(t,{size:20}),"Zur√ºck zu Beitr√§ge"]}),s.jsxs("div",{className:"sub-tabs-sidebar-style",children:[s.jsxs("button",{className:"tab-vertical-btn "+("lastschriftlauf"===n?"active":""),onClick:()=>l("lastschriftlauf"),children:[s.jsx("span",{className:"tab-icon",children:s.jsx(o,{size:20})}),s.jsx("span",{className:"tab-label",children:"Neuer Lastschriftlauf"})]}),s.jsxs("button",{className:"tab-vertical-btn "+("zahllaeufe"===n?"active":""),onClick:()=>l("zahllaeufe"),children:[s.jsx("span",{className:"tab-icon",children:s.jsx(r,{size:20})}),s.jsx("span",{className:"tab-label",children:"Zahll√§ufe-√úbersicht"})]})]})]}),s.jsxs("div",{className:"tab-content",children:["lastschriftlauf"===n&&s.jsx(b,{embedded:!0}),"zahllaeufe"===n&&s.jsx(p,{embedded:!0})]})]})};export{v as default};
