import{j as e}from"./animation-1wuIdCBS.js";import{r as a}from"./vendor-router-BhMXg4Z-.js";import{b as s,c as n}from"./index-DUnH23_2.js";/* empty css                      */import{ap as r,$ as i}from"./icons-D7rg4pDH.js";import"./vendor-react-DtuzQOD1.js";import"./query-Bs1dTGah.js";const t=({kunde:t,onClose:l,checkin_id:c})=>{const{activeDojo:d}=s(),[o,m]=a.useState([]),[h,u]=a.useState([]),[g,v]=a.useState([]),[k,p]=a.useState(!0),[x,j]=a.useState(null),[_,b]=a.useState("bar"),[f,N]=a.useState(""),[y,w]=a.useState(t?`${t.vorname} ${t.nachname}`:""),[C,S]=a.useState(t?t.mitglied_id:""),[F,z]=a.useState(""),[$,E]=a.useState(null),[q,A]=a.useState(!1),[B,K]=a.useState(!1),[M,L]=a.useState(null),[T,D]=a.useState([]),[O,P]=a.useState(null),[V,I]=a.useState(!1),[W,Z]=a.useState(null),[G,H]=a.useState({groesse:"",farbe:"",material:"",preiskategorie:""}),R=a.useMemo(()=>((e=[])=>{const a=new Map;return e.forEach(e=>{var s;if(!e)return;const n=e.mitglied_id||`${e.vorname||""}-${e.nachname||""}-${e.checkin_id}`;a.has(n)||a.set(n,{mitglied_id:e.mitglied_id,vorname:e.vorname,nachname:e.nachname,full_name:e.full_name||`${e.vorname||""} ${e.nachname||""}`.trim(),mitgliedsnummer:e.mitgliedsnummer,foto_pfad:e.foto_pfad,gurtfarbe:e.gurtfarbe,kurse:[],checkins:[],primaryCheckin:e});const r=a.get(n);r.kurse.push({kurs_name:e.kurs_name,kurs_zeit:e.kurs_zeit,checkin_time:e.checkin_time,stundenplan_id:e.stundenplan_id,anwesenheits_typ:e.anwesenheits_typ}),r.checkins.push(e),e.checkin_time&&(!(null==(s=r.primaryCheckin)?void 0:s.checkin_time)||new Date(e.checkin_time)<new Date(r.primaryCheckin.checkin_time))&&(r.primaryCheckin=e)}),Array.from(a.values())})(T),[T]),U=e=>{if(!e)return P(null),void(t||(w(""),S("")));const a=e.full_name||`${e.vorname||""} ${e.nachname||""}`.trim();P(e),w(a),S(e.mitglied_id||"")};a.useEffect(()=>{t&&U(t)},[t]),a.useEffect(()=>{if(!(null==O?void 0:O.mitglied_id))return;const e=R.find(e=>e.mitglied_id===O.mitglied_id);e&&e!==O&&U(e)},[R]);const J=async(e,a={})=>{try{const r=n.apiBaseUrl,i=localStorage.getItem("dojo_auth_token")||localStorage.getItem("authToken"),t=await fetch(`${r}${e}`,{headers:{"Content-Type":"application/json",...i&&{Authorization:`Bearer ${i}`},...a.headers},...a});if(!t.ok){let e=`HTTP error! status: ${t.status}`;try{const a=await t.json();a.error&&(e=a.error)}catch(s){}throw new Error(e)}return await t.json()}catch(r){throw console.error("API Error:",r),r}},Q=async()=>{try{if(0===g.length)return void j("Warenkorb ist leer");const e={mitglied_id:C||null,kunde_name:y||null,artikel:g.map(e=>({artikel_id:e.artikel_id,menge:e.menge,einzelpreis_cent:Math.round(100*(e.verkaufspreis_euro||0))})),zahlungsart:_,gegeben_cent:"bar"===_?Math.round(100*parseFloat(f)):null,bemerkung:F||null,verkauft_von_name:"Kassierer",dojo_id:(null==d?void 0:d.id)||null,checkin_id:c||null},a=await J("/verkaeufe",{method:"POST",body:JSON.stringify(e)});a.success?(L(a),K(!0),v([]),N(""),w(""),S(""),z(""),A(!1),j(null),setTimeout(()=>{K(!1),L(null)},3e3)):j(a.error||"Fehler beim Verkauf")}catch(e){j("Fehler beim Verkauf: "+e.message)}},X=()=>{if(!W)return;const e=W,a=[G.groesse,G.farbe,G.material,G.preiskategorie].filter(Boolean).join("-"),s=`${e.artikel_id}-${a||"default"}`;let n=e.verkaufspreis_cent,r=e.verkaufspreis_euro;e.hat_preiskategorien&&G.preiskategorie&&("kids"===G.preiskategorie&&e.preis_kids_cent?(n=e.preis_kids_cent,r=e.preis_kids_euro):"erwachsene"===G.preiskategorie&&e.preis_erwachsene_cent&&(n=e.preis_erwachsene_cent,r=e.preis_erwachsene_euro));const i=[G.groesse&&`Gr. ${G.groesse}`,G.farbe,G.material,G.preiskategorie&&("kids"===G.preiskategorie?"Kids":"Erwachsene")].filter(Boolean).join(", "),t={...e,unique_id:s,verkaufspreis_cent:n,verkaufspreis_euro:r,name:i?`${e.name} (${i})`:e.name,original_name:e.name,variante:{...G}};v(e=>e.find(e=>e.unique_id===s)?e.map(e=>e.unique_id===s?{...e,menge:e.menge+1}:e):[...e,{...t,menge:1}]),I(!1),Z(null)},Y=e=>{e.verfuegbar?v(a=>a.find(a=>a.artikel_id===e.artikel_id&&!a.unique_id)?a.map(a=>a.artikel_id!==e.artikel_id||a.unique_id?a:{...a,menge:a.menge+1}):[...a,{...e,menge:1}]):j("Artikel nicht verfÃ¼gbar")},ee=()=>{v([])},ae=g.reduce((e,a)=>{const s=a.mwst_prozent||19,n=(a.verkaufspreis_euro||0)*a.menge,r=n/(1+s/100),i=n-r;return e[s]||(e[s]={netto:0,steuer:0,brutto:0}),e[s].netto+=r,e[s].steuer+=i,e[s].brutto+=n,e},{}),se=g.reduce((e,a)=>e+(a.verkaufspreis_euro||0)*a.menge,0),ne=Object.values(ae).reduce((e,a)=>e+a.netto,0);Object.values(ae).reduce((e,a)=>e+a.steuer,0);const re="bar"===_&&f?Math.max(0,parseFloat(f)-se):0;a.useEffect(()=>{(async()=>{var e;try{p(!0);const a=await J("/artikel/kasse");m(a.data||[]);const s=(null==(e=a.data)?void 0:e.map(e=>({kategorie_id:e.kategorie_id,name:e.name,farbe_hex:e.farbe_hex,icon:e.icon,artikel:e.artikel})))||[];u(s)}catch(a){j("Fehler beim Laden der Artikel: "+a.message)}finally{p(!1)}})(),(async()=>{try{const e=(await J("/checkin/today")).checkins||[];D(e)}catch(e){console.error("Fehler beim Laden der Check-ins fÃ¼r die Kasse:",e)}})()},[]);return k?e.jsx("div",{className:"verkauf-kasse",children:e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Kasse wird geladen..."})]})}):B?e.jsx("div",{className:"erfolg-modal",children:e.jsxs("div",{className:"erfolg-content",children:[e.jsx("div",{className:"erfolg-icon",children:"âœ…"}),e.jsx("h3",{children:"Verkauf erfolgreich!"}),e.jsxs("p",{children:["Bon-Nummer: ",e.jsx("strong",{children:null==M?void 0:M.bon_nummer})]}),e.jsxs("p",{children:["Betrag: ",e.jsxs("strong",{children:[null==(ie=null==M?void 0:M.brutto_gesamt_euro)?void 0:ie.toFixed(2),"â‚¬"]})]}),(null==M?void 0:M.rueckgeld_euro)>0&&e.jsxs("p",{children:["RÃ¼ckgeld: ",e.jsxs("strong",{children:[M.rueckgeld_euro.toFixed(2),"â‚¬"]})]}),e.jsx("button",{className:"btn btn-primary",onClick:()=>K(!1),children:"Weiter verkaufen"})]})}):e.jsxs("div",{className:"checkin-system",children:[e.jsx("div",{className:"checkin-header",children:e.jsxs("div",{className:"checkin-header-content",children:[e.jsxs("div",{className:"step-header",children:[e.jsx("div",{className:"checkin-logo",children:e.jsx(r,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{className:"checkin-title",children:"Kassensystem"}),e.jsxs("div",{className:"checkin-subtitle",children:[e.jsxs("span",{children:["Verkauf fÃ¼r ",y]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:(new Date).toLocaleDateString("de-DE",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]})]})]}),e.jsxs("button",{className:"close-kasse-button",onClick:l,title:"ZurÃ¼ck zum Check-in Terminal",children:[e.jsx(i,{size:24}),e.jsx("span",{children:"SchlieÃŸen"})]})]})}),e.jsxs("div",{className:"checkin-container compact",children:[R.length>0&&e.jsxs("div",{className:"kasse-checkins-leiste",children:[e.jsxs("div",{className:"kasse-checkins-header",children:[e.jsx("h3",{children:"Heute eingecheckt"}),e.jsx("span",{children:R.length})]}),e.jsx("div",{className:"kasse-checkins-grid",children:R.map(a=>{var s,n;const r=a.full_name||`${a.vorname||""} ${a.nachname||""}`.trim()||"Unbekannt",i=(null==O?void 0:O.mitglied_id)&&O.mitglied_id===a.mitglied_id,t=((null==(s=a.vorname)?void 0:s[0])||"")+((null==(n=a.nachname)?void 0:n[0])||"");return e.jsxs("button",{type:"button",className:"kasse-checkin-card "+(i?"active":""),onClick:()=>U(a),children:[e.jsx("div",{className:"avatar",children:a.foto_pfad?e.jsx("img",{src:`http://localhost:3000/${a.foto_pfad}`,alt:r,onError:e=>{e.currentTarget.style.display="none"}}):t||"ðŸ‘¤"}),e.jsx("div",{className:"info",children:e.jsx("div",{className:"name",children:r})})]},a.mitglied_id||r)})})]}),x&&e.jsxs("div",{className:"message error",children:[e.jsx(i,{size:24}),e.jsx("span",{children:x})]}),e.jsxs("div",{className:"kasse-layout",children:[e.jsxs("div",{className:"kategorien-sidebar",children:[e.jsx("button",{className:"kategorie-button "+($?"":"active"),onClick:()=>E(null),children:"Alle Artikel"}),h.map(a=>e.jsxs("button",{className:"kategorie-button "+($===a.kategorie_id?"active":""),onClick:()=>E(a.kategorie_id),style:{borderLeftColor:a.farbe_hex},children:[e.jsx("span",{className:"kategorie-icon",children:a.icon}),a.name]},a.kategorie_id))]}),e.jsx("div",{className:"artikel-section",children:(()=>{const a=$?h.find(e=>e.kategorie_id===$):null,s=a?a.artikel:h.flatMap(e=>e.artikel);return e.jsx("div",{className:"artikel-grid",children:s.map(a=>{const s=a.hat_varianten&&(a.varianten_groessen&&a.varianten_groessen.length>0||a.varianten_farben&&a.varianten_farben.length>0||a.varianten_material&&a.varianten_material.length>0||a.hat_preiskategorien);return e.jsxs("button",{className:`artikel-button ${a.verfuegbar?"":"disabled"} ${s?"has-variants":""}`,onClick:()=>(e=>{if(!e.verfuegbar)return void j("Artikel nicht verfÃ¼gbar");e.hat_varianten&&(e.varianten_groessen&&e.varianten_groessen.length>0||e.varianten_farben&&e.varianten_farben.length>0||e.varianten_material&&e.varianten_material.length>0||e.hat_preiskategorien)?(Z(e),H({groesse:"",farbe:"",material:"",preiskategorie:""}),I(!0)):Y(e)})(a),disabled:!a.verfuegbar,children:[e.jsxs("div",{className:"artikel-bild",children:[a.bild_url?e.jsx("img",{src:a.bild_url,alt:a.name}):e.jsx("div",{className:"artikel-placeholder",children:"ðŸ“¦"}),s&&e.jsx("span",{className:"variant-badge",children:"Varianten"})]}),e.jsxs("div",{className:"artikel-info",children:[e.jsx("div",{className:"artikel-name",children:a.name}),e.jsxs("div",{className:"artikel-preis",children:[a.verkaufspreis_euro.toFixed(2),"â‚¬",s&&a.hat_preiskategorien&&e.jsx("span",{className:"preis-hinweis",children:" (ab)"})]}),a.lager_tracking&&e.jsxs("div",{className:"artikel-lager",children:["Lager: ",a.lagerbestand]})]})]},a.artikel_id)})})})()}),e.jsxs("div",{className:"warenkorb-section",children:[e.jsxs("div",{className:"warenkorb",children:[e.jsxs("div",{className:"warenkorb-header",children:[e.jsx("h3",{children:"Warenkorb"}),e.jsx("button",{className:"btn btn-sm btn-danger",onClick:ee,disabled:0===g.length,children:"ðŸ—‘ï¸ Leeren"})]}),e.jsx("div",{className:"warenkorb-items",children:g.map(a=>{var s;return e.jsxs("div",{className:"warenkorb-item",children:[e.jsxs("div",{className:"item-info",children:[e.jsx("div",{className:"item-name",children:a.name}),e.jsxs("div",{className:"item-details",children:[e.jsxs("span",{className:"item-preis",children:[(null==(s=a.verkaufspreis_euro)?void 0:s.toFixed(2))||"0.00","â‚¬"]}),e.jsx("span",{className:"item-separator",children:"Ã—"}),e.jsx("span",{className:"item-menge-display",children:a.menge})]})]}),e.jsxs("div",{className:"item-summe",children:[((a.verkaufspreis_euro||0)*a.menge).toFixed(2),"â‚¬"]}),e.jsx("button",{className:"item-remove-btn",onClick:()=>((e,a=null)=>{v(s=>s.filter(s=>a?s.unique_id!==a:s.artikel_id!==e||s.unique_id))})(a.artikel_id,a.unique_id),title:"Entfernen",children:"Ã—"})]},a.unique_id||a.artikel_id)})}),g.length>0&&e.jsxs("div",{className:"warenkorb-summe",children:[e.jsxs("div",{className:"summe-row",children:[e.jsx("span",{children:"Netto:"}),e.jsxs("span",{children:[ne.toFixed(2),"â‚¬"]})]}),Object.keys(ae).sort().map(a=>e.jsxs("div",{className:"summe-row tax",children:[e.jsxs("span",{children:["MwSt. ",parseFloat(a).toFixed(0),"%:"]}),e.jsxs("span",{children:[ae[a].steuer.toFixed(2),"â‚¬"]})]},a)),e.jsxs("div",{className:"summe-row total",children:[e.jsx("span",{children:"Gesamt (Brutto):"}),e.jsxs("span",{children:[se.toFixed(2),"â‚¬"]})]})]})]}),g.length>0&&e.jsxs("button",{className:"btn btn-primary btn-large",onClick:()=>A(!0),children:["Zur Kasse (",se.toFixed(2),"â‚¬)"]})]})]}),q&&e.jsx("div",{className:"zahlung-modal",children:e.jsxs("div",{className:"zahlung-content",children:[e.jsx("h3",{children:"Zahlung"}),e.jsxs("div",{className:"zahlungsart-selection",children:[e.jsxs("label",{className:"zahlungsart-option",children:[e.jsx("input",{type:"radio",name:"zahlungsart",value:"bar",checked:"bar"===_,onChange:e=>b(e.target.value)}),e.jsx("span",{children:"ðŸ’µ Bar"})]}),e.jsxs("label",{className:"zahlungsart-option",children:[e.jsx("input",{type:"radio",name:"zahlungsart",value:"karte",checked:"karte"===_,onChange:e=>b(e.target.value)}),e.jsx("span",{children:"ðŸ’³ Karte"})]}),e.jsxs("label",{className:"zahlungsart-option",children:[e.jsx("input",{type:"radio",name:"zahlungsart",value:"digital",checked:"digital"===_,onChange:e=>b(e.target.value)}),e.jsx("span",{children:"ðŸ’³ Lastschrift"})]})]}),"bar"===_&&e.jsx("div",{className:"bar-zahlung",children:e.jsxs("div",{className:"betrag-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Zu zahlen (â‚¬):"}),e.jsx("input",{type:"text",value:se.toFixed(2),readOnly:!0,className:"betrag-readonly"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Gegebener Betrag (â‚¬):"}),e.jsx("input",{type:"number",value:f,onChange:e=>N(e.target.value),step:"0.01",min:se,placeholder:se.toFixed(2)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"RÃ¼ckgeld (â‚¬):"}),e.jsx("div",{className:"rueckgeld-inline",children:re>0?re.toFixed(2):"0.00"})]})]})}),e.jsxs("div",{className:"zahlung-form-section",children:[e.jsxs("div",{className:"kunde-mitglied-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Kunde:"}),e.jsx("input",{type:"text",value:y,onChange:e=>w(e.target.value),placeholder:"Name des Kunden"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Mitgliedsnummer:"}),e.jsx("input",{type:"text",value:C,onChange:e=>S(e.target.value),placeholder:"Mitgliedsnummer"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Bemerkung:"}),e.jsx("textarea",{value:F,onChange:e=>z(e.target.value),placeholder:"ZusÃ¤tzliche Informationen",rows:"2"})]})]}),e.jsxs("div",{className:"zahlung-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>A(!1),children:"Abbrechen"}),e.jsx("button",{className:"btn btn-primary",onClick:Q,disabled:"bar"===_&&parseFloat(f)<se,children:"Verkauf abschlieÃŸen"})]})]})}),(()=>{var a,s,n,r;if(!V||!W)return null;const i=W,t=i.varianten_groessen&&i.varianten_groessen.length>0,l=i.varianten_farben&&i.varianten_farben.length>0,c=i.varianten_material&&i.varianten_material.length>0,d=i.hat_preiskategorien;let o=i.varianten_groessen||[];d&&G.preiskategorie&&("kids"===G.preiskategorie&&(null==(a=i.groessen_kids)?void 0:a.length)>0?o=i.groessen_kids:"erwachsene"===G.preiskategorie&&(null==(s=i.groessen_erwachsene)?void 0:s.length)>0&&(o=i.groessen_erwachsene));const m=(!t||G.groesse)&&(!l||G.farbe)&&(!c||G.material)&&(!d||G.preiskategorie);let h=i.verkaufspreis_euro;return d&&"kids"===G.preiskategorie&&i.preis_kids_euro?h=i.preis_kids_euro:d&&"erwachsene"===G.preiskategorie&&i.preis_erwachsene_euro&&(h=i.preis_erwachsene_euro),e.jsx("div",{className:"varianten-modal-overlay",onClick:()=>I(!1),children:e.jsxs("div",{className:"varianten-modal",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"varianten-modal-header",children:[e.jsx("h3",{children:i.name}),e.jsx("button",{className:"modal-close-btn",onClick:()=>I(!1),children:"Ã—"})]}),e.jsxs("div",{className:"varianten-modal-content",children:[d&&e.jsxs("div",{className:"varianten-section",children:[e.jsx("label",{children:"Preiskategorie:"}),e.jsxs("div",{className:"varianten-options",children:[i.preis_kids_cent&&e.jsxs("button",{type:"button",className:"variante-btn "+("kids"===G.preiskategorie?"selected":""),onClick:()=>H(e=>({...e,preiskategorie:"kids",groesse:""})),children:["Kids - ",null==(n=i.preis_kids_euro)?void 0:n.toFixed(2),"â‚¬"]}),i.preis_erwachsene_cent&&e.jsxs("button",{type:"button",className:"variante-btn "+("erwachsene"===G.preiskategorie?"selected":""),onClick:()=>H(e=>({...e,preiskategorie:"erwachsene",groesse:""})),children:["Erwachsene - ",null==(r=i.preis_erwachsene_euro)?void 0:r.toFixed(2),"â‚¬"]})]})]}),t&&o.length>0&&e.jsxs("div",{className:"varianten-section",children:[e.jsx("label",{children:"GrÃ¶ÃŸe:"}),e.jsx("div",{className:"varianten-options groessen-grid",children:o.map(a=>e.jsx("button",{type:"button",className:"variante-btn "+(G.groesse===a?"selected":""),onClick:()=>H(e=>({...e,groesse:a})),children:a},a))})]}),l&&e.jsxs("div",{className:"varianten-section",children:[e.jsx("label",{children:"Farbe:"}),e.jsx("div",{className:"varianten-options",children:i.varianten_farben.map((a,s)=>{const n="object"==typeof a?a.name:a,r="object"==typeof a?a.hex:null;return e.jsx("button",{type:"button",className:"variante-btn "+(G.farbe===n?"selected":""),onClick:()=>H(e=>({...e,farbe:n})),style:r?{borderLeftColor:r,borderLeftWidth:"4px"}:{},children:n},n||s)})})]}),c&&e.jsxs("div",{className:"varianten-section",children:[e.jsx("label",{children:"Material:"}),e.jsx("div",{className:"varianten-options",children:i.varianten_material.map((a,s)=>{const n="object"==typeof a?a.name:a;return e.jsx("button",{type:"button",className:"variante-btn "+(G.material===n?"selected":""),onClick:()=>H(e=>({...e,material:n})),children:n},n||s)})})]}),e.jsxs("div",{className:"varianten-preis",children:[e.jsx("span",{children:"Preis:"}),e.jsxs("span",{className:"preis-wert",children:[null==h?void 0:h.toFixed(2),"â‚¬"]})]})]}),e.jsxs("div",{className:"varianten-modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>I(!1),children:"Abbrechen"}),e.jsx("button",{className:"btn btn-primary",onClick:X,disabled:!m,children:"In den Warenkorb"})]})]})})})()]})]});var ie};export{t as default};
