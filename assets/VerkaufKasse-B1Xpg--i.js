import{a as e,j as a}from"./query-Caj74EYQ.js";import{b as s,c as n}from"./index-DJzZu8AC.js";/* empty css                      */import{ax as r,X as i}from"./icons-DiLw-1i5.js";import"./vendor-router-Co3o87Zc.js";import"./charts-C1Gv3M_c.js";const t=({kunde:t,onClose:l,checkin_id:c})=>{const{activeDojo:d}=s(),[o,m]=e.useState([]),[h,u]=e.useState([]),[g,v]=e.useState([]),[k,x]=e.useState(!0),[p,j]=e.useState(null),[_,b]=e.useState("bar"),[f,N]=e.useState(""),[y,w]=e.useState(t?`${t.vorname} ${t.nachname}`:""),[C,S]=e.useState(t?t.mitglied_id:""),[F,z]=e.useState(""),[$,E]=e.useState(null),[q,A]=e.useState(!1),[B,K]=e.useState(!1),[M,L]=e.useState(null),[T,D]=e.useState([]),[O,P]=e.useState(null),[V,I]=e.useState(!1),[W,Z]=e.useState(null),[G,H]=e.useState({groesse:"",farbe:"",material:"",preiskategorie:""}),J=e.useMemo(()=>((e=[])=>{const a=new Map;return e.forEach(e=>{var s;if(!e)return;const n=e.mitglied_id||`${e.vorname||""}-${e.nachname||""}-${e.checkin_id}`;a.has(n)||a.set(n,{mitglied_id:e.mitglied_id,vorname:e.vorname,nachname:e.nachname,full_name:e.full_name||`${e.vorname||""} ${e.nachname||""}`.trim(),mitgliedsnummer:e.mitgliedsnummer,foto_pfad:e.foto_pfad,gurtfarbe:e.gurtfarbe,kurse:[],checkins:[],primaryCheckin:e});const r=a.get(n);r.kurse.push({kurs_name:e.kurs_name,kurs_zeit:e.kurs_zeit,checkin_time:e.checkin_time,stundenplan_id:e.stundenplan_id,anwesenheits_typ:e.anwesenheits_typ}),r.checkins.push(e),e.checkin_time&&(!(null==(s=r.primaryCheckin)?void 0:s.checkin_time)||new Date(e.checkin_time)<new Date(r.primaryCheckin.checkin_time))&&(r.primaryCheckin=e)}),Array.from(a.values())})(T),[T]),R=e=>{if(!e)return P(null),void(t||(w(""),S("")));const a=e.full_name||`${e.vorname||""} ${e.nachname||""}`.trim();P(e),w(a),S(e.mitglied_id||"")};e.useEffect(()=>{t&&R(t)},[t]),e.useEffect(()=>{if(!(null==O?void 0:O.mitglied_id))return;const e=J.find(e=>e.mitglied_id===O.mitglied_id);e&&e!==O&&R(e)},[J]);const U=async(e,a={})=>{try{const r=n.apiBaseUrl,i=localStorage.getItem("dojo_auth_token")||localStorage.getItem("authToken"),t=await fetch(`${r}${e}`,{headers:{"Content-Type":"application/json",...i&&{Authorization:`Bearer ${i}`},...a.headers},...a});if(!t.ok){let e=`HTTP error! status: ${t.status}`;try{const a=await t.json();a.error&&(e=a.error)}catch(s){}throw new Error(e)}return await t.json()}catch(r){throw console.error("API Error:",r),r}},Q=async()=>{try{if(0===g.length)return void j("Warenkorb ist leer");const e={mitglied_id:C||null,kunde_name:y||null,artikel:g.map(e=>({artikel_id:e.artikel_id,menge:e.menge,einzelpreis_cent:Math.round(100*(e.verkaufspreis_euro||0))})),zahlungsart:_,gegeben_cent:"bar"===_?Math.round(100*parseFloat(f)):null,bemerkung:F||null,verkauft_von_name:"Kassierer",dojo_id:(null==d?void 0:d.id)||null,checkin_id:c||null},a=await U("/verkaeufe",{method:"POST",body:JSON.stringify(e)});a.success?(L(a),K(!0),v([]),N(""),w(""),S(""),z(""),A(!1),j(null),setTimeout(()=>{K(!1),L(null)},3e3)):j(a.error||"Fehler beim Verkauf")}catch(e){j("Fehler beim Verkauf: "+e.message)}},X=()=>{if(!W)return;const e=W,a=[G.groesse,G.farbe,G.material,G.preiskategorie].filter(Boolean).join("-"),s=`${e.artikel_id}-${a||"default"}`;let n=e.verkaufspreis_cent,r=e.verkaufspreis_euro;e.hat_preiskategorien&&G.preiskategorie&&("kids"===G.preiskategorie&&e.preis_kids_cent?(n=e.preis_kids_cent,r=e.preis_kids_euro):"erwachsene"===G.preiskategorie&&e.preis_erwachsene_cent&&(n=e.preis_erwachsene_cent,r=e.preis_erwachsene_euro));const i=[G.groesse&&`Gr. ${G.groesse}`,G.farbe,G.material,G.preiskategorie&&("kids"===G.preiskategorie?"Kids":"Erwachsene")].filter(Boolean).join(", "),t={...e,unique_id:s,verkaufspreis_cent:n,verkaufspreis_euro:r,name:i?`${e.name} (${i})`:e.name,original_name:e.name,variante:{...G}};v(e=>e.find(e=>e.unique_id===s)?e.map(e=>e.unique_id===s?{...e,menge:e.menge+1}:e):[...e,{...t,menge:1}]),I(!1),Z(null)},Y=e=>{e.verfuegbar?v(a=>a.find(a=>a.artikel_id===e.artikel_id&&!a.unique_id)?a.map(a=>a.artikel_id!==e.artikel_id||a.unique_id?a:{...a,menge:a.menge+1}):[...a,{...e,menge:1}]):j("Artikel nicht verfÃ¼gbar")},ee=()=>{v([])},ae=g.reduce((e,a)=>{const s=a.mwst_prozent||19,n=(a.verkaufspreis_euro||0)*a.menge,r=n/(1+s/100),i=n-r;return e[s]||(e[s]={netto:0,steuer:0,brutto:0}),e[s].netto+=r,e[s].steuer+=i,e[s].brutto+=n,e},{}),se=g.reduce((e,a)=>e+(a.verkaufspreis_euro||0)*a.menge,0),ne=Object.values(ae).reduce((e,a)=>e+a.netto,0);Object.values(ae).reduce((e,a)=>e+a.steuer,0);const re="bar"===_&&f?Math.max(0,parseFloat(f)-se):0;e.useEffect(()=>{(async()=>{var e;try{x(!0);const a=await U("/artikel/kasse");m(a.data||[]);const s=(null==(e=a.data)?void 0:e.map(e=>({kategorie_id:e.kategorie_id,name:e.name,farbe_hex:e.farbe_hex,icon:e.icon,artikel:e.artikel})))||[];u(s)}catch(a){j("Fehler beim Laden der Artikel: "+a.message)}finally{x(!1)}})(),(async()=>{try{const e=(await U("/checkin/today")).checkins||[];D(e)}catch(e){console.error("Fehler beim Laden der Check-ins fÃ¼r die Kasse:",e)}})()},[]);return k?a.jsx("div",{className:"verkauf-kasse",children:a.jsxs("div",{className:"loading-container",children:[a.jsx("div",{className:"loading-spinner"}),a.jsx("p",{children:"Kasse wird geladen..."})]})}):B?a.jsx("div",{className:"erfolg-modal",children:a.jsxs("div",{className:"erfolg-content",children:[a.jsx("div",{className:"erfolg-icon",children:"âœ…"}),a.jsx("h3",{children:"Verkauf erfolgreich!"}),a.jsxs("p",{children:["Bon-Nummer: ",a.jsx("strong",{children:null==M?void 0:M.bon_nummer})]}),a.jsxs("p",{children:["Betrag: ",a.jsxs("strong",{children:[null==(ie=null==M?void 0:M.brutto_gesamt_euro)?void 0:ie.toFixed(2),"â‚¬"]})]}),(null==M?void 0:M.rueckgeld_euro)>0&&a.jsxs("p",{children:["RÃ¼ckgeld: ",a.jsxs("strong",{children:[M.rueckgeld_euro.toFixed(2),"â‚¬"]})]}),a.jsx("button",{className:"btn btn-primary",onClick:()=>K(!1),children:"Weiter verkaufen"})]})}):a.jsxs("div",{className:"checkin-system",children:[a.jsx("div",{className:"checkin-header",children:a.jsxs("div",{className:"checkin-header-content",children:[a.jsxs("div",{className:"step-header",children:[a.jsx("div",{className:"checkin-logo",children:a.jsx(r,{size:24})}),a.jsxs("div",{children:[a.jsx("h1",{className:"checkin-title",children:"Kassensystem"}),a.jsxs("div",{className:"checkin-subtitle",children:[a.jsxs("span",{children:["Verkauf fÃ¼r ",y]}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:(new Date).toLocaleDateString("de-DE",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]})]})]}),a.jsxs("button",{className:"close-kasse-button",onClick:l,title:"ZurÃ¼ck zum Check-in Terminal",children:[a.jsx(i,{size:24}),a.jsx("span",{children:"SchlieÃŸen"})]})]})}),a.jsxs("div",{className:"checkin-container compact",children:[J.length>0&&a.jsxs("div",{className:"kasse-checkins-leiste",children:[a.jsxs("div",{className:"kasse-checkins-header",children:[a.jsx("h3",{children:"Heute eingecheckt"}),a.jsx("span",{children:J.length})]}),a.jsx("div",{className:"kasse-checkins-grid",children:J.map(e=>{var s,n;const r=e.full_name||`${e.vorname||""} ${e.nachname||""}`.trim()||"Unbekannt",i=(null==O?void 0:O.mitglied_id)&&O.mitglied_id===e.mitglied_id,t=((null==(s=e.vorname)?void 0:s[0])||"")+((null==(n=e.nachname)?void 0:n[0])||"");return a.jsxs("button",{type:"button",className:"kasse-checkin-card "+(i?"active":""),onClick:()=>R(e),children:[a.jsx("div",{className:"avatar",children:e.foto_pfad?a.jsx("img",{src:`http://localhost:3000/${e.foto_pfad}`,alt:r,onError:e=>{e.currentTarget.style.display="none"}}):t||"ðŸ‘¤"}),a.jsx("div",{className:"info",children:a.jsx("div",{className:"name",children:r})})]},e.mitglied_id||r)})})]}),p&&a.jsxs("div",{className:"message error",children:[a.jsx(i,{size:24}),a.jsx("span",{children:p})]}),a.jsxs("div",{className:"kasse-layout",children:[a.jsxs("div",{className:"kategorien-sidebar",children:[a.jsx("button",{className:"kategorie-button "+($?"":"active"),onClick:()=>E(null),children:"Alle Artikel"}),h.map(e=>a.jsxs("button",{className:"kategorie-button "+($===e.kategorie_id?"active":""),onClick:()=>E(e.kategorie_id),style:{borderLeftColor:e.farbe_hex},children:[a.jsx("span",{className:"kategorie-icon",children:e.icon}),e.name]},e.kategorie_id))]}),a.jsx("div",{className:"artikel-section",children:(()=>{const e=$?h.find(e=>e.kategorie_id===$):null,s=e?e.artikel:h.flatMap(e=>e.artikel);return a.jsx("div",{className:"artikel-grid",children:s.map(e=>{const s=e.hat_varianten&&(e.varianten_groessen&&e.varianten_groessen.length>0||e.varianten_farben&&e.varianten_farben.length>0||e.varianten_material&&e.varianten_material.length>0||e.hat_preiskategorien);return a.jsxs("button",{className:`artikel-button ${e.verfuegbar?"":"disabled"} ${s?"has-variants":""}`,onClick:()=>(e=>{if(!e.verfuegbar)return void j("Artikel nicht verfÃ¼gbar");e.hat_varianten&&(e.varianten_groessen&&e.varianten_groessen.length>0||e.varianten_farben&&e.varianten_farben.length>0||e.varianten_material&&e.varianten_material.length>0||e.hat_preiskategorien)?(Z(e),H({groesse:"",farbe:"",material:"",preiskategorie:""}),I(!0)):Y(e)})(e),disabled:!e.verfuegbar,children:[a.jsxs("div",{className:"artikel-bild",children:[e.bild_url?a.jsx("img",{src:e.bild_url,alt:e.name}):a.jsx("div",{className:"artikel-placeholder",children:"ðŸ“¦"}),s&&a.jsx("span",{className:"variant-badge",children:"Varianten"})]}),a.jsxs("div",{className:"artikel-info",children:[a.jsx("div",{className:"artikel-name",children:e.name}),a.jsxs("div",{className:"artikel-preis",children:[e.verkaufspreis_euro.toFixed(2),"â‚¬",s&&e.hat_preiskategorien&&a.jsx("span",{className:"preis-hinweis",children:" (ab)"})]}),e.lager_tracking&&a.jsxs("div",{className:"artikel-lager",children:["Lager: ",e.lagerbestand]})]})]},e.artikel_id)})})})()}),a.jsxs("div",{className:"warenkorb-section",children:[a.jsxs("div",{className:"warenkorb",children:[a.jsxs("div",{className:"warenkorb-header",children:[a.jsx("h3",{children:"Warenkorb"}),a.jsx("button",{className:"btn btn-sm btn-danger",onClick:ee,disabled:0===g.length,children:"ðŸ—‘ï¸ Leeren"})]}),a.jsx("div",{className:"warenkorb-items",children:g.map(e=>{var s;return a.jsxs("div",{className:"warenkorb-item",children:[a.jsxs("div",{className:"item-info",children:[a.jsx("div",{className:"item-name",children:e.name}),a.jsxs("div",{className:"item-details",children:[a.jsxs("span",{className:"item-preis",children:[(null==(s=e.verkaufspreis_euro)?void 0:s.toFixed(2))||"0.00","â‚¬"]}),a.jsx("span",{className:"item-separator",children:"Ã—"}),a.jsx("span",{className:"item-menge-display",children:e.menge})]})]}),a.jsxs("div",{className:"item-summe",children:[((e.verkaufspreis_euro||0)*e.menge).toFixed(2),"â‚¬"]}),a.jsx("button",{className:"item-remove-btn",onClick:()=>((e,a=null)=>{v(s=>s.filter(s=>a?s.unique_id!==a:s.artikel_id!==e||s.unique_id))})(e.artikel_id,e.unique_id),title:"Entfernen",children:"Ã—"})]},e.unique_id||e.artikel_id)})}),g.length>0&&a.jsxs("div",{className:"warenkorb-summe",children:[a.jsxs("div",{className:"summe-row",children:[a.jsx("span",{children:"Netto:"}),a.jsxs("span",{children:[ne.toFixed(2),"â‚¬"]})]}),Object.keys(ae).sort().map(e=>a.jsxs("div",{className:"summe-row tax",children:[a.jsxs("span",{children:["MwSt. ",parseFloat(e).toFixed(0),"%:"]}),a.jsxs("span",{children:[ae[e].steuer.toFixed(2),"â‚¬"]})]},e)),a.jsxs("div",{className:"summe-row total",children:[a.jsx("span",{children:"Gesamt (Brutto):"}),a.jsxs("span",{children:[se.toFixed(2),"â‚¬"]})]})]})]}),g.length>0&&a.jsxs("button",{className:"btn btn-primary btn-large",onClick:()=>A(!0),children:["Zur Kasse (",se.toFixed(2),"â‚¬)"]})]})]}),q&&a.jsx("div",{className:"zahlung-modal",children:a.jsxs("div",{className:"zahlung-content",children:[a.jsx("h3",{children:"Zahlung"}),a.jsxs("div",{className:"zahlungsart-selection",children:[a.jsxs("label",{className:"zahlungsart-option",children:[a.jsx("input",{type:"radio",name:"zahlungsart",value:"bar",checked:"bar"===_,onChange:e=>b(e.target.value)}),a.jsx("span",{children:"ðŸ’µ Bar"})]}),a.jsxs("label",{className:"zahlungsart-option",children:[a.jsx("input",{type:"radio",name:"zahlungsart",value:"karte",checked:"karte"===_,onChange:e=>b(e.target.value)}),a.jsx("span",{children:"ðŸ’³ Karte"})]}),a.jsxs("label",{className:"zahlungsart-option",children:[a.jsx("input",{type:"radio",name:"zahlungsart",value:"digital",checked:"digital"===_,onChange:e=>b(e.target.value)}),a.jsx("span",{children:"ðŸ’³ Lastschrift"})]})]}),"bar"===_&&a.jsx("div",{className:"bar-zahlung",children:a.jsxs("div",{className:"betrag-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"Zu zahlen (â‚¬):"}),a.jsx("input",{type:"text",value:se.toFixed(2),readOnly:!0,className:"betrag-readonly"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"Gegebener Betrag (â‚¬):"}),a.jsx("input",{type:"number",value:f,onChange:e=>N(e.target.value),step:"0.01",min:se,placeholder:se.toFixed(2)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"RÃ¼ckgeld (â‚¬):"}),a.jsx("div",{className:"rueckgeld-inline",children:re>0?re.toFixed(2):"0.00"})]})]})}),a.jsxs("div",{className:"zahlung-form-section",children:[a.jsxs("div",{className:"kunde-mitglied-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"Kunde:"}),a.jsx("input",{type:"text",value:y,onChange:e=>w(e.target.value),placeholder:"Name des Kunden"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"Mitgliedsnummer:"}),a.jsx("input",{type:"text",value:C,onChange:e=>S(e.target.value),placeholder:"Mitgliedsnummer"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"Bemerkung:"}),a.jsx("textarea",{value:F,onChange:e=>z(e.target.value),placeholder:"ZusÃ¤tzliche Informationen",rows:"2"})]})]}),a.jsxs("div",{className:"zahlung-actions",children:[a.jsx("button",{className:"btn btn-secondary",onClick:()=>A(!1),children:"Abbrechen"}),a.jsx("button",{className:"btn btn-primary",onClick:Q,disabled:"bar"===_&&parseFloat(f)<se,children:"Verkauf abschlieÃŸen"})]})]})}),(()=>{var e,s,n,r;if(!V||!W)return null;const i=W,t=i.varianten_groessen&&i.varianten_groessen.length>0,l=i.varianten_farben&&i.varianten_farben.length>0,c=i.varianten_material&&i.varianten_material.length>0,d=i.hat_preiskategorien;let o=i.varianten_groessen||[];d&&G.preiskategorie&&("kids"===G.preiskategorie&&(null==(e=i.groessen_kids)?void 0:e.length)>0?o=i.groessen_kids:"erwachsene"===G.preiskategorie&&(null==(s=i.groessen_erwachsene)?void 0:s.length)>0&&(o=i.groessen_erwachsene));const m=(!t||G.groesse)&&(!l||G.farbe)&&(!c||G.material)&&(!d||G.preiskategorie);let h=i.verkaufspreis_euro;return d&&"kids"===G.preiskategorie&&i.preis_kids_euro?h=i.preis_kids_euro:d&&"erwachsene"===G.preiskategorie&&i.preis_erwachsene_euro&&(h=i.preis_erwachsene_euro),a.jsx("div",{className:"varianten-modal-overlay",onClick:()=>I(!1),children:a.jsxs("div",{className:"varianten-modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"varianten-modal-header",children:[a.jsx("h3",{children:i.name}),a.jsx("button",{className:"modal-close-btn",onClick:()=>I(!1),children:"Ã—"})]}),a.jsxs("div",{className:"varianten-modal-content",children:[d&&a.jsxs("div",{className:"varianten-section",children:[a.jsx("label",{children:"Preiskategorie:"}),a.jsxs("div",{className:"varianten-options",children:[i.preis_kids_cent&&a.jsxs("button",{type:"button",className:"variante-btn "+("kids"===G.preiskategorie?"selected":""),onClick:()=>H(e=>({...e,preiskategorie:"kids",groesse:""})),children:["Kids - ",null==(n=i.preis_kids_euro)?void 0:n.toFixed(2),"â‚¬"]}),i.preis_erwachsene_cent&&a.jsxs("button",{type:"button",className:"variante-btn "+("erwachsene"===G.preiskategorie?"selected":""),onClick:()=>H(e=>({...e,preiskategorie:"erwachsene",groesse:""})),children:["Erwachsene - ",null==(r=i.preis_erwachsene_euro)?void 0:r.toFixed(2),"â‚¬"]})]})]}),t&&o.length>0&&a.jsxs("div",{className:"varianten-section",children:[a.jsx("label",{children:"GrÃ¶ÃŸe:"}),a.jsx("div",{className:"varianten-options groessen-grid",children:o.map(e=>a.jsx("button",{type:"button",className:"variante-btn "+(G.groesse===e?"selected":""),onClick:()=>H(a=>({...a,groesse:e})),children:e},e))})]}),l&&a.jsxs("div",{className:"varianten-section",children:[a.jsx("label",{children:"Farbe:"}),a.jsx("div",{className:"varianten-options",children:i.varianten_farben.map((e,s)=>{const n="object"==typeof e?e.name:e,r="object"==typeof e?e.hex:null;return a.jsx("button",{type:"button",className:"variante-btn "+(G.farbe===n?"selected":""),onClick:()=>H(e=>({...e,farbe:n})),style:r?{borderLeftColor:r,borderLeftWidth:"4px"}:{},children:n},n||s)})})]}),c&&a.jsxs("div",{className:"varianten-section",children:[a.jsx("label",{children:"Material:"}),a.jsx("div",{className:"varianten-options",children:i.varianten_material.map((e,s)=>{const n="object"==typeof e?e.name:e;return a.jsx("button",{type:"button",className:"variante-btn "+(G.material===n?"selected":""),onClick:()=>H(e=>({...e,material:n})),children:n},n||s)})})]}),a.jsxs("div",{className:"varianten-preis",children:[a.jsx("span",{children:"Preis:"}),a.jsxs("span",{className:"preis-wert",children:[null==h?void 0:h.toFixed(2),"â‚¬"]})]})]}),a.jsxs("div",{className:"varianten-modal-actions",children:[a.jsx("button",{className:"btn btn-secondary",onClick:()=>I(!1),children:"Abbrechen"}),a.jsx("button",{className:"btn btn-primary",onClick:X,disabled:!m,children:"In den Warenkorb"})]})]})})})()]})]});var ie};export{t as default};
