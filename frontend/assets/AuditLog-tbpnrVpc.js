import{j as e}from"./animation-1wuIdCBS.js";import{r as s}from"./vendor-router-BhMXg4Z-.js";import{k as a,g as t}from"./index-BJCk5MxH.js";import{aK as i,b4 as l,a as n,b as r,ax as d,av as c,C as o,U as h,j}from"./icons-C6KFH58b.js";import"./vendor-react-DtuzQOD1.js";import"./query-Bs1dTGah.js";const u=()=>{var u,m;const[x,g]=s.useState([]),[b,p]=s.useState(!1),[N,v]=s.useState(null),[f,k]=s.useState([]),[_,y]=s.useState({kategorie:"",suchbegriff:"",von_datum:"",bis_datum:""}),[S,w]=s.useState(!1),[z,E]=s.useState(0),[C,A]=s.useState(!0),[L,U]=s.useState(null),D={MITGLIED:"ðŸ‘¤",FINANZEN:"ðŸ’°",VERTRAG:"ðŸ“„",PRUEFUNG:"ðŸ¥‹",ADMIN:"âš™ï¸",SEPA:"ðŸ¦",DOKUMENT:"ðŸ“",SYSTEM:"ðŸ–¥ï¸",AUTH:"ðŸ”"},B={MITGLIED:"#3b82f6",FINANZEN:"#10b981",VERTRAG:"#8b5cf6",PRUEFUNG:"#f59e0b",ADMIN:"#6366f1",SEPA:"#14b8a6",DOKUMENT:"#ec4899",SYSTEM:"#6b7280",AUTH:"#ef4444"};s.useEffect(()=>{T()},[]),s.useEffect(()=>{F(!0)},[_]);const T=async()=>{try{const e=await a(`${t.apiBaseUrl}/audit-log/kategorien`);if(e.ok){const s=await e.json();k(s.data||[])}}catch(e){console.error("Fehler beim Laden der Kategorien:",e)}},F=s.useCallback(async(e=!1)=>{p(!0);try{const s=e?0:z,i=new URLSearchParams({limit:50..toString(),offset:s.toString()});_.kategorie&&i.append("kategorie",_.kategorie),_.suchbegriff&&i.append("suchbegriff",_.suchbegriff),_.von_datum&&i.append("von_datum",_.von_datum),_.bis_datum&&i.append("bis_datum",_.bis_datum);const l=await a(`${t.apiBaseUrl}/audit-log?${i}`);if(l.ok){const s=await l.json();e?(g(s.data||[]),E(50)):(g(e=>[...e,...s.data||[]]),E(e=>e+50)),A(50===(s.data||[]).length)}}catch(s){console.error("Fehler beim Laden der Logs:",s)}finally{p(!1)}},[_,z]);s.useEffect(()=>{(async()=>{try{const e=await a(`${t.apiBaseUrl}/audit-log/stats?tage=30`);if(e.ok){const s=await e.json();v(s.data)}}catch(e){console.error("Fehler beim Laden der Statistiken:",e)}})()},[]);const I=e=>{if(!e)return"-";return new Date(e).toLocaleString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},K=e=>e.replace(/_/g," ").toLowerCase().replace(/^\w/,e=>e.toUpperCase()),R=(e,s)=>{y(a=>({...a,[e]:s})),E(0)},$=e=>{if(!e)return"-";try{const s="string"==typeof e?JSON.parse(e):e,a=Object.keys(s);return 0===a.length?"-":a.slice(0,3).map(e=>`${e}: ${s[e]}`).join(", ")+(a.length>3?"...":"")}catch{return String(e).substring(0,50)}};return e.jsxs("div",{className:"audit-log-container",children:[e.jsxs("div",{className:"audit-log-header",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(i,{size:24}),e.jsx("h2",{children:"Audit-Log"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"filter-toggle "+(S?"active":""),onClick:()=>w(!S),children:[e.jsx(l,{size:18}),"Filter",S?e.jsx(n,{size:16}):e.jsx(r,{size:16})]}),e.jsx("button",{className:"refresh-btn",onClick:()=>F(!0),disabled:b,children:e.jsx(d,{size:18,className:b?"spinning":""})})]})]}),N&&e.jsxs("div",{className:"audit-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-label",children:"Letzte 30 Tage"}),e.jsx("span",{className:"stat-value",children:(null==(u=N.stats)?void 0:u.reduce((e,s)=>e+s.anzahl,0))||0}),e.jsx("span",{className:"stat-sub",children:"Aktionen"})]}),null==(m=N.stats)?void 0:m.slice(0,4).map((s,a)=>e.jsxs("div",{className:"stat-card mini",children:[e.jsx("span",{className:"stat-icon",children:D[s.kategorie]||"ðŸ“‹"}),e.jsx("span",{className:"stat-value",children:s.anzahl}),e.jsx("span",{className:"stat-label",children:K(s.aktion)})]},a))]}),S&&e.jsx("div",{className:"filter-panel",children:e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Suche"}),e.jsxs("div",{className:"search-input",children:[e.jsx(c,{size:16}),e.jsx("input",{type:"text",placeholder:"Name, Email, Beschreibung...",value:_.suchbegriff,onChange:e=>R("suchbegriff",e.target.value)})]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Kategorie"}),e.jsxs("select",{value:_.kategorie,onChange:e=>R("kategorie",e.target.value),children:[e.jsx("option",{value:"",children:"Alle Kategorien"}),f.map(s=>e.jsxs("option",{value:s.value,children:[s.icon," ",s.label]},s.value))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Von"}),e.jsx("input",{type:"date",value:_.von_datum,onChange:e=>R("von_datum",e.target.value)})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Bis"}),e.jsx("input",{type:"date",value:_.bis_datum,onChange:e=>R("bis_datum",e.target.value)})]}),e.jsx("button",{className:"clear-filters",onClick:()=>{y({kategorie:"",suchbegriff:"",von_datum:"",bis_datum:""}),E(0)},children:"Filter zurÃ¼cksetzen"})]})}),e.jsxs("div",{className:"audit-table-container",children:[e.jsxs("table",{className:"audit-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Zeitpunkt"}),e.jsx("th",{children:"Kategorie"}),e.jsx("th",{children:"Aktion"}),e.jsx("th",{children:"Benutzer"}),e.jsx("th",{children:"Betroffener Datensatz"}),e.jsx("th",{children:"Beschreibung"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:x.map(s=>{var a,t;return e.jsxs("tr",{onClick:()=>U(s),children:[e.jsxs("td",{className:"time-cell",children:[e.jsx(o,{size:14}),I(s.created_at)]}),e.jsx("td",{children:e.jsxs("span",{className:"kategorie-badge",style:{backgroundColor:B[s.kategorie]||"#6b7280"},children:[D[s.kategorie]||"ðŸ“‹"," ",s.kategorie]})}),e.jsx("td",{className:"aktion-cell",children:K(s.aktion)}),e.jsxs("td",{className:"user-cell",children:[e.jsx(h,{size:14}),s.user_name||s.user_email||"System"]}),e.jsx("td",{className:"entity-cell",children:s.entity_name||(s.entity_type&&s.entity_id?`${s.entity_type} #${s.entity_id}`:"-")}),e.jsxs("td",{className:"beschreibung-cell",title:s.beschreibung,children:[(null==(a=s.beschreibung)?void 0:a.substring(0,50))||$(s.neue_werte),(null==(t=s.beschreibung)?void 0:t.length)>50?"...":""]}),e.jsx("td",{children:e.jsx("button",{className:"view-btn",onClick:e=>{e.stopPropagation(),U(s)},children:e.jsx(j,{size:16})})})]},s.id)})})]}),0===x.length&&!b&&e.jsxs("div",{className:"empty-state",children:[e.jsx(i,{size:48}),e.jsx("p",{children:"Keine Log-EintrÃ¤ge gefunden"})]}),b&&e.jsxs("div",{className:"loading-state",children:[e.jsx(d,{size:24,className:"spinning"}),e.jsx("p",{children:"Lade Logs..."})]}),C&&!b&&x.length>0&&e.jsx("button",{className:"load-more",onClick:()=>F(!1),children:"Weitere laden"})]}),L&&e.jsx("div",{className:"modal-overlay",onClick:()=>U(null),children:e.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h3",{children:[D[L.kategorie]," Log-Details"]}),e.jsx("button",{className:"close-btn",onClick:()=>U(null),children:"Ã—"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"detail-grid",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Zeitpunkt"}),e.jsx("span",{children:I(L.created_at)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Kategorie"}),e.jsxs("span",{className:"kategorie-badge",style:{backgroundColor:B[L.kategorie]},children:[D[L.kategorie]," ",L.kategorie]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Aktion"}),e.jsx("span",{children:K(L.aktion)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Benutzer"}),e.jsxs("span",{children:[L.user_name||"-",e.jsx("br",{}),e.jsx("small",{children:L.user_email||"-"}),e.jsx("br",{}),e.jsxs("small",{children:["Rolle: ",L.user_role||"-"]})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Dojo"}),e.jsx("span",{children:L.dojo_name||`Dojo #${L.dojo_id}`||"-"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Betroffener Datensatz"}),e.jsxs("span",{children:[L.entity_type||"-"," #",L.entity_id||"-",e.jsx("br",{}),e.jsx("small",{children:L.entity_name||"-"})]})]}),e.jsxs("div",{className:"detail-item full-width",children:[e.jsx("label",{children:"Beschreibung"}),e.jsx("span",{children:L.beschreibung||"-"})]}),L.alte_werte&&e.jsxs("div",{className:"detail-item full-width",children:[e.jsx("label",{children:"Alte Werte"}),e.jsx("pre",{className:"json-display",children:JSON.stringify("string"==typeof L.alte_werte?JSON.parse(L.alte_werte):L.alte_werte,null,2)})]}),L.neue_werte&&e.jsxs("div",{className:"detail-item full-width",children:[e.jsx("label",{children:"Neue Werte"}),e.jsx("pre",{className:"json-display",children:JSON.stringify("string"==typeof L.neue_werte?JSON.parse(L.neue_werte):L.neue_werte,null,2)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"IP-Adresse"}),e.jsx("span",{children:L.ip_adresse||"-"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("label",{children:"Request"}),e.jsxs("span",{children:[L.request_method," ",L.request_path||"-"]})]})]})})]})})]})};export{u as default};
