<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <meta name="theme-color" content="#0f0f23" />
    <meta name="description" content="Dojosoftware Mitgliederbereich - Check-in, Trainingsplan, Statistiken" />

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Dojo Member" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <title>Dojosoftware</title>

    <!-- CRITICAL: Clean Service Workers BEFORE loading React (NO REDIRECT) -->
    <script>
      (function() {
        'use strict';

        // Only run cleanup once per session
        const SW_CLEANUP_KEY = 'sw_cleanup_completed';
        const hasCleanedUp = sessionStorage.getItem(SW_CLEANUP_KEY);

        if (hasCleanedUp || !('serviceWorker' in navigator)) {
          console.log('[CLEANUP] Skipping - already done or not supported');
          return;
        }

        console.log('[CLEANUP] Removing Service Workers...');

        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          if (registrations.length === 0) {
            console.log('[CLEANUP] No Service Workers found');
            sessionStorage.setItem(SW_CLEANUP_KEY, 'true');
            return;
          }

          console.log('[CLEANUP] Found ' + registrations.length + ' Service Workers, removing...');

          Promise.all(registrations.map(function(reg) {
            return reg.unregister();
          })).then(function() {
            console.log('[CLEANUP] All Service Workers removed');

            // Clear caches
            if ('caches' in window) {
              return caches.keys().then(function(names) {
                return Promise.all(names.map(function(name) {
                  return caches.delete(name);
                }));
              });
            }
          }).then(function() {
            console.log('[CLEANUP] Caches cleared');
            sessionStorage.setItem(SW_CLEANUP_KEY, 'true');
            // Reload to start fresh WITHOUT Service Workers
            window.location.reload();
          });
        }).catch(function(err) {
          console.error('[CLEANUP] Error:', err);
          sessionStorage.setItem(SW_CLEANUP_KEY, 'true');
        });
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
