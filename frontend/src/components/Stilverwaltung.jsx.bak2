/*
================================================================================
STIL-VERWALTUNG REACT KOMPONENTE - MIT @DND-KIT DRAG & DROP v2.2
================================================================================
Diese Komponente verwaltet Kampfkunst-Stile, ihre Graduierungen und PrÃ¼fungsinhalte.
NEUE FEATURES v2.2: Moderne @dnd-kit Drag & Drop Implementation
DEPENDENCIES: npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
================================================================================
*/

import React, { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import config from '../config/config.js';
import "../styles/themes.css";       // Centralized theme system
import "../styles/components.css";   // Universal component styles
import '../styles/StilVerwaltung.css';

// Einfache arrayMove Funktion ohne @dnd-kit
const arrayMove = (array, from, to) => {
  const newArray = [...array];
  const element = newArray.splice(from, 1)[0];
  newArray.splice(to, 0, element);
  return newArray;
};

const StilVerwaltung = () => {
  const navigate = useNavigate();
  const { stilId } = useParams();
  
  // ============================================================================
  // STATE MANAGEMENT
  // ============================================================================
  
  // Hauptdaten States
  const [stile, setStile] = useState([]);                    // Array aller Stile
  const [currentStil, setCurrentStil] = useState(null);      // Aktuell gewÃ¤hlter Stil
  const [loading, setLoading] = useState(false);             // Loading-Zustand
  const [error, setError] = useState('');                    // Fehlermeldungen
  const [success, setSuccess] = useState('');                // Erfolgsmeldungen
  const [activeTab, setActiveTab] = useState('allgemein');   // Aktiver Tab in Detail-Ansicht
  const [mitglieder, setMitglieder] = useState([]);          // Alle Mitglieder fÃ¼r SchÃ¼ler-ZÃ¤hlung
  
  // Formular States
  const [showCreateForm, setShowCreateForm] = useState(false);     // Modal fÃ¼r neuen Stil
  const [createStep, setCreateStep] = useState(1);                // Aktueller Schritt im Erstellungsprozess
  const [showEditGraduierung, setShowEditGraduierung] = useState(false); // Modal fÃ¼r Graduierung bearbeiten
  const [editingGraduierung, setEditingGraduierung] = useState(null);     // Zu bearbeitende Graduierung
  
  // Drag & Drop States
  const [activeId, setActiveId] = useState(null);                  // Aktive Drag-ID
  const [draggedGraduierung, setDraggedGraduierung] = useState(null); // Gezogene Graduierung
  
  
  // Stil-Erstellung Form Data - Erweitert
  const [formData, setFormData] = useState({
    name: '',
    beschreibung: '',
    aktiv: true,
    kategorie: 'kampfkunst', // kampfkunst, selbstverteidigung, fitness
    schwierigkeitsgrad: 'mittel', // anfaenger, mittel, fortgeschritten
    altergruppe: 'alle', // kinder, jugendliche, erwachsene, alle
    trainingsdauer: 60, // Minuten
    ausruestung: [] // Array von benÃ¶tigter AusrÃ¼stung
  });



  // ============================================================================
  // KONSTANTEN UND KONFIGURATION
  // ============================================================================
  
  // API Base URL mit Fallback - KORRIGIERT mit /api Prefix
  const API_BASE = (config?.apiBaseUrl || 'http://localhost:3002') + '/api';

  // Erweiterte Standard-GÃ¼rtel mit PrimÃ¤r- und SekundÃ¤rfarben fÃ¼r alle KampfkÃ¼nste
  const standardGuertel = [
    // === GRUNDSTUFE (AnfÃ¤nger) ===
    { name: 'WeiÃŸgurt', primaer: '#FFFFFF', sekundaer: null, kategorie: 'grundstufe', reihenfolge: 1 },
    { name: 'WeiÃŸ-Gelbgurt', primaer: '#FFFFFF', sekundaer: '#FFD700', kategorie: 'grundstufe', reihenfolge: 2 },
    { name: 'Gelbgurt', primaer: '#FFD700', sekundaer: null, kategorie: 'grundstufe', reihenfolge: 3 },
    { name: 'Gelb-Orangegurt', primaer: '#FFD700', sekundaer: '#FF8C00', kategorie: 'grundstufe', reihenfolge: 4 },
    { name: 'Orangegurt', primaer: '#FF8C00', sekundaer: null, kategorie: 'grundstufe', reihenfolge: 5 },
    
    // === MITTELSTUFE (Fortgeschritten) ===
    { name: 'Orange-GrÃ¼ngurt', primaer: '#FF8C00', sekundaer: '#32CD32', kategorie: 'mittelstufe', reihenfolge: 6 },
    { name: 'GrÃ¼ngurt', primaer: '#32CD32', sekundaer: null, kategorie: 'mittelstufe', reihenfolge: 7 },
    { name: 'GrÃ¼n-Blaugurt', primaer: '#32CD32', sekundaer: '#0066CC', kategorie: 'mittelstufe', reihenfolge: 8 },
    { name: 'Blaugurt', primaer: '#0066CC', sekundaer: null, kategorie: 'mittelstufe', reihenfolge: 9 },
    
    // === OBERSTUFE (Fortgeschritten Plus) ===
    { name: 'Blau-Braungurt', primaer: '#0066CC', sekundaer: '#8B4513', kategorie: 'oberstufe', reihenfolge: 10 },
    { name: 'Braungurt', primaer: '#8B4513', sekundaer: null, kategorie: 'oberstufe', reihenfolge: 11 },
    { name: 'Rot-Schwarzgurt', primaer: '#DC143C', sekundaer: '#000000', kategorie: 'oberstufe', reihenfolge: 12 },
    { name: 'Braun-Schwarzgurt', primaer: '#8B4513', sekundaer: '#000000', kategorie: 'oberstufe', reihenfolge: 13 },
    
    // === DAN-GRADE (Schwarzgurt-Stufen) ===
    { name: '1.DAN Schwarzgurt', primaer: '#000000', sekundaer: null, kategorie: 'dan', dan: 1, reihenfolge: 14 },
    { name: '2.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#FFD700', kategorie: 'dan', dan: 2, reihenfolge: 15 },
    { name: '3.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#FFD700', kategorie: 'dan', dan: 3, reihenfolge: 16 },
    { name: '4.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#FFD700', kategorie: 'dan', dan: 4, reihenfolge: 17 },
    { name: '5.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#FFD700', kategorie: 'dan', dan: 5, reihenfolge: 18 },
    { name: '6.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#DC143C', kategorie: 'dan', dan: 6, reihenfolge: 19 },
    { name: '7.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#DC143C', kategorie: 'dan', dan: 7, reihenfolge: 20 },
    { name: '8.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#DC143C', kategorie: 'dan', dan: 8, reihenfolge: 21 },
    { name: '9.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#DC143C', kategorie: 'dan', dan: 9, reihenfolge: 22 },
    { name: '10.DAN Schwarzgurt', primaer: '#000000', sekundaer: '#DC143C', kategorie: 'dan', dan: 10, reihenfolge: 23 },
    
    // === MEISTER-GRADE (Rot-GÃ¼rtel) ===
    { name: 'Rotgurt', primaer: '#DC143C', sekundaer: null, kategorie: 'meister', reihenfolge: 24 },
    { name: 'Rot-WeiÃŸgurt', primaer: '#DC143C', sekundaer: '#FFFFFF', kategorie: 'meister', reihenfolge: 25 }
  ];

  // ============================================================================
  // GÃœRTEL-VORSCHAU KOMPONENTE
  // ============================================================================
  
  /**
   * BeltPreview - Zeigt eine visuelle Darstellung eines GÃ¼rtels an
   * @param {string} primaer - Hauptfarbe des GÃ¼rtels (HEX)
   * @param {string|null} sekundaer - Optionale SekundÃ¤rfarbe fÃ¼r Streifen (HEX) 
   * @param {string} size - GrÃ¶ÃŸe: 'small', 'normal', 'large'
   * @param {string} className - ZusÃ¤tzliche CSS-Klasse
   */
  const BeltPreview = ({ primaer, sekundaer, size = 'normal', className = '' }) => {
    // Bestimme CSS-Klasse basierend auf GrÃ¶ÃŸe
    const sizeClass = {
      'small': 'belt-preview-small',
      'normal': 'belt-preview',
      'large': 'belt-preview-large'
    }[size] || 'belt-preview';
    
    return (
      <div className={`${sizeClass} ${className}`}>
        {/* Basis-GÃ¼rtel mit PrimÃ¤rfarbe */}
        <div 
          className="belt-base" 
          style={{ backgroundColor: primaer || '#CCCCCC' }}
        >
          {/* SekundÃ¤rer Streifen wenn vorhanden */}
          {sekundaer && (
            <div 
              className="belt-stripe" 
              style={{ backgroundColor: sekundaer }}
            />
          )}
        </div>
      </div>
    );
  };

  // ============================================================================
  // @DND-KIT DRAG & DROP FUNKTIONEN
  // ============================================================================

  /**
   * Behandelt den Start eines Drag-Vorgangs
   * @param {Object} event - DragStart Event von @dnd-kit
   */
  const handleDragStart = (event) => {
    const { active } = event;
    console.log('ğŸš€ Drag Start:', active.id);
    setActiveId(active.id);
    
    // Finde die gezogene Graduierung fÃ¼r das Overlay
    const graduierung = currentStil?.graduierungen?.find(
      g => g.graduierung_id.toString() === active.id
    );
    console.log('ğŸ“‹ Gefundene Graduierung fÃ¼r Drag:', graduierung?.name);
    setDraggedGraduierung(graduierung);
  };

  /**
   * Behandelt das Ende eines Drag-Vorgangs
   * @param {Object} event - DragEnd Event von @dnd-kit
   */
  const handleDragEnd = async (event) => {
    const { active, over } = event;
    console.log('ğŸ Drag End:', { activeId: active.id, overId: over?.id });
    
    // Reset Drag-States
    setActiveId(null);
    setDraggedGraduierung(null);

    // ÃœberprÃ¼fe ob Drop gÃ¼ltig ist
    if (!over || active.id === over.id) {
      console.log('âŒ Drag abgebrochen: over=', over, 'same id=', active.id === over?.id);
      return;
    }

    // Aktuelle Graduierungen sortiert holen
    const graduierungen = [...(currentStil?.graduierungen || [])]
      .sort((a, b) => (a.reihenfolge || 0) - (b.reihenfolge || 0));

    const oldIndex = graduierungen.findIndex(
      g => g.graduierung_id.toString() === active.id
    );
    const newIndex = graduierungen.findIndex(
      g => g.graduierung_id.toString() === over.id
    );

    if (oldIndex !== -1 && newIndex !== -1) {
      console.log('âœ… Indices gefunden:', { oldIndex, newIndex });
      
      // Reorder mit @dnd-kit arrayMove
      const reorderedGraduierungen = arrayMove(graduierungen, oldIndex, newIndex);
      
      // Neue Reihenfolge zuweisen (1-basiert)
      const updatedGraduierungen = reorderedGraduierungen.map((grad, index) => ({
        ...grad,
        reihenfolge: index + 1
      }));

      console.log('ğŸ”„ Neue Reihenfolge:', updatedGraduierungen.map(g => `${g.name}: ${g.reihenfolge}`));

      // Optimistic Update - UI sofort aktualisieren
      setCurrentStil({
        ...currentStil,
        graduierungen: updatedGraduierungen
      });

      // Backend-Update
      try {
        console.log('ğŸ“¡ Sende API Request...');
        await updateGraduierungsReihenfolge(updatedGraduierungen);
        setSuccess('Reihenfolge erfolgreich aktualisiert!');
        setTimeout(() => setSuccess(''), 2000);
        console.log('âœ… API Request erfolgreich');
      } catch (err) {
        console.error('âŒ Fehler beim Aktualisieren der Reihenfolge:', err);
        setError('Reihenfolge konnte nicht gespeichert werden');
        // Rollback bei Fehler
        loadStil(currentStil.stil_id);
      }
    } else {
      console.log('âŒ Indices nicht gefunden:', { oldIndex, newIndex });
    }
  };

  /**
   * Sendet die aktualisierte Graduierungs-Reihenfolge an das Backend
   * @param {Array} graduierungen - Array der Graduierungen mit neuer Reihenfolge
   */
  const updateGraduierungsReihenfolge = async (graduierungen) => {
    const response = await fetch(`${API_BASE}/stile/${currentStil.stil_id}/graduierungen/reorder`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        graduierungen: graduierungen.map(g => ({
          graduierung_id: g.graduierung_id,
          reihenfolge: g.reihenfolge
        }))
      })
    });

    if (!response.ok) {
      throw new Error('Fehler beim Aktualisieren der Reihenfolge');
    }

    return await response.json();
  };

  /**
   * Speichert die Ã„nderungen einer bearbeiteten Graduierung
   */
  const saveGraduierungEdit = async () => {
    if (!editingGraduierung || !editingGraduierung.name?.trim()) {
      setError('Name ist erforderlich');
      return;
    }

    setLoading(true);
    try {
      const graduierungData = {
        name: editingGraduierung.name.trim(),
        reihenfolge: editingGraduierung.reihenfolge || 1,
        trainingsstunden_min: editingGraduierung.trainingsstunden_min || 0,
        mindestzeit_monate: editingGraduierung.mindestzeit_monate || 0,
        farbe_hex: editingGraduierung.farbe_hex || '#FFFFFF',
        farbe_sekundaer: editingGraduierung.farbe_sekundaer || null,
        kategorie: editingGraduierung.kategorie || null,
        dan_grad: editingGraduierung.dan_grad || null,
        aktiv: editingGraduierung.aktiv !== false ? 1 : 0
      };

      console.log('ğŸ’¾ Speichere Graduierung:', graduierungData);

      const response = await fetch(`${API_BASE}/stile/graduierungen/${editingGraduierung.graduierung_id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(graduierungData)
      });

      if (response.ok) {
        setSuccess('Graduierung erfolgreich aktualisiert!');
        setShowEditGraduierung(false);
        setEditingGraduierung(null);
        
        // Einfache LÃ¶sung: Lade nur den aktuellen Stil neu
        setTimeout(async () => {
          if (currentStil) {
            await loadStil(currentStil.stil_id);
          }
        }, 100);
      } else {
        const errorData = await response.json();
        setError(errorData.error || 'Fehler beim Speichern der Graduierung');
      }
    } catch (err) {
      console.error('âŒ Fehler beim Speichern der Graduierung:', err);
      setError('Netzwerkfehler beim Speichern');
    } finally {
      setLoading(false);
    }
  };

  /**
   * Verschiebt eine Graduierung in der Reihenfolge nach oben
   * @param {Object} graduierung - Zu verschiebende Graduierung
   */
  const moveGraduierungUp = async (graduierung) => {
    try {
      const sortedGrads = [...currentStil.graduierungen].sort((a, b) => (a.reihenfolge || 0) - (b.reihenfolge || 0));
      const currentIndex = sortedGrads.findIndex(g => g.graduierung_id === graduierung.graduierung_id);
      
      if (currentIndex > 0) {
        const newGraduierungen = arrayMove(sortedGrads, currentIndex, currentIndex - 1);
        
        // Neue Reihenfolgen zuweisen
        newGraduierungen.forEach((grad, index) => {
          grad.reihenfolge = index + 1;
        });

        // UI sofort aktualisieren
        setCurrentStil({
          ...currentStil,
          graduierungen: newGraduierungen
        });

        // Backend im Hintergrund aktualisieren (ohne await)
        updateGraduierungsReihenfolge(newGraduierungen).catch(err => {
          console.error('Backend update failed:', err);
          setError('Fehler beim Speichern der Reihenfolge');
        });
      }
    } catch (err) {
      setError('Fehler beim Verschieben');
    }
  };

  /**
   * Verschiebt eine Graduierung in der Reihenfolge nach unten
   * @param {Object} graduierung - Zu verschiebende Graduierung
   */
  const moveGraduierungDown = async (graduierung) => {
    try {
      const sortedGrads = [...currentStil.graduierungen].sort((a, b) => (a.reihenfolge || 0) - (b.reihenfolge || 0));
      const currentIndex = sortedGrads.findIndex(g => g.graduierung_id === graduierung.graduierung_id);
      
      if (currentIndex >= 0 && currentIndex < sortedGrads.length - 1) {
        const newGraduierungen = arrayMove(sortedGrads, currentIndex, currentIndex + 1);
        
        // Neue Reihenfolgen zuweisen
        newGraduierungen.forEach((grad, index) => {
          grad.reihenfolge = index + 1;
        });

        // UI sofort aktualisieren
        setCurrentStil({
          ...currentStil,
          graduierungen: newGraduierungen
        });

        // Backend im Hintergrund aktualisieren (ohne await)
        updateGraduierungsReihenfolge(newGraduierungen).catch(err => {
          console.error('Backend update failed:', err);
          setError('Fehler beim Speichern der Reihenfolge');
        });
      }
    } catch (err) {
      setError('Fehler beim Verschieben');
    }
  };

  // ============================================================================
  // API-FUNKTIONEN
  // ============================================================================
  
  /**
   * LÃ¤dt alle Stile von der API
   */
  const loadStile = async () => {
    setLoading(true);
    console.log('ğŸ”„ Lade Stile von:', `${API_BASE}/stile`);
    console.log('ğŸ”§ API_BASE ist:', API_BASE);
    try {
      const response = await fetch(`${API_BASE}/stile`);
      console.log('ğŸ“¡ API Response Status:', response.status);
      console.log('ğŸ“¡ API Response OK:', response.ok);
      
      if (response.ok) {
        const data = await response.json();
        console.log('âœ… Stile geladen:', data);
        console.log('âœ… Anzahl Stile:', data.length);
        setStile(data);
      } else {
        const errorText = await response.text();
        console.error('âŒ API Fehler:', response.status, errorText);
        setStile([]);
        setError(`API Fehler ${response.status}: ${errorText}`);
      }
    } catch (err) {
      console.error('âŒ Fehler beim Laden der Stile:', err);
      setError('Stile konnten nicht geladen werden. Bitte Server prÃ¼fen.');
    } finally {
      setLoading(false);
    }
  };

  /**
   * LÃ¤dt einen spezifischen Stil mit allen Details
   * @param {number} id - Stil-ID
   */
  const loadStil = async (id) => {
    if (!id) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}/stile/${id}`);
      if (response.ok) {
        const data = await response.json();
        setCurrentStil(data);
        console.log('âœ… Stil geladen:', data.name);
      } else {
        // Fallback: Suche im lokalen Array
        const stil = stile.find(s => s.stil_id === parseInt(id));
        if (stil) {
          setCurrentStil(stil);
        } else {
          setError('Stil nicht gefunden');
        }
      }
    } catch (err) {
      console.error('âŒ Fehler beim Laden des Stils:', err);
      setError('Stil konnte nicht geladen werden');
    } finally {
      setLoading(false);
    }
  };

  /**
   * Erstellt einen neuen Stil
   */
  const createStil = async () => {
    // Validierung
    if (!formData.name.trim()) {
      setError('Stil-Name ist erforderlich');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}/stile`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (response.ok) {
        const newStil = await response.json();
        setStile([...stile, newStil]);
        setSuccess(`Stil "${formData.name}" erfolgreich erstellt!`);
        setShowCreateForm(false);
        setFormData({ name: '', beschreibung: '', aktiv: true });
        setTimeout(() => setSuccess(''), 3000);
        console.log('âœ… Stil erstellt:', newStil);
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        setError(errorData.error || 'Fehler beim Erstellen des Stils');
      }
    } catch (err) {
      console.error('âŒ Fehler beim Erstellen des Stils:', err);
      setError('Stil konnte nicht erstellt werden. Bitte Server prÃ¼fen.');
    } finally {
      setLoading(false);
    }
  };

  /**
   * Aktualisiert einen bestehenden Stil
   * @param {Object} updatedStilData - Neue Stil-Daten
   */
  const updateStil = async (updatedStilData) => {
    if (!currentStil) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}/stile/${currentStil.stil_id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedStilData)
      });

      if (response.ok) {
        const updatedStil = await response.json();
        setCurrentStil(updatedStil);
        setStile(stile.map(s => s.stil_id === currentStil.stil_id ? updatedStil : s));
        setSuccess('Stil erfolgreich aktualisiert!');
        setTimeout(() => setSuccess(''), 2000);
        console.log('âœ… Stil aktualisiert:', updatedStil);
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        setError(errorData.error || 'Fehler beim Aktualisieren des Stils');
      }
    } catch (err) {
      console.error('âŒ Fehler beim Aktualisieren des Stils:', err);
      setError('Stil konnte nicht aktualisiert werden');
    } finally {
      setLoading(false);
    }
  };

  /**
   * LÃ¶scht einen Stil mit Sicherheitsabfrage
   * @param {number} stilId - ID des zu lÃ¶schenden Stils
   */
  const deleteStil = async (stilId) => {
    if (!stilId) return;
    
    // Finde den Stil
    const stil = stile.find(s => s.stil_id === stilId);
    if (!stil) return;
    
    // PrÃ¼fe ob Stil Daten hat
    const hasData = (stil.anzahl_mitglieder && stil.anzahl_mitglieder > 0) || 
                   (stil.graduierungen && stil.graduierungen.length > 0);
    
    if (hasData) {
      // Stil hat Daten - nur Deaktivierung mÃ¶glich
      const confirmDeactivate = confirm(
        `Der Stil "${stil.name}" hat bereits Daten (${stil.anzahl_mitglieder || 0} SchÃ¼ler, ${stil.graduierungen?.length || 0} Graduierungen).\n\n` +
        `LÃ¶schen ist nicht mÃ¶glich. MÃ¶chten Sie den Stil stattdessen deaktivieren?\n\n` +
        `Deaktivierte Stile werden nicht mehr in der SchÃ¼lerverwaltung angezeigt.`
      );
      
      if (confirmDeactivate) {
        await updateStil({ aktiv: false });
        setSuccess(`Stil "${stil.name}" wurde deaktiviert.`);
        setTimeout(() => setSuccess(''), 3000);
      }
    } else {
      // Stil hat keine Daten - LÃ¶schung mÃ¶glich
      const confirmDelete = confirm(
        `MÃ¶chten Sie den Stil "${stil.name}" wirklich lÃ¶schen?\n\n` +
        `Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!`
      );
      
      if (confirmDelete) {
        setLoading(true);
        try {
          const response = await fetch(`${API_BASE}/stile/${stilId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            // Entferne aus der Liste
            setStile(stile.filter(s => s.stil_id !== stilId));
            
            // Wenn aktueller Stil gelÃ¶scht wurde, zurÃ¼ck zur Ãœbersicht
            if (currentStil && currentStil.stil_id === stilId) {
              setCurrentStil(null);
              navigate('/dashboard/stile');
            }
            
            setSuccess(`Stil "${stil.name}" wurde erfolgreich gelÃ¶scht!`);
            setTimeout(() => setSuccess(''), 3000);
            console.log('âœ… Stil gelÃ¶scht:', stilId);
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
            setError(errorData.error || 'Fehler beim LÃ¶schen des Stils');
          }
        } catch (err) {
          console.error('âŒ Fehler beim LÃ¶schen des Stils:', err);
          setError('Stil konnte nicht gelÃ¶scht werden');
        } finally {
          setLoading(false);
        }
      }
    }
  };

  /**
   * FÃ¼gt eine neue Graduierung zu einem Stil hinzu
   * @param {Object} newGraduierung - Graduierungs-Daten
   */
  const addGraduierung = async (newGraduierung) => {
    if (!currentStil) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}/stile/${currentStil.stil_id}/graduierungen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: newGraduierung.name,
          trainingsstunden_min: newGraduierung.trainingsstunden_min,
          mindestzeit_monate: newGraduierung.mindestzeit_monate,
          farbe_hex: newGraduierung.farbe_hex,
          farbe_sekundaer: newGraduierung.farbe_sekundaer || null,
          kategorie: newGraduierung.kategorie || null,
          dan_grad: newGraduierung.dan_grad || null
        })
      });

      if (response.ok) {
        const savedGraduierung = await response.json();
        
        // Aktualisiere currentStil mit echten Backend-Daten
        const updatedStil = {
          ...currentStil,
          graduierungen: [...(currentStil.graduierungen || []), savedGraduierung]
        };
        setCurrentStil(updatedStil);
        
        // Aktualisiere Haupt-Stile-Liste
        setStile(stile.map(s => s.stil_id === currentStil.stil_id ? updatedStil : s));
        
        setSuccess('Graduierung erfolgreich hinzugefÃ¼gt!');
        setTimeout(() => setSuccess(''), 2000);
        console.log('âœ… Graduierung hinzugefÃ¼gt:', savedGraduierung);
        
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        setError(errorData.error || 'Fehler beim HinzufÃ¼gen der Graduierung');
      }
    } catch (err) {
      console.error('âŒ Fehler beim HinzufÃ¼gen der Graduierung:', err);
      setError('Graduierung konnte nicht hinzugefÃ¼gt werden');
    } finally {
      setLoading(false);
    }
  };

  /**
   * Aktualisiert eine bestehende Graduierung
   * @param {Object} graduierungData - Neue Graduierungs-Daten
   */
  const updateGraduierung = async (graduierungData) => {
    if (!graduierungData.graduierung_id) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}/stile/graduierungen/${graduierungData.graduierung_id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(graduierungData)
      });

      if (response.ok) {
        const updatedGraduierung = await response.json();
        
        // Aktualisiere currentStil
        const updatedStil = {
          ...currentStil,
          graduierungen: currentStil.graduierungen.map(g => 
            g.graduierung_id === graduierungData.graduierung_id ? updatedGraduierung : g
          )
        };
        setCurrentStil(updatedStil);
        
        // Aktualisiere Haupt-Liste
        setStile(stile.map(s => s.stil_id === currentStil.stil_id ? updatedStil : s));
        
        setSuccess('Graduierung erfolgreich aktualisiert!');
        setTimeout(() => setSuccess(''), 2000);
        console.log('âœ… Graduierung aktualisiert:', updatedGraduierung);
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        setError(errorData.error || 'Fehler beim Aktualisieren der Graduierung');
      }
    } catch (err) {
      console.error('âŒ Fehler beim Aktualisieren der Graduierung:', err);
      setError('Graduierung konnte nicht aktualisiert werden');
    } finally {
      setLoading(false);
    }
  };

  /**
   * LÃ¶scht eine Graduierung
   * @param {number} graduierungId - ID der zu lÃ¶schenden Graduierung
   */
  const deleteGraduierung = async (graduierungId) => {
    if (!currentStil || !confirm('Graduierung wirklich lÃ¶schen?')) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}/stile/graduierungen/${graduierungId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        // Entferne aus currentStil
        const updatedStil = {
          ...currentStil,
          graduierungen: currentStil.graduierungen.filter(g => g.graduierung_id !== graduierungId)
        };
        setCurrentStil(updatedStil);
        
        // Aktualisiere Haupt-Liste
        setStile(stile.map(s => s.stil_id === currentStil.stil_id ? updatedStil : s));
        
        setSuccess('Graduierung erfolgreich gelÃ¶scht!');
        setTimeout(() => setSuccess(''), 2000);
        console.log('âœ… Graduierung gelÃ¶scht:', graduierungId);
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        setError(errorData.error || 'Fehler beim LÃ¶schen der Graduierung');
      }
    } catch (err) {
      console.error('âŒ Fehler beim LÃ¶schen der Graduierung:', err);
      setError('Graduierung konnte nicht gelÃ¶scht werden');
    } finally {
      setLoading(false);
    }
  };

  // ============================================================================
  // EVENT HANDLER
  // ============================================================================

  /**
   * Handler fÃ¼r Formular-Ã„nderungen
   * @param {string} field - Feld-Name
   * @param {any} value - Neuer Wert
   */
  const handleFormChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  // Modal zurÃ¼cksetzen
  const resetCreateModal = () => {
    setShowCreateForm(false);
    setCreateStep(1);
    setFormData({
      name: '',
      beschreibung: '',
      aktiv: true,
      kategorie: 'kampfkunst',
      schwierigkeitsgrad: 'mittel',
      altergruppe: 'alle',
      trainingsdauer: 60,
      ausruestung: []
    });
  };

  /**
   * Handler fÃ¼r Graduierung bearbeiten
   * @param {Object} graduierung - Zu bearbeitende Graduierung
   */
  const handleEditGraduierung = (graduierung) => {
    try {
      // Sicheres Setzen der Daten
      setEditingGraduierung({ ...graduierung });
      setShowEditGraduierung(true);
    } catch (error) {
      console.error('âŒ Error in handleEditGraduierung:', error);
    }
  };

  /**
   * Handler fÃ¼r Modal schlieÃŸen
   */
  const handleCloseEditModal = () => {
    console.log('âŒ Closing edit modal');
    setShowEditGraduierung(false);
    setEditingGraduierung(null);
  };

  /**
   * Handler fÃ¼r automatische Fehler-Bereinigung
   */
  const clearMessages = () => {
    if (error) setError('');
    if (success) setSuccess('');
  };

  // ============================================================================
  // REACT LIFECYCLE HOOKS
  // ============================================================================

  // Lade alle Stile beim ersten Laden der Komponente
  useEffect(() => {
    loadStile();
  }, []);

  // Lade spezifischen Stil wenn stilId in URL vorhanden
  useEffect(() => {
    if (stilId && stile.length > 0) {
      loadStil(stilId);
    } else if (!stilId) {
      setCurrentStil(null);
    }
  }, [stilId, stile]);

  // Bereinige Nachrichten nach 5 Sekunden
  useEffect(() => {
    if (error || success) {
      const timer = setTimeout(clearMessages, 5000);
      return () => clearTimeout(timer);
    }
  }, [error, success]);

  // ============================================================================
  // SORTABLE GRADUIERUNG KOMPONENTE
  // ============================================================================
  
  /**
   * GraduierungItem - Einzelne Graduierung mit Move-Buttons
   * @param {Object} graduierung - Graduierungs-Objekt
   */
  const GraduierungItem = ({ graduierung, onEdit, onDelete, onMoveUp, onMoveDown, loading, isFirst, isLast }) => {

    return (
      <div
        className="graduierung-item"
        // Dynamische Border-Farbe basierend auf GÃ¼rtel-Farbe
        data-border-color={graduierung.farbe_hex}
        style={{
          position: 'relative',
          zIndex: 1
        }}
      >

        <div className="graduierung-header">
          <div className="graduierung-name">
            <BeltPreview 
              primaer={graduierung.farbe_hex} 
              sekundaer={graduierung.farbe_sekundaer} 
              size="normal"
            />
            <strong>{graduierung.name}</strong>
            <span className="reihenfolge-badge">#{graduierung.reihenfolge}</span>
          </div>
          <div className="graduierung-actions" style={{position: 'relative', zIndex: 9999}}>
            <button 
              className="btn btn-sm btn-secondary"
              onClick={(e) => {
                e.stopPropagation();
                onEdit && onEdit(graduierung);
              }}
              disabled={loading}
              title="Graduierung bearbeiten"
              style={{position: 'relative', zIndex: 10000, pointerEvents: 'auto'}}
            >
              âœï¸ Bearbeiten
            </button>
            <button 
              className="btn btn-sm btn-danger"
              onClick={(e) => {
                e.stopPropagation();
                onDelete(graduierung.graduierung_id);
              }}
              disabled={loading}
              title="Graduierung lÃ¶schen"
              style={{position: 'relative', zIndex: 10000, pointerEvents: 'auto'}}
            >
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
        
        {/* Move-Buttons als separate Zeile */}
        <div className="graduierung-move-controls" style={{position: 'relative', zIndex: 9999}}>
          <button 
            className="move-btn move-up"
            onClick={(e) => {
              e.stopPropagation();
              onMoveUp && onMoveUp(graduierung);
            }}
            disabled={isFirst}
            title="Nach oben verschieben"
            style={{position: 'relative', zIndex: 10000, pointerEvents: 'auto'}}
          >
            â†‘
          </button>
          <span className="move-info">Position Ã¤ndern</span>
          <button 
            className="move-btn move-down"
            onClick={(e) => {
              e.stopPropagation();
              onMoveDown && onMoveDown(graduierung);
            }}
            disabled={isLast}
            title="Nach unten verschieben"
            style={{position: 'relative', zIndex: 10000, pointerEvents: 'auto'}}
          >
            â†“
          </button>
        </div>
        
        <div className="graduierung-details">
          <span>â±ï¸ {graduierung.trainingsstunden_min}h Training</span>
          <span>ğŸ“… {graduierung.mindestzeit_monate} Monate Mindestzeit</span>
          <span>ğŸ† Reihenfolge: {graduierung.reihenfolge}</span>
          {graduierung.dan_grad && <span>ğŸ¥‹ {graduierung.dan_grad}. DAN</span>}
          {graduierung.kategorie && <span>ğŸ“‚ {graduierung.kategorie}</span>}
        </div>
      </div>
    );
  };

  // ============================================================================
  // UNTER-KOMPONENTEN
  // ============================================================================

  /**
   * StilCard - Zeigt einen Stil in der Ãœbersicht an
   * @param {Object} stil - Stil-Objekt
   */
  const StilCard = ({ stil }) => (
    <motion.div
      className={`stil-card ${!stil.aktiv ? 'inactive' : ''}`}
      whileHover={{ scale: stil.aktiv ? 1.02 : 1.01 }}
      whileTap={{ scale: stil.aktiv ? 0.98 : 0.99 }}
      onClick={() => navigate(`/dashboard/stile/${stil.stil_id}`)}
      title={`${stil.name} - ${stil.beschreibung}${!stil.aktiv ? ' (Inaktiv)' : ''}`}
    >
      <div className="stil-card-content">
        <div className="stil-card-header">
          <h3>{stil.name}</h3>
          <div className="stil-badge">
            {stil.graduierungen?.length || 0} GÃ¼rtel
          </div>
        </div>
        
        <p className="stil-beschreibung">
          {stil.beschreibung || 'Keine Beschreibung verfÃ¼gbar'}
        </p>
        
        <div className="stil-card-stats">
          <div className="stil-stat">
            <span className="stil-stat-number">{stil.anzahl_mitglieder || 0}</span>
            <span className="stil-stat-label">SchÃ¼ler</span>
          </div>
          <div className="stil-stat">
            <span className="stil-stat-number">{stil.graduierungen?.length || 0}</span>
            <span className="stil-stat-label">GÃ¼rtel</span>
          </div>
          <div className="stil-stat">
            <div className="stat-status">
              <span className={`status-dot ${stil.aktiv ? 'active' : 'inactive'}`}></span>
              {stil.aktiv ? 'Aktiv' : 'Inaktiv'}
            </div>
          </div>
        </div>
      </div>
    </motion.div>
  );

  /**
   * GraduierungManager - Verwaltet Graduierungen mit @dnd-kit Drag & Drop
   */
  const GraduierungManager = () => {
    // Lokale States fÃ¼r GraduierungManager
    const [showAddForm, setShowAddForm] = useState(false);
    const [showCustomColorForm, setShowCustomColorForm] = useState(false);
    const [newGraduierung, setNewGraduierung] = useState({
      name: '',
      trainingsstunden_min: 40,
      mindestzeit_monate: 3,
      farbe_hex: '#FFFFFF',
      farbe_sekundaer: null,
      kategorie: null,
      dan_grad: null
    });

    /**
     * Handler fÃ¼r das HinzufÃ¼gen einer Standard-Graduierung
     */
    const handleAddGraduierung = async () => {
      if (!newGraduierung.name.trim()) {
        setError('Graduierung-Name ist erforderlich');
        return;
      }
      
      // Finde gewÃ¤hlten GÃ¼rtel fÃ¼r zusÃ¤tzliche Daten
      const selectedBelt = standardGuertel.find(g => g.name === newGraduierung.name);
      const graduierungData = {
        ...newGraduierung,
        kategorie: selectedBelt?.kategorie || newGraduierung.kategorie,
        dan_grad: selectedBelt?.dan || newGraduierung.dan_grad
      };

      await addGraduierung(graduierungData);
      
      // Reset form
      setNewGraduierung({
        name: '',
        trainingsstunden_min: 40,
        mindestzeit_monate: 3,
        farbe_hex: '#FFFFFF',
        farbe_sekundaer: null,
        kategorie: null,
        dan_grad: null
      });
      setShowAddForm(false);
    };

    /**
     * Handler fÃ¼r das Erstellen einer benutzerdefinierten Graduierung
     */
    const handleAddCustomGraduierung = async () => {
      if (!newGraduierung.name.trim()) {
        setError('Graduierung-Name ist erforderlich');
        return;
      }

      await addGraduierung(newGraduierung);
      
      // Reset form
      setNewGraduierung({
        name: '',
        trainingsstunden_min: 40,
        mindestzeit_monate: 3,
        farbe_hex: '#FFFFFF',
        farbe_sekundaer: null,
        kategorie: 'custom',
        dan_grad: null
      });
      setShowCustomColorForm(false);
    };

    // Sortierte Graduierungen fÃ¼r Darstellung und DnD
    const sortedGraduierungen = currentStil?.graduierungen
      ? [...currentStil.graduierungen].sort((a, b) => (a.reihenfolge || 0) - (b.reihenfolge || 0))
      : [];


    return (
      <div className="graduierung-manager">
        {/* Header mit Buttons */}
        <div className="section-header">
          <h3>Graduierungen verwalten</h3>
          <div className="header-buttons">
            <button 
              onClick={() => setShowAddForm(true)}
              className="btn btn-primary"
              disabled={loading}
              title="Standard-GÃ¼rtel hinzufÃ¼gen"
            >
              + Graduierung hinzufÃ¼gen
            </button>
            <button 
              onClick={() => setShowCustomColorForm(true)}
              className="btn btn-secondary"
              disabled={loading}
              title="Eigene Farbe erstellen"
            >
              Eigene Farbe
            </button>
          </div>
        </div>


        {/* Move-Info */}
        {sortedGraduierungen.length > 1 && (
          <div className="drag-drop-info">
            <span className="info-icon">â„¹ï¸</span>
            Verwenden Sie die <strong>â†‘â†“</strong> Buttons, um die Reihenfolge zu Ã¤ndern
          </div>
        )}

        {/* Graduierungen-Liste */}
        {sortedGraduierungen.length > 0 ? (
          <div className="graduierung-list">
            {sortedGraduierungen.map((graduierung) => (
              <GraduierungItem
                key={graduierung.graduierung_id}
                graduierung={graduierung}
                onEdit={handleEditGraduierung}
                onDelete={deleteGraduierung}
                onMoveUp={moveGraduierungUp}
                onMoveDown={moveGraduierungDown}
                loading={loading}
                isFirst={sortedGraduierungen[0]?.graduierung_id === graduierung.graduierung_id}
                isLast={sortedGraduierungen[sortedGraduierungen.length - 1]?.graduierung_id === graduierung.graduierung_id}
              />
            ))}
          </div>
        ) : (
          <div className="empty-state">
            <div className="empty-state-icon">ğŸ–ï¸</div>
            <h3>Noch keine Graduierungen angelegt</h3>
            <p>FÃ¼gen Sie die erste Graduierung fÃ¼r diesen Stil hinzu</p>
          </div>
        )}

        {/* Modal: Standard Graduierung hinzufÃ¼gen */}
        <AnimatePresence>
          {showAddForm && (
            <motion.div
              className="modal-overlay"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setShowAddForm(false)}
            >
              <motion.div
                className="modal-content belt-modal"
                initial={{ scale: 0.8, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0.8, opacity: 0 }}
                onClick={(e) => e.stopPropagation()}
              >
                <div className="modal-header">
                  <h3 className="modal-title">Neue Graduierung hinzufÃ¼gen</h3>
                  <button 
                    className="modal-close"
                    onClick={() => setShowAddForm(false)}
                    title="SchlieÃŸen"
                  >
                    Ã—
                  </button>
                </div>
                
                {/* GÃ¼rtel-Kategorien */}
                <div className="belt-categories">
                  {['grundstufe', 'mittelstufe', 'oberstufe', 'dan', 'meister'].map(kategorie => (
                    <div key={kategorie} className="belt-category">
                      <h4 className="category-title">
                        {kategorie === 'grundstufe' && 'ğŸŸ¡ Grundstufe'}
                        {kategorie === 'mittelstufe' && 'ğŸŸ¢ Mittelstufe'}
                        {kategorie === 'oberstufe' && 'ğŸŸ¤ Oberstufe'}
                        {kategorie === 'dan' && 'âš« Dan-Grade'}
                        {kategorie === 'meister' && 'ğŸ”´ Meister'}
                      </h4>
                      
                      <div className="belt-grid">
                        {standardGuertel
                          .filter(guertel => guertel.kategorie === kategorie)
                          .map(guertel => (
                            <div 
                              key={guertel.name}
                              className={`belt-option ${newGraduierung.name === guertel.name ? 'selected' : ''}`}
                              onClick={() => {
                                setNewGraduierung({
                                  ...newGraduierung,
                                  name: guertel.name,
                                  farbe_hex: guertel.primaer,
                                  farbe_sekundaer: guertel.sekundaer,
                                  kategorie: guertel.kategorie,
                                  dan_grad: guertel.dan || null
                                });
                              }}
                              title={guertel.name}
                            >
                              <BeltPreview 
                                primaer={guertel.primaer} 
                                sekundaer={guertel.sekundaer} 
                                size="small"
                              />
                              <span className="belt-name">{guertel.name}</span>
                            </div>
                          ))
                        }
                      </div>
                    </div>
                  ))}
                </div>

                {/* Vorschau des gewÃ¤hlten GÃ¼rtels */}
                {newGraduierung.name && (
                  <div className="belt-preview-section">
                    <h4>Vorschau:</h4>
                    <div className="selected-belt-preview">
                      <BeltPreview 
                        primaer={newGraduierung.farbe_hex} 
                        sekundaer={newGraduierung.farbe_sekundaer} 
                        size="large"
                      />
                      <div className="belt-info">
                        <strong>{newGraduierung.name}</strong>
                        <div className="color-codes">
                          <span>PrimÃ¤r: {newGraduierung.farbe_hex}</span>
                          {newGraduierung.farbe_sekundaer && (
                            <span>SekundÃ¤r: {newGraduierung.farbe_sekundaer}</span>
                          )}
                          {newGraduierung.dan_grad && (
                            <span>DAN-Grad: {newGraduierung.dan_grad}</span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Anforderungen */}
                <div className="form-row">
                  <div className="form-group">
                    <label>Trainingsstunden (Minimum):</label>
                    <input
                      type="number"
                      value={newGraduierung.trainingsstunden_min}
                      onChange={(e) => setNewGraduierung({
                        ...newGraduierung,
                        trainingsstunden_min: Math.max(0, parseInt(e.target.value) || 0)
                      })}
                      min="0"
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label>Mindestzeit (Monate):</label>
                    <input
                      type="number"
                      value={newGraduierung.mindestzeit_monate}
                      onChange={(e) => setNewGraduierung({
                        ...newGraduierung,
                        mindestzeit_monate: Math.max(0, parseInt(e.target.value) || 0)
                      })}
                      min="0"
                      className="form-input"
                    />
                  </div>
                </div>

                <div className="modal-actions">
                  <button 
                    onClick={() => setShowAddForm(false)}
                    className="btn btn-secondary"
                    disabled={loading}
                  >
                    Abbrechen
                  </button>
                  <button 
                    onClick={handleAddGraduierung}
                    className="btn btn-primary"
                    disabled={!newGraduierung.name || loading}
                  >
                    {loading ? 'Wird gespeichert...' : 'Graduierung hinzufÃ¼gen'}
                  </button>
                </div>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Modal: Eigene Farbe erstellen */}
        <AnimatePresence>
          {showCustomColorForm && (
            <motion.div
              className="modal-overlay"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setShowCustomColorForm(false)}
            >
              <motion.div
                className="modal-content"
                initial={{ scale: 0.8, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0.8, opacity: 0 }}
                onClick={(e) => e.stopPropagation()}
              >
                <div className="modal-header">
                  <h3 className="modal-title">Eigene GÃ¼rtel-Farbe erstellen</h3>
                  <button 
                    className="modal-close"
                    onClick={() => setShowCustomColorForm(false)}
                    title="SchlieÃŸen"
                  >
                    Ã—
                  </button>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Graduierung-Name:</label>
                  <input
                    type="text"
                    value={newGraduierung.name}
                    onChange={(e) => setNewGraduierung({
                      ...newGraduierung,
                      name: e.target.value
                    })}
                    placeholder="z.B. Lila-Silbergurt"
                    className="form-input"
                  />
                </div>

                <div className="color-selection">
                  <div className="form-group">
                    <label className="form-label">PrimÃ¤rfarbe (Grundfarbe):</label>
                    <div className="color-picker-group">
                      <input
                        type="color"
                        value={newGraduierung.farbe_hex}
                        onChange={(e) => setNewGraduierung({
                          ...newGraduierung,
                          farbe_hex: e.target.value
                        })}
                        className="color-picker"
                      />
                      <span className="color-preview" style={{ backgroundColor: newGraduierung.farbe_hex }}>
                        {newGraduierung.farbe_hex}
                      </span>
                    </div>
                  </div>

                  <div className="form-group">
                    <label className="form-label">
                      <input
                        type="checkbox"
                        checked={newGraduierung.farbe_sekundaer !== null}
                        onChange={(e) => setNewGraduierung({
                          ...newGraduierung,
                          farbe_sekundaer: e.target.checked ? '#FFFFFF' : null
                        })}
                      />
                      SekundÃ¤rfarbe hinzufÃ¼gen (Streifen)
                    </label>
                    
                    {newGraduierung.farbe_sekundaer && (
                      <div className="color-picker-group">
                        <input
                          type="color"
                          value={newGraduierung.farbe_sekundaer}
                          onChange={(e) => setNewGraduierung({
                            ...newGraduierung,
                            farbe_sekundaer: e.target.value
                          })}
                          className="color-picker"
                        />
                        <span className="color-preview" style={{ backgroundColor: newGraduierung.farbe_sekundaer }}>
                          {newGraduierung.farbe_sekundaer}
                        </span>
                      </div>
                    )}
                  </div>
                </div>

                {/* Live-Vorschau */}
                <div className="belt-preview-section">
                  <h4>Vorschau:</h4>
                  <BeltPreview 
                    primaer={newGraduierung.farbe_hex} 
                    sekundaer={newGraduierung.farbe_sekundaer} 
                    size="large"
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Trainingsstunden (Minimum):</label>
                    <input
                      type="number"
                      value={newGraduierung.trainingsstunden_min}
                      onChange={(e) => setNewGraduierung({
                        ...newGraduierung,
                        trainingsstunden_min: Math.max(0, parseInt(e.target.value) || 0)
                      })}
                      min="0"
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Mindestzeit (Monate):</label>
                    <input
                      type="number"
                      value={newGraduierung.mindestzeit_monate}
                      onChange={(e) => setNewGraduierung({
                        ...newGraduierung,
                        mindestzeit_monate: Math.max(0, parseInt(e.target.value) || 0)
                      })}
                      min="0"
                      className="form-input"
                    />
                  </div>
                </div>

                <div className="modal-actions">
                  <button 
                    onClick={() => setShowCustomColorForm(false)}
                    className="btn btn-secondary"
                    disabled={loading}
                  >
                    Abbrechen
                  </button>
                  <button 
                    onClick={handleAddCustomGraduierung}
                    className="btn btn-primary"
                    disabled={!newGraduierung.name || loading}
                  >
                    {loading ? 'Wird erstellt...' : 'Eigene Graduierung erstellen'}
                  </button>
                </div>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Modal: Graduierung bearbeiten */}
        <AnimatePresence>
          {showEditGraduierung && editingGraduierung && (
            <motion.div
              className="modal-overlay"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => {
                setShowEditGraduierung(false);
                setEditingGraduierung(null);
              }}
            >
              <motion.div
                className="modal-content"
                initial={{ scale: 0.8, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0.8, opacity: 0 }}
                onClick={(e) => e.stopPropagation()}
              >
                <div className="modal-header">
                  <h3 className="modal-title">Graduierung bearbeiten</h3>
                  <button 
                    className="modal-close"
                    onClick={() => {
                      setShowEditGraduierung(false);
                      setEditingGraduierung(null);
                    }}
                    title="SchlieÃŸen"
                  >
                    Ã—
                  </button>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Graduierung-Name:</label>
                  <input
                    type="text"
                    value={editingGraduierung.name}
                    onChange={(e) => setEditingGraduierung({
                      ...editingGraduierung,
                      name: e.target.value
                    })}
                    className="form-input"
                  />
                </div>

                <div className="color-selection">
                  <div className="form-group">
                    <label className="form-label">PrimÃ¤rfarbe:</label>
                    <div className="color-picker-group">
                      <input
                        type="color"
                        value={editingGraduierung.farbe_hex}
                        onChange={(e) => setEditingGraduierung({
                          ...editingGraduierung,
                          farbe_hex: e.target.value
                        })}
                        className="color-picker"
                      />
                      <span className="color-preview" style={{ backgroundColor: editingGraduierung.farbe_hex }}>
                        {editingGraduierung.farbe_hex}
                      </span>
                    </div>
                  </div>

                  <div className="form-group">
                    <label className="form-label">
                      <input
                        type="checkbox"
                        checked={editingGraduierung.farbe_sekundaer !== null}
                        onChange={(e) => setEditingGraduierung({
                          ...editingGraduierung,
                          farbe_sekundaer: e.target.checked ? '#FFFFFF' : null
                        })}
                      />
                      SekundÃ¤rfarbe (Streifen)
                    </label>
                    
                    {editingGraduierung.farbe_sekundaer && (
                      <div className="color-picker-group">
                        <input
                          type="color"
                          value={editingGraduierung.farbe_sekundaer}
                          onChange={(e) => setEditingGraduierung({
                            ...editingGraduierung,
                            farbe_sekundaer: e.target.value
                          })}
                          className="color-picker"
                        />
                        <span className="color-preview" style={{ backgroundColor: editingGraduierung.farbe_sekundaer }}>
                          {editingGraduierung.farbe_sekundaer}
                        </span>
                      </div>
                    )}
                  </div>
                </div>

                {/* Live-Vorschau */}
                <div className="belt-preview-section">
                  <h4>Vorschau:</h4>
                  <BeltPreview 
                    primaer={editingGraduierung.farbe_hex} 
                    sekundaer={editingGraduierung.farbe_sekundaer} 
                    size="large"
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Trainingsstunden:</label>
                    <input
                      type="number"
                      value={editingGraduierung.trainingsstunden_min}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        trainingsstunden_min: Math.max(0, parseInt(e.target.value) || 0)
                      })}
                      min="0"
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Mindestzeit (Monate):</label>
                    <input
                      type="number"
                      value={editingGraduierung.mindestzeit_monate}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        mindestzeit_monate: Math.max(0, parseInt(e.target.value) || 0)
                      })}
                      min="0"
                      className="form-input"
                    />
                  </div>
                </div>

                <div className="modal-actions">
                  <button 
                    onClick={() => {
                      setShowEditGraduierung(false);
                      setEditingGraduierung(null);
                    }}
                    className="btn btn-secondary"
                    disabled={loading}
                  >
                    Abbrechen
                  </button>
                  <button 
                    onClick={async () => {
                      await updateGraduierung(editingGraduierung);
                      setShowEditGraduierung(false);
                      setEditingGraduierung(null);
                    }}
                    className="btn btn-primary"
                    disabled={!editingGraduierung.name || loading}
                  >
                    {loading ? 'Wird gespeichert...' : 'Ã„nderungen speichern'}
                  </button>
                </div>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    );
  };

  /**
   * PruefungsinhaltManager - Verwaltet PrÃ¼fungsinhalte fÃ¼r Graduierungen
   */
  const PruefungsinhaltManager = () => {
    return (
      <div className="pruefungsinhalt-manager">
        <div className="section-header">
          <h3>PrÃ¼fungsinhalte definieren</h3>
          <p>Legen Sie fest, was fÃ¼r jede Graduierung gelernt werden muss</p>
        </div>
        
        {currentStil?.graduierungen?.length > 0 ? (
          currentStil.graduierungen
            .sort((a, b) => (a.reihenfolge || 0) - (b.reihenfolge || 0))
            .map(grad => (
              <div key={grad.graduierung_id} className="graduierung-pruefung">
                <div className="graduierung-header">
                  <BeltPreview 
                    primaer={grad.farbe_hex} 
                    sekundaer={grad.farbe_sekundaer} 
                    size="normal"
                  />
                  <h4>{grad.name}</h4>
                </div>
                
                <div className="pruefungsinhalt-categories">
                  <div className="category">
                    <h5>Grundtechniken</h5>
                    <ul>
                      <li>Grundstellungen</li>
                      <li>FuÃŸarbeit</li>
                      <li>Hand- und FuÃŸtechniken</li>
                    </ul>
                    <button className="btn btn-sm btn-primary">+ HinzufÃ¼gen</button>
                  </div>
                  
                  <div className="category">
                    <h5>Kata / Formen</h5>
                    <ul>
                      <li>Heian Shodan</li>
                      <li>Heian Nidan</li>
                    </ul>
                    <button className="btn btn-sm btn-primary">+ HinzufÃ¼gen</button>
                  </div>
                  
                  <div className="category">
                    <h5>Kumite / Sparring</h5>
                    <ul>
                      <li>Grundkumite</li>
                      <li>Situative Techniken</li>
                    </ul>
                    <button className="btn btn-sm btn-primary">+ HinzufÃ¼gen</button>
                  </div>
                  
                  <div className="category">
                    <h5>Theorie</h5>
                    <ul>
                      <li>Dojo-Kun (Verhaltensregeln)</li>
                      <li>Grundbegriffe</li>
                      <li>Geschichte</li>
                    </ul>
                    <button className="btn btn-sm btn-primary">+ HinzufÃ¼gen</button>
                  </div>
                </div>
              </div>
            ))
        ) : (
          <div className="empty-state">
            <div className="empty-state-icon">ğŸ“</div>
            <h3>Noch keine Graduierungen vorhanden</h3>
            <p>Legen Sie zuerst Graduierungen an, um PrÃ¼fungsinhalte zu definieren</p>
          </div>
        )}
      </div>
    );
  };

  // ============================================================================
  // LOADING STATE
  // ============================================================================
  
  // Zeige Loading-Screen beim ersten Laden
  if (loading && stile.length === 0) {
    return (
      <div className="stil-verwaltung-loading">
        <div className="loading-spinner-large"></div>
        <p>Lade Stil-Verwaltung...</p>
      </div>
    );
  }

  // ============================================================================
  // HAUPT-RENDER
  // ============================================================================
  
  return (
    <div className="stil-verwaltung">
      <div className="stil-verwaltung-container">
        
        {/* Header-Bereich */}
        <div className="stil-header">
          <div className="header-left">
            <h1>Stil-Verwaltung</h1>
            <p>Kampfkunst-Stile, Graduierungen und PrÃ¼fungsanforderungen verwalten</p>
          </div>
          <div className="header-actions">
            {!currentStil && (
              <button 
                onClick={() => setShowCreateForm(true)}
                className="add-stil-btn"
                disabled={loading}
                title="Neuen Kampfkunst-Stil anlegen"
              >
                + Neuen Stil anlegen
              </button>
            )}
            {currentStil && (
              <button 
                onClick={() => {
                  navigate('/dashboard/stile');
                  setCurrentStil(null);
                  setActiveTab('allgemein');
                }}
                className="back-btn"
                title="ZurÃ¼ck zur Ãœbersicht"
              >
                â† ZurÃ¼ck zur Ãœbersicht
              </button>
            )}
          </div>
        </div>

        {/* Nachrichten-Bereich */}
        <AnimatePresence>
          {success && (
            <motion.div 
              className="success-message"
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
            >
              {success}
            </motion.div>
          )}
          {error && (
            <motion.div 
              className="error-message"
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
            >
              {error}
              <button onClick={() => setError('')} className="message-close">Ã—</button>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Haupt-Content */}
        <div className="stil-content">
          {!currentStil ? (
            // ======== ÃœBERSICHTS-ANSICHT ========
            <div className="stil-overview">
              {/* Statistik-Karten */}
              <div className="stil-stats">
                <div className="stat-card">
                  <h3>{stile.filter(s => s.aktiv).length}</h3>
                  <p>Aktive Stile</p>
                </div>
                <div className="stat-card">
                  <h3>{stile.reduce((sum, s) => sum + (s.graduierungen?.length || 0), 0)}</h3>
                  <p>Graduierungen</p>
                </div>
                <div className="stat-card">
                  <h3>{stile.reduce((sum, s) => sum + (s.anzahl_mitglieder || 0), 0)}</h3>
                  <p>SchÃ¼ler gesamt</p>
                </div>
              </div>

              {/* Stil-Grid */}
              <div className="stil-grid">
                {stile.length > 0 ? (
                  // Sortiere Stile: aktive zuerst, dann inaktive
                  stile
                    .sort((a, b) => {
                      // Aktive Stile zuerst (aktiv: true = 0, aktiv: false = 1)
                      if (a.aktiv !== b.aktiv) {
                        return a.aktiv ? -1 : 1;
                      }
                      // Bei gleichem Status nach Name sortieren
                      return a.name.localeCompare(b.name);
                    })
                    .map(stil => (
                      <StilCard key={stil.stil_id} stil={stil} />
                    ))
                ) : (
                  <div className="empty-state">
                    <div className="empty-state-icon">ğŸ–ï¸</div>
                    <h3>Noch keine Stile angelegt</h3>
                    <p>Legen Sie Ihren ersten Kampfkunst-Stil an, um zu beginnen</p>
                    <button 
                      onClick={() => setShowCreateForm(true)}
                      className="btn btn-primary"
                      disabled={loading}
                    >
                      + Ersten Stil anlegen
                    </button>
                  </div>
                )}
              </div>
            </div>
          ) : (
            // ======== DETAIL-ANSICHT ========
            <div className="stil-detail">
              {/* Detail-Header */}
              <div className="stil-detail-header">
                <div>
                  <h2 className="stil-detail-title">{currentStil.name}</h2>
                  <p>{currentStil.beschreibung}</p>
                  <div className="stil-detail-stats">
                    <span>ğŸ‘¥ {currentStil.anzahl_mitglieder || 0} SchÃ¼ler</span>
                    <span>ğŸ–ï¸ {currentStil.graduierungen?.length || 0} Graduierungen</span>
                    <span className={`status ${currentStil.aktiv ? 'active' : 'inactive'}`}>
                      {currentStil.aktiv ? 'âœ… Aktiv' : 'âŒ Inaktiv'}
                    </span>
                  </div>
                </div>
              </div>

              {/* Tab-Navigation */}
              <div className="tab-navigation">
                {[
                  { id: 'allgemein', label: 'ğŸ“‹ Allgemein', title: 'Grundeinstellungen des Stils' },
                  { id: 'graduierungen', label: 'ğŸ–ï¸ Graduierungen', title: 'GÃ¼rtel und Graduierungen verwalten' },
                  { id: 'pruefungsinhalte', label: 'ğŸ“ PrÃ¼fungsinhalte', title: 'PrÃ¼fungsinhalte definieren' },
                  { id: 'statistiken', label: 'ğŸ“Š Statistiken', title: 'Auswertungen und Statistiken' }
                ].map(tab => (
                  <button
                    key={tab.id}
                    className={`tab-btn ${activeTab === tab.id ? 'active' : ''}`}
                    onClick={() => setActiveTab(tab.id)}
                    title={tab.title}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {/* Tab-Content */}
              <div className="tab-content">
                {activeTab === 'allgemein' && (
                  <motion.div 
                    className="allgemein-tab"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ duration: 0.3 }}
                  >
                    <h3>Grundeinstellungen</h3>
                    
                    <div className="form-group">
                      <label className="form-label">Stil-Name:</label>
                      <input 
                        type="text" 
                        value={currentStil.name || ''} 
                        onChange={(e) => setCurrentStil({...currentStil, name: e.target.value})}
                        className="form-input"
                        placeholder="Name des Kampfkunst-Stils"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">Beschreibung:</label>
                      <textarea 
                        value={currentStil.beschreibung || ''} 
                        onChange={(e) => setCurrentStil({...currentStil, beschreibung: e.target.value})}
                        rows="4"
                        className="form-textarea"
                        placeholder="Beschreibung des Kampfkunst-Stils..."
                      />
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">
                        <input 
                          type="checkbox" 
                          checked={currentStil.aktiv || false}
                          onChange={(e) => setCurrentStil({...currentStil, aktiv: e.target.checked})}
                        />
                        Stil ist aktiv
                      </label>
                      <small>Inaktive Stile werden nicht in der SchÃ¼lerverwaltung angezeigt</small>
                    </div>
                    
                    <div className="form-actions">
                      <button 
                        className="btn btn-primary"
                        onClick={() => updateStil({
                          name: currentStil.name,
                          beschreibung: currentStil.beschreibung,
                          aktiv: currentStil.aktiv
                        })}
                        disabled={loading || !currentStil.name?.trim()}
                      >
                        {loading ? 'Wird gespeichert...' : 'ğŸ’¾ Ã„nderungen speichern'}
                      </button>
                      
                      <button 
                        className="btn btn-danger"
                        onClick={() => deleteStil(currentStil.stil_id)}
                        disabled={loading}
                        title="Stil lÃ¶schen oder deaktivieren"
                      >
                        ğŸ—‘ï¸ Stil lÃ¶schen
                      </button>
                    </div>
                  </motion.div>
                )}

                {activeTab === 'graduierungen' && (
                  <motion.div 
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ duration: 0.3 }}
                  >
                    <GraduierungManager />
                  </motion.div>
                )}

                {activeTab === 'pruefungsinhalte' && (
                  <motion.div 
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ duration: 0.3 }}
                  >
                    <PruefungsinhaltManager />
                  </motion.div>
                )}
                
                {activeTab === 'statistiken' && (
                  <motion.div 
                    className="statistiken-tab"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ duration: 0.3 }}
                  >
                    <h3>ğŸ“Š Stil-Statistiken</h3>
                    <p>Hier werden erweiterte Statistiken zum Stil angezeigt</p>
                    
                    <div className="stats-grid">
                      <div className="stat-item">
                        <h4>SchÃ¼ler-Verteilung</h4>
                        <p>Verteilung der SchÃ¼ler auf die verschiedenen Graduierungen</p>
                      </div>
                      <div className="stat-item">
                        <h4>PrÃ¼fungs-Erfolgsrate</h4>
                        <p>Erfolgsquote bei GÃ¼rtelprÃ¼fungen</p>
                      </div>
                      <div className="stat-item">
                        <h4>Durchschnittliche Trainingszeit</h4>
                        <p>Wie lange dauert es im Schnitt bis zur nÃ¤chsten Graduierung</p>
                      </div>
                    </div>
                  </motion.div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Modal: Neuen Stil erstellen - Mehrstufig */}
        <AnimatePresence>
          {showCreateForm && (
            <motion.div
              className="modal-overlay"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => resetCreateModal()}
            >
              <motion.div
                className="modal-content create-stil-modal"
                initial={{ scale: 0.8, opacity: 0, y: 50 }}
                animate={{ scale: 1, opacity: 1, y: 0 }}
                exit={{ scale: 0.8, opacity: 0, y: 50 }}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header mit Fortschritt */}
                <div className="modal-header">
                  <div className="modal-title-section">
                    <h3 className="modal-title">Neuen Stil anlegen</h3>
                    <div className="progress-indicator">
                      <div className={`progress-step ${createStep >= 1 ? 'active' : ''}`}>1</div>
                      <div className={`progress-line ${createStep >= 2 ? 'active' : ''}`}></div>
                      <div className={`progress-step ${createStep >= 2 ? 'active' : ''}`}>2</div>
                      <div className={`progress-line ${createStep >= 3 ? 'active' : ''}`}></div>
                      <div className={`progress-step ${createStep >= 3 ? 'active' : ''}`}>3</div>
                    </div>
                  </div>
                  <button 
                    className="modal-close"
                    onClick={() => resetCreateModal()}
                    title="SchlieÃŸen"
                  >
                    Ã—
                  </button>
                </div>

                {/* Schritt 1: Grundinformationen */}
                {createStep === 1 && (
                  <motion.div
                    className="modal-step"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                  >
                    <div className="step-title">
                      <h4>ğŸ“ Grundinformationen</h4>
                      <p>Geben Sie die grundlegenden Informationen zum neuen Stil ein.</p>
                    </div>

                    <div className="form-group">
                      <label className="form-label">Stil-Name *</label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => handleFormChange('name', e.target.value)}
                        placeholder="z.B. Karate, Taekwon-Do, Kickboxen..."
                        className="form-input"
                        autoFocus
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">Kategorie</label>
                      <select
                        value={formData.kategorie}
                        onChange={(e) => handleFormChange('kategorie', e.target.value)}
                        className="form-select"
                      >
                        <option value="kampfkunst">ğŸ¥‹ Kampfkunst</option>
                        <option value="selbstverteidigung">ğŸ›¡ï¸ Selbstverteidigung</option>
                        <option value="fitness">ğŸ’ª Fitness & Kondition</option>
                        <option value="sport">ğŸ† Wettkampfsport</option>
                      </select>
                    </div>

                    <div className="form-group">
                      <label className="form-label">Beschreibung</label>
                      <textarea
                        value={formData.beschreibung}
                        onChange={(e) => handleFormChange('beschreibung', e.target.value)}
                        rows="3"
                        placeholder="Kurze Beschreibung des Stils, seiner Herkunft und Besonderheiten..."
                        className="form-textarea"
                      />
                    </div>
                  </motion.div>
                )}

                {/* Schritt 2: Trainingsdetails */}
                {createStep === 2 && (
                  <motion.div
                    className="modal-step"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                  >
                    <div className="step-title">
                      <h4>âš™ï¸ Trainingsdetails</h4>
                      <p>Definieren Sie die Trainingsparameter fÃ¼r diesen Stil.</p>
                    </div>

                    <div className="form-row">
                      <div className="form-group">
                        <label className="form-label">Schwierigkeitsgrad</label>
                        <select
                          value={formData.schwierigkeitsgrad}
                          onChange={(e) => handleFormChange('schwierigkeitsgrad', e.target.value)}
                          className="form-select"
                        >
                          <option value="anfaenger">ğŸŸ¢ AnfÃ¤nger</option>
                          <option value="mittel">ğŸŸ¡ Mittel</option>
                          <option value="fortgeschritten">ğŸ”´ Fortgeschritten</option>
                        </select>
                      </div>

                      <div className="form-group">
                        <label className="form-label">Altersgruppe</label>
                        <select
                          value={formData.altergruppe}
                          onChange={(e) => handleFormChange('altergruppe', e.target.value)}
                          className="form-select"
                        >
                          <option value="kinder">ğŸ‘¶ Kinder (4-12)</option>
                          <option value="jugendliche">ğŸ§’ Jugendliche (13-17)</option>
                          <option value="erwachsene">ğŸ‘¨ Erwachsene (18+)</option>
                          <option value="alle">ğŸ‘¥ Alle Altersgruppen</option>
                        </select>
                      </div>
                    </div>

                    <div className="form-group">
                      <label className="form-label">Trainingsdauer (Minuten)</label>
                      <input
                        type="number"
                        value={formData.trainingsdauer}
                        onChange={(e) => handleFormChange('trainingsdauer', parseInt(e.target.value))}
                        min="30"
                        max="180"
                        step="15"
                        className="form-input"
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">BenÃ¶tigte AusrÃ¼stung</label>
                      <div className="equipment-tags">
                        {['Gi/Anzug', 'GÃ¼rtel', 'Handschuhe', 'Schienbeinschoner', 'Mundschutz', 'Boxhandschuhe'].map(equipment => (
                          <label key={equipment} className="equipment-tag">
                            <input
                              type="checkbox"
                              checked={formData.ausruestung.includes(equipment)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  handleFormChange('ausruestung', [...formData.ausruestung, equipment]);
                                } else {
                                  handleFormChange('ausruestung', formData.ausruestung.filter(item => item !== equipment));
                                }
                              }}
                            />
                            <span>{equipment}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  </motion.div>
                )}

                {/* Schritt 3: BestÃ¤tigung */}
                {createStep === 3 && (
                  <motion.div
                    className="modal-step"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                  >
                    <div className="step-title">
                      <h4>âœ… BestÃ¤tigung</h4>
                      <p>ÃœberprÃ¼fen Sie Ihre Eingaben vor dem Erstellen.</p>
                    </div>

                    <div className="confirmation-summary">
                      <div className="summary-item">
                        <strong>Name:</strong> {formData.name}
                      </div>
                      <div className="summary-item">
                        <strong>Kategorie:</strong> {formData.kategorie}
                      </div>
                      <div className="summary-item">
                        <strong>Schwierigkeitsgrad:</strong> {formData.schwierigkeitsgrad}
                      </div>
                      <div className="summary-item">
                        <strong>Altersgruppe:</strong> {formData.altergruppe}
                      </div>
                      <div className="summary-item">
                        <strong>Trainingsdauer:</strong> {formData.trainingsdauer} Minuten
                      </div>
                      {formData.beschreibung && (
                        <div className="summary-item">
                          <strong>Beschreibung:</strong> {formData.beschreibung}
                        </div>
                      )}
                      {formData.ausruestung.length > 0 && (
                        <div className="summary-item">
                          <strong>AusrÃ¼stung:</strong> {formData.ausruestung.join(', ')}
                        </div>
                      )}
                    </div>

                    <div className="form-group">
                      <label className="form-label">
                        <input
                          type="checkbox"
                          checked={formData.aktiv}
                          onChange={(e) => handleFormChange('aktiv', e.target.checked)}
                        />
                        Stil ist sofort aktiv und verfÃ¼gbar
                      </label>
                    </div>
                  </motion.div>
                )}

                {/* Navigation */}
                <div className="modal-actions">
                  <button 
                    onClick={() => resetCreateModal()}
                    className="btn btn-secondary"
                    disabled={loading}
                  >
                    Abbrechen
                  </button>
                  
                  <div className="step-navigation">
                    {createStep > 1 && (
                      <button 
                        onClick={() => setCreateStep(createStep - 1)}
                        className="btn btn-outline"
                        disabled={loading}
                      >
                        â† ZurÃ¼ck
                      </button>
                    )}
                    
                    {createStep < 3 ? (
                      <button 
                        onClick={() => setCreateStep(createStep + 1)}
                        className="btn btn-primary"
                        disabled={!formData.name.trim() || loading}
                      >
                        Weiter â†’
                      </button>
                    ) : (
                      <button 
                        onClick={createStil}
                        className="btn btn-success"
                        disabled={!formData.name.trim() || loading}
                      >
                        {loading ? 'Wird erstellt...' : 'âœ… Stil anlegen'}
                      </button>
                    )}
                  </div>
                </div>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Modal fÃ¼r Graduierung bearbeiten */}
        <AnimatePresence>
          {showEditGraduierung && editingGraduierung && (
            <motion.div 
              className="modal-overlay"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={handleCloseEditModal}
            >
              <motion.div 
                className="modal-content"
                initial={{ scale: 0.95, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0.95, opacity: 0 }}
                onClick={(e) => e.stopPropagation()}
              >
                <div className="modal-header">
                  <h3 className="modal-title">Graduierung bearbeiten</h3>
                  <button 
                    className="modal-close"
                    onClick={handleCloseEditModal}
                    title="SchlieÃŸen"
                  >
                    Ã—
                  </button>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Name:</label>
                  <input
                    type="text"
                    value={editingGraduierung.name}
                    onChange={(e) => setEditingGraduierung({
                      ...editingGraduierung,
                      name: e.target.value
                    })}
                    placeholder="Graduierungsname"
                    className="form-input"
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Reihenfolge:</label>
                    <input
                      type="number"
                      min="1"
                      value={editingGraduierung.reihenfolge || ''}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        reihenfolge: parseInt(e.target.value) || 1
                      })}
                      placeholder="Reihenfolge (z.B. 1, 2, 3...)"
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Trainingsstunden (min.):</label>
                    <input
                      type="number"
                      min="0"
                      value={editingGraduierung.trainingsstunden_min || ''}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        trainingsstunden_min: parseInt(e.target.value) || 0
                      })}
                      placeholder="Mindest-Trainingsstunden"
                      className="form-input"
                    />
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Mindestzeit (Monate):</label>
                    <input
                      type="number"
                      min="0"
                      value={editingGraduierung.mindestzeit_monate || ''}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        mindestzeit_monate: parseInt(e.target.value) || 0
                      })}
                      placeholder="Mindestzeit in Monaten"
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">PrimÃ¤rfarbe:</label>
                    <input
                      type="color"
                      value={editingGraduierung.farbe_hex || '#FFFFFF'}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        farbe_hex: e.target.value
                      })}
                      className="color-picker"
                    />
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">SekundÃ¤rfarbe (optional):</label>
                    <input
                      type="color"
                      value={editingGraduierung.farbe_sekundaer || ''}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        farbe_sekundaer: e.target.value
                      })}
                      className="color-picker"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Kategorie (optional):</label>
                    <select
                      value={editingGraduierung.kategorie || ''}
                      onChange={(e) => setEditingGraduierung({
                        ...editingGraduierung,
                        kategorie: e.target.value || null
                      })}
                      className="form-select"
                    >
                      <option value="">Keine Kategorie</option>
                      <option value="grundstufe">Grundstufe</option>
                      <option value="mittelstufe">Mittelstufe</option>
                      <option value="oberstufe">Oberstufe</option>
                      <option value="meister">Meister</option>
                    </select>
                  </div>
                </div>

                {/* Belt-Vorschau */}
                <div className="belt-preview-section">
                  <h4>GÃ¼rtel-Vorschau:</h4>
                  <div className="selected-belt-preview">
                    <BeltPreview 
                      primaer={editingGraduierung.farbe_hex || '#FFFFFF'} 
                      sekundaer={editingGraduierung.farbe_sekundaer || ''} 
                      size="large"
                    />
                    <div className="belt-info">
                      <strong>{editingGraduierung.name || 'Unbenannte Graduierung'}</strong>
                      <div className="color-codes">
                        <span>PrimÃ¤r: {editingGraduierung.farbe_hex || '#FFFFFF'}</span>
                        {editingGraduierung.farbe_sekundaer && (
                          <span>SekundÃ¤r: {editingGraduierung.farbe_sekundaer}</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                <div className="modal-actions">
                  <button 
                    onClick={handleCloseEditModal}
                    className="btn btn-secondary"
                    disabled={loading}
                  >
                    Abbrechen
                  </button>
                  <button 
                    onClick={saveGraduierungEdit}
                    className="btn btn-primary"
                    disabled={!editingGraduierung.name?.trim() || loading}
                  >
                    {loading ? 'Wird gespeichert...' : 'âœ… Speichern'}
                  </button>
                </div>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
        
      </div>
    </div>
  );
};

export default StilVerwaltung;

/*
================================================================================
KOMPONENTEN-DOKUMENTATION v2.2 - MIT @DND-KIT DRAG & DROP
================================================================================

NEUE FEATURES v2.2:
âœ… @dnd-kit Drag & Drop Implementation (React 18 kompatibel)
âœ… SortableContext mit verticalListSortingStrategy
âœ… DragOverlay fÃ¼r smooth Drag-Feedback
âœ… Touch-optimierte Sensors fÃ¼r Mobile
âœ… Optimistic Updates mit Rollback bei Fehlern
âœ… Visuelles Feedback mit CSS-Klassen (is-dragging, is-dragging-overlay)
âœ… Drag-Handle mit â‹®â‹® Icon fÃ¼r bessere UX

DEPENDENCIES:
- npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities

API-ENDPUNKTE:
- PUT /api/stile/:stilId/graduierungen/reorder - Graduierungen neu ordnen

@DND-KIT KOMPONENTEN:
- DndContext - Haupt-Drag-Context mit Sensors
- SortableContext - Container fÃ¼r sortierbare Items
- useSortable - Hook fÃ¼r einzelne sortierbare Elemente
- DragOverlay - Visuelles Overlay wÃ¤hrend des Dragging

VERWENDETE HOOKS:
- useState: Drag-States (activeId, draggedGraduierung)
- useEffect: Lifecycle-Hooks  
- useNavigate: React Router Navigation
- useParams: URL-Parameter
- useSensor: @dnd-kit Touch/Pointer/Keyboard Sensoren

CSS-KLASSEN:
- .is-dragging - Element wÃ¤hrend des Dragging
- .is-dragging-overlay - Drag-Overlay Element
- .is-drag-over - Drop-Zone wÃ¤hrend Hover
- .drag-handle - Zieh-Griff
- .drag-handle-icon - â‹®â‹® Icon
- .drag-drop-info - Info-Box fÃ¼r Benutzer

BACKEND-ANFORDERUNGEN:
PUT /api/stile/:stilId/graduierungen/reorder
Body: { graduierungen: [{ graduierung_id, reihenfolge }] }

VERBESSERUNGEN GEGENÃœBER REACT-BEAUTIFUL-DND:
- Bessere Performance und StabilitÃ¤t
- React 18+ Concurrent Features KompatibilitÃ¤t
- Verbesserte Touch-UnterstÃ¼tzung
- Flexible Collision Detection Algorithmen
- Bessere Accessibility-UnterstÃ¼tzung
- Moderne TypeScript Integration
- Aktive Entwicklung und Community
================================================================================
*/